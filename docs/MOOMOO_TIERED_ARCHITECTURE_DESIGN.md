# Moomoo分层架构设计方案

## 📋 设计概述

**设计目标**: 在Moomoo量化平台实现安全的三层功能分级，最大化商业价值和用户体验

**核心策略**: 授权码验证 + 轻度代码混淆 + 功能分层 + 升级引导

**技术限制**: 适配Moomoo量化环境，无HTTP请求，纯本地验证

---

## 🎯 三层架构设计

### 🆓 免费版 (Tier 1) - 开源吸引流量
**定位**: 体验产品价值，建立用户信任，引导付费升级

**核心功能**:
- ✅ 固定周期定投 (每周10080分钟)
- ✅ 基础参数配置 (qty: 10-100股，必须10的倍数)
- ✅ 回撤监控显示 (显示但不触发加仓)
- ✅ 预设模板 (保守/平衡/积极)
- ✅ 基础投资统计
- ✅ 风险提醒功能

**商业保护**:
- 参数强制限制，无法修改获得高级功能
- 移除所有付费功能代码
- 在关键时刻显示升级价值提示

**升级引导策略**:
```python
# 回撤触发时显示付费版价值
if drawdown >= 10.0:
    print("💡 付费版用户此时会触发智能加仓1.5倍，平滑成本")
    print("📞 联系微信: [你的微信] 获取授权码(¥35/月)")
```

### 💎 Moomoo付费版 (Tier 2) - ¥35/月核心价值
**定位**: 解决核心痛点，提供明显价值提升，覆盖不愿用App的用户群体

**核心功能**:
- ✅ 灵活投资周期 (每日1440分钟 + 每周选项)
- ✅ 2层智能加仓系统 (10%回撤→1.5倍, 20%回撤→2倍)
- ✅ 自定义投资数量 (1-200股，取消倍数限制)
- ✅ 自定义初始资金配置
- ✅ 付费版专属日志和统计
- ✅ 极端回撤保护 (50%回撤时仅定投模式)

**授权机制**:
```python
# 授权码格式: PREM + 年月 + 校验位
# 示例: PREM202408XX (XX为月份*3的校验位)
self.license_code = show_variable("", GlobalType.STRING)
```

**代码保护**:
- 轻度混淆关键参数 (简单base64 + 字符串反转)
- 授权码本地验证，技术用户可破解但成本较高
- 付费功能代码相对清晰，便于维护

### 👑 App完整版 (Tier 3) - ¥500/年终极体验
**定位**: Moomoo版本仅作引导，核心功能在独立App实现

**Moomoo版本功能**:
- ✅ 显示App功能介绍和下载链接
- ✅ 基础VIP功能展示 (3-4层加仓预览)
- ✅ 引导用户下载完整App
- ❌ 不包含完整VIP功能代码

**App独有功能**:
- 8层完整回撤系统 (2%/5%/10%/15%/20%/30%/40%/50%)
- 多标的组合投资
- 成本定投算法 (波动率自适应)
- 实时策略调整和优化
- 专业投资分析报告

---

## 🔐 技术实现方案

### 1. 授权码验证机制
```python
def _validate_license(self, code):
    """本地授权码验证"""
    if code == "":
        return 1  # 免费版
    
    # 简单规律验证: PREM + YYYY + MM + 校验位
    if len(code) == 11 and code.startswith("PREM2024"):
        month = code[8:10]
        check = code[10:12] 
        expected = str(int(month) * 3).zfill(2)
        if check == expected:
            return 2  # 付费版
    
    # VIP码验证
    if code.startswith("VIP2024"):
        return 3  # VIP引导版
        
    return 1  # 默认免费版
```

### 2. 轻度代码混淆
```python
def _get_premium_config(self):
    """获取付费版配置参数"""
    # 简单混淆: base64 + 字符串反转
    encoded = "WzE1LjAsIDIwLjBdLCBbMS41LCAyLjBd"  # [15.0, 20.0], [1.5, 2.0]
    import base64
    decoded = base64.b64decode(encoded).decode()[::-1]
    return eval(decoded)  # 返回回撤阈值和倍数
```

### 3. 功能分层路由
```python
def handle_data(self):
    """主交易逻辑 - 分层路由"""
    if self.version_tier == 1:
        return self.free_version_logic()
    elif self.version_tier == 2:  
        return self.premium_version_logic()
    elif self.version_tier == 3:
        return self.vip_guide_logic()
    else:
        return self.free_version_logic()
```

---

## 📊 商业价值分配

### 功能价值分布
- **80%价值** → 免费版: 让用户真实体验智能定投的便利性
- **15%价值** → 付费版: 解决核心痛点(每日定投+智能加仓)
- **5%价值** → App引导: 最高级功能作为终极目标

### 用户转化路径
```
流量获取 → 免费版体验 → 付费版核心价值 → App完整体验
   ↓           ↓            ↓            ↓
开源/文章   建立信任     解决痛点      忠诚用户
```

### 收入结构预期
```
免费用户: 1000人 (开源引流)
付费用户: 80人 × ¥35/月 × 12月 = ¥33,600/年  
App用户: 15人 × ¥500/年 = ¥7,500/年
总预期: ¥41,100/年
```

---

## 🚀 实施计划

### Phase 1: 免费版公开化 (当前对话)
- [ ] 基于现有稳定版创建纯净免费版
- [ ] 移除所有付费功能代码和参数
- [ ] 添加升级引导和价值展示
- [ ] 完善参数限制保护机制

### Phase 2: 付费版Moomoo策略 (当前对话)
- [ ] 实现授权码验证机制
- [ ] 集成2层智能加仓功能 (轻度混淆)
- [ ] 添加付费版专属功能
- [ ] 测试验证功能边界

### Phase 3: 文件组织和保护 (当前对话)
- [ ] 重命名和隔离混合开发版
- [ ] 更新.gitignore保护机制
- [ ] 创建分发用的干净文件结构

### Phase 4: 后续开发 (未来对话)
- [ ] 独立App架构设计
- [ ] 服务器端高级功能实现
- [ ] 用户管理和授权系统
- [ ] 性能监控和优化

---

## ⚠️ 风险控制

### 技术风险
- **授权码泄露**: 定期更换授权码生成规律
- **代码破解**: 轻度混淆足够阻挡90%用户，技术用户破解成本相对较高
- **功能绕过**: 通过参数强制限制，移除关键代码防止绕过

### 商业风险  
- **价值感知**: 确保每层都有明显价值区分
- **用户流失**: 升级引导不能太频繁，避免骚扰用户
- **竞争风险**: 快速迭代，保持技术和服务优势

### 合规风险
- **免责声明**: 所有版本都包含投资风险提示
- **服务边界**: 仅提供工具和教育，不承诺收益
- **用户协议**: 明确使用条款和责任边界

---

## 📝 文件结构规划

```
strategies/
├── dca_free_public.quant          # 🆓 免费版 - 公开分发
├── dca_premium_moomoo.quant        # 💎 付费版 - 私有分发  
├── dca_vip_guide.quant             # 👑 VIP引导版 - 特殊分发
└── [开发文件]                      # 🔒 加入.gitignore

docs/
├── MOOMOO_TIERED_ARCHITECTURE_DESIGN.md    # 本设计文档
├── LICENSE_CODE_MANUAL.md                  # 授权码生成和分发手册
└── USER_UPGRADE_GUIDE.md                   # 用户升级指导文档
```

---

**设计版本**: v1.0  
**创建日期**: 2025-08-29  
**状态**: 待实施  
**负责人**: wuxia  

**设计原则**: 开源吸引流量，付费提供价值，技术保护商业
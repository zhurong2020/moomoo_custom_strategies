# 基于 Moomoo 客户端的定投与回撤加仓量化策略

---

## 更新日志

### v1.1.0  (2025-06-12)
- 【修复】回测模式下，加仓（回撤分层加仓）和定投的模拟下单与成交日志完全一致，均输出完整的“订单状态/成交状态/全部成交”流程，便于回测与实盘对齐分析。
- 【优化】加仓和定投均调用 place_market 进行模拟下单，日志格式与实盘完全一致。
- 【说明】本版本为长期维护主线，建议所有用户升级。

**English summary:**
> v1.1.0: In backtest mode, simulated order logs for both DCA and layered add-position are now fully unified, including detailed order status and fill logs. This ensures log consistency for robust backtest analysis and real/live trading comparison.

---

## 背景
本策略基于 Moomoo 客户端开发，旨在通过固定周期的定投方式实现长期资产积累，并结合市场波动特性动态调整回撤加仓策略，以提升收益。

Moomoo 客户端提供了丰富的量化 API，可以实现自动化交易功能。通过此策略，用户可以结合预设的定投规则与回撤触发条件进行投资。

---

## 策略需求

### 核心功能
1. **固定周期定投**：
   - 用户可以设置固定的定投周期（如每日定投、每周定投等）。
   - 每次定投的数量由用户自定义（如1股）。

2. **动态回撤加仓**：
   - 当市场价格出现用户定义的回撤比例时，触发加仓逻辑。
   - 加仓数量动态调整，分层加仓倍数为固定序列（1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5）。
   - 一旦确定某一层级的加仓数量，例如2股，只要价格低于触发该数量时的价格，即使未进入下一个回撤层级，策略将持续以该数量定投。

3. **账户余额检查**：
   - 在任何定投或加仓动作前，检查账户余额，确保资金充足。
   - 在回测模式下跳过账户余额检查，以提高回测效率。

4. **自定义参数设置**：
   - 定投周期（单位：分钟）。
   - 每次定投数量。
   - 回撤加仓的基础触发阈值。
   - 是否开启回测模式。

5. **标的灵活适配**：
   - 策略应用于已选定的优质标的。
   - 不同标的价格波动特性差异较大，可灵活调整参数以适应标的特性。

6. **高效运行与回测支持**：
   - 尽量减少每次交易的计算负担，优化计算逻辑以提升回测效率。
   - 提供回测模式参数，便于快速检验策略逻辑。

---

### 参数说明
以下是策略支持的可配置参数：
| 参数名称                | 类型     | 默认值 | 选项/范围             | 说明                                                         |
|-------------------------|----------|--------|-----------------------|--------------------------------------------------------------|
| `qty`                   | 整数     | `10`   | 10,20,...,200         | 每次定投数量（单位：股，仅允许10的倍数）                      |
| `interval_min`          | 整数     | `1440` | 60,1440,10080         | 定投周期（分钟，支持1小时/1日/1周）                           |
| `drawdown_pct`          | 浮点数   | `5`    | 任意                  | 回撤触发的基础阈值（单位：%）                                 |
| `frac_shares`           | 布尔值   | `False`| True/False            | 是否支持碎股交易                                             |
| `backtest`              | 布尔值   | `True` | True/False            | 是否启用回测模式                                             |
| `mutual_exclusive`      | 布尔值   | `True` | True/False            | 互斥开仓（每周期仅一次，优先加仓）                            |
| `log_level`             | 整数     | `0`    | 0,1                   | 日志等级（0:简洁 1:调试全量）                                |
| `extreme_drawdown_pct`  | 浮点数   | `80`   | 任意                  | 极端回撤阈值（%），超过后暂停回撤加仓，仅定投                 |
| `basic_invest_only`     | 布尔值   | `False`| True/False            | 仅定投模式（True时只做基础定投，回撤加仓和风控全部失效）      |

> 注：2024/06/11起，参数choices已在代码层规范（如qty/interval_min/log_level等），但Moomoo前端当前版本暂不支持下拉选择，仅做输入提示与约束，后续如平台支持会自动生效。

---

## 策略分级模式

本策略支持三种分级功能模式，用户可通过参数选择适合自己的投资风格：

1. **基础定投模式**（`basic_invest_only=True`）
   - 仅按照设定周期和数量定投，不考虑市场回撤和加仓。
   - 适合追求极简自动定投、只做长期定投的用户。
2. **定投+回撤加仓模式**（`basic_invest_only=False`，`extreme_drawdown_pct`未触发）
   - 正常定投基础上，遇到价格回撤达到设定阈值时自动分层加仓。
   - 适合希望在下跌时逐步摊低成本的进阶用户。
3. **定投+回撤加仓+极端回撤风控模式**（`basic_invest_only=False`，且回撤超过`extreme_drawdown_pct`）
   - 当市场极端下跌时，暂停回撤加仓，仅保留基础定投，防止风险失控。
   - 适合对极端行情有额外风险控制需求的用户。

**切换方法**：
- 只需在策略参数界面勾选/取消“仅定投模式”或调整极端回撤阈值即可。
- 其它参数如定投数量、周期、回撤阈值可灵活调整。

> 建议新手用户优先体验基础定投模式，熟悉后可逐步启用回撤加仓与风控功能，实现从简单到高级的策略升级。

---

## 策略实现逻辑

### 1. 初始化
- 设置交易标的（`symbol`）。
- 初始化全局变量，包括定投周期、回撤阈值等。
- 初始化跟踪变量：历史最高价、当前回撤层级、上次调整的定投数量等。

### 2. 固定周期定投
- 在用户设定的时间间隔（如每日）内，执行固定数量的定投操作。

### 3. 动态回撤加仓
- 计算当前价格相对于历史最高价格的回撤幅度。
- 分层加仓逻辑：
   * 当回撤幅度达到新的5%层级时，计算并执行加仓操作，更新上次调整的定投数量。
   * 一旦确定某一层级的加仓数量，策略在后续交易日若未触发新的层级且价格低于此前水平，将持续使用该数量进行定投。
- 定投逻辑始终执行：在每次定投时根据当前的定投数量下单。

### 4. 账户余额检查
- 每次下单前，检查账户余额是否足够支付当前交易。
- 在回测模式下跳过账户余额检查等实际交易操作，提高运行效率。

### 5. 标的灵活适配
- 通过调整参数（如`drawdown_base`和`invest_interval`）适应不同标的的价格波动特性。

---

## 示例代码逻辑

以下是基于上述需求的代码逻辑：

```python
class Strategy(StrategyBase):
    """定投与回撤加仓策略优化版本"""

    def initialize(self):
        # 初始化策略设置、全局变量等
        ...

    def handle_data(self):
        # 获取市场数据和时间
        # 计算回撤
        # 若回撤低于阈值，重置层级但保留上次调整数量
        # 确定当次定投数量
        # 动态回撤加仓逻辑：
        #   - 若满足新层级，调整购买量并记录
        #   - 否则使用上次调整的数量
        # 执行定投操作
        ...

```

## 使用指南

### 参数设置：

* 在策略界面中设置定投参数，例如定投周期、定投数量等。
* 示例：每日定投1股，回撤达到5%时触发加仓。

### 部署与运行：

* 在 Moomoo 客户端中部署策略。
* 开启实时数据监控，策略将根据设定规则自动交易。

### 优化与测试：

* 启用回测模式，验证策略在不同市场环境下的表现。
* 根据回测结果调整参数，如回撤阈值和定投周期。

## 注意事项

* 本策略设计初衷是为长期持有优质标的服务，结合固定周期定投与回撤分层加仓机制，适合于长期资产积累。
由于策略持续使用上次调整的购买量，在价格长时间徘徊于某一水平且未触发新层级时，可能会在高位区间内持续大量买入，从而迅速消耗资金。这一特点在市场震荡或大幅反弹未超过历史高点时尤为明显。
标的选择建议：

* 优选长期优质标的：建议选择财务状况稳健、具有长期增长潜力的优质标的进行定投和回撤加仓。此类标的通常波动相对较小，适合作为长期投资组合的核心资产。
不建议选用高波动或杠杆标的：对于波动过大或具有杠杆特性的资产（如杠杆 ETF 或波动性极高的股票），本策略可能不适用，因为这些标的的高波动性或内在损耗可能导致频繁的加仓和更高的资金风险。

* 波动性利用建议：如果投资者希望利用标的的波动性进行高抛低吸操作，可以考虑使用其他策略。例如，基于网格交易的策略能更好地在一定波动范围内捕捉价格波动机会，实现高抛低吸的效果，而非简单的定投和回撤加仓。

* 用户需确保账户内资金充足，以支持定投和加仓操作。
* 回测模式仅用于验证逻辑，实际交易需谨慎操作。

## 总结
本策略适用于长期定投优质资产，通过回撤分层加仓降低成本，但在应对高波动性或杠杆标的时可能存在资金快速消耗的风险。投资者在选取标的时应倾向于长期优质资产，并根据自身需求选择合适的交易策略。
class Strategy(StrategyBase):
    """DCAæ™ºèƒ½å®šæŠ•ç­–ç•¥ - v2.2.5-Premium-Moomoo
    
    æ”¯æŒå…è´¹ç‰ˆå’Œä»˜è´¹ç‰ˆçš„Moomooåˆ†å±‚ç­–ç•¥
    - æˆæƒç éªŒè¯ç³»ç»Ÿ (æœ¬åœ°éªŒè¯)
    - å…è´¹ç‰ˆ: æ¯å‘¨å®šæŠ• + åŸºç¡€åŠŸèƒ½
    - ä»˜è´¹ç‰ˆ(Â¥35/æœˆ): æ¯æ—¥å®šæŠ• + 2å±‚æ™ºèƒ½åŠ ä»“
    - VIPç‰ˆå¼•å¯¼: å¼•å¯¼ä¸‹è½½å®Œæ•´App
    
    [v2.2.5 æ ¸å¿ƒåŠŸèƒ½]
    âœ… æˆæƒç åˆ†å±‚éªŒè¯ (PREM/VIPæ ¼å¼)
    âœ… è½»åº¦ä»£ç æ··æ·†ä¿æŠ¤ä»˜è´¹åŠŸèƒ½
    âœ… 2å±‚æ™ºèƒ½åŠ ä»“ç³»ç»Ÿ (10%/20%â†’1.5x/2x)
    âœ… çµæ´»æŠ•èµ„å‘¨æœŸé…ç½®
    âœ… å‡çº§å¼•å¯¼å’Œä»·å€¼å±•ç¤º
    
    ğŸ“ æˆæƒç è·å–:
    - ä»˜è´¹ç‰ˆ: è”ç³»å¾®ä¿¡ [ä½ çš„å¾®ä¿¡å·] è·å–PREMç (Â¥35/æœˆ)
    - VIPç‰ˆ: è”ç³»è·å–VIPç ï¼Œä¸‹è½½å®Œæ•´App(Â¥500/å¹´)
    """

    def initialize(self):
        """åˆå§‹åŒ–ç­–ç•¥"""
        try:
            self._version = "v2.2.5-Premium-Moomoo"
            self._tier = "åˆ†å±‚ç­–ç•¥ç‰ˆ"
            self._description = (
                "ğŸ¯ DCAæ™ºèƒ½å®šæŠ•åˆ†å±‚ç­–ç•¥\n"
                "ğŸ†“ å…è´¹ç‰ˆ: æ¯å‘¨å®šæŠ•+åŸºç¡€åŠŸèƒ½\n"
                "ğŸ’ ä»˜è´¹ç‰ˆ: æ¯æ—¥å®šæŠ•+2å±‚æ™ºèƒ½åŠ ä»“\n"
                "ğŸ‘‘ VIPç‰ˆ: å®Œæ•´AppåŠŸèƒ½å¼•å¯¼\n"
                "ğŸ”‘ é€šè¿‡æˆæƒç è§£é”é«˜çº§åŠŸèƒ½"
            )
            
            print(f"ğŸš€ å¼€å§‹åˆå§‹åŒ– {self._version}")
            
            # é¦–å…ˆè®¾ç½®æ ¸å¿ƒçŠ¶æ€å˜é‡
            self.current_drawdown_layer = -1  # -1è¡¨ç¤ºè¿˜æ²¡æœ‰è§¦å‘ä»»ä½•å±‚çº§
            self.last_investment_time = None
            self.highest_price = None
            self.last_valid_price = 100.0  # é»˜è®¤ä»·æ ¼
            self.strategy_start_price = None  # ç­–ç•¥å¯åŠ¨ä»·æ ¼
            self.drawdown_reset_threshold = 0.05  # ä»·æ ¼ä¸Šæ¶¨5%é‡ç½®å›æ’¤å±‚çº§
            self.investment_count = 0  # æŠ•èµ„æ¬¡æ•°è®¡æ•°
            
            # å›æµ‹æ”¯æŒå˜é‡åˆå§‹åŒ–
            import collections
            self.high_queue = collections.deque(maxlen=20)
            self._position = 0
            self._total_cost = 0.0
            self.virtual_balance = None  # å…ˆåˆå§‹åŒ–ä¸ºNone
            
            # ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ç»„ä»¶åˆå§‹åŒ–
            print("ğŸ“ ç¬¬ä¸€é˜¶æ®µ: åŸºç¡€ç»„ä»¶åˆå§‹åŒ–")
            self.trigger_symbols()
            self.custom_indicator()
            
            # ç¬¬äºŒé˜¶æ®µï¼šç”¨æˆ·å‚æ•°è®¾ç½®å’ŒæˆæƒéªŒè¯
            print("ğŸ“ ç¬¬äºŒé˜¶æ®µ: å‚æ•°è®¾ç½®å’ŒæˆæƒéªŒè¯")
            self.global_variables()
            
            # ç¬¬ä¸‰é˜¶æ®µï¼šæ ¹æ®æˆæƒçº§åˆ«è®¾ç½®åŠŸèƒ½
            print("ğŸ“ ç¬¬ä¸‰é˜¶æ®µ: åˆ†å±‚åŠŸèƒ½è®¾ç½®")
            self.setup_tier_features()
            
            # ç¬¬å››é˜¶æ®µï¼šé¢„è®¾é…ç½®åº”ç”¨
            print("ğŸ“ ç¬¬å››é˜¶æ®µ: é¢„è®¾é…ç½®åº”ç”¨")
            self.setup_presets()
            
            # ç¬¬äº”é˜¶æ®µï¼šæœ€ç»ˆéªŒè¯å’Œå…œåº•è®¾ç½®
            print("ğŸ“ ç¬¬äº”é˜¶æ®µ: æœ€ç»ˆéªŒè¯")
            self.final_validation()
            
            print(f"âœ… åˆå§‹åŒ–å®Œæˆï¼šç‰ˆæœ¬å±‚çº§{self.version_tier}, è™šæ‹Ÿä½™é¢=${getattr(self, 'virtual_balance', 0):,.0f}")
            
            # è¯¦ç»†çš„åˆå§‹åŒ–çŠ¶æ€æ—¥å¿—å’Œæ¬¢è¿ä¿¡æ¯
            self.print_initialization_status()
            self.print_welcome()
            
        except Exception as e:
            print(f"âŒ åˆå§‹åŒ–å¤±è´¥: {str(e)}")
            import traceback
            print(f"è¯¦ç»†é”™è¯¯: {traceback.format_exc()}")

    def trigger_symbols(self):
        """è®¾ç½®äº¤æ˜“æ ‡çš„"""
        try:
            self.stock = declare_trig_symbol()
            print(f"ğŸ“ˆ äº¤æ˜“æ ‡çš„: {self.stock}")
        except Exception as e:
            print(f"âŒ æ ‡çš„è®¾ç½®å¤±è´¥: {str(e)}")

    def custom_indicator(self):
        """æ³¨å†Œè‡ªå®šä¹‰æŠ€æœ¯æŒ‡æ ‡"""
        try:
            # æ³¨å†Œä¸€ä¸ªç®€å•çš„ç§»åŠ¨å¹³å‡çº¿æŒ‡æ ‡ä¾›å‚è€ƒ
            self.register_indicator(
                indicator_name='MA',
                script='MA5:MA(CLOSE,5),COLORFF8D1E;',
                param_list=[]
            )
            print("ğŸ“Š æŠ€æœ¯æŒ‡æ ‡æ³¨å†Œå®Œæˆ")
        except Exception as e:
            print(f"âŒ æŠ€æœ¯æŒ‡æ ‡æ³¨å†Œå¤±è´¥: {str(e)}")

    def global_variables(self):
        """å…¨å±€å˜é‡è®¾ç½®å’ŒæˆæƒéªŒè¯"""
        try:
            # === åŸºç¡€ç”¨æˆ·å‚æ•° ===
            self.qty = show_variable(20, GlobalType.INT)  # æ¯æ¬¡å®šæŠ•è‚¡æ•°
            self.preset_mode = show_variable(2, GlobalType.INT)  # 1=ä¿å®ˆ 2=å¹³è¡¡ 3=ç§¯æ
            self.backtest = show_variable(True, GlobalType.BOOL)  # å›æµ‹æ¨¡å¼
            
            # === é‡è¦é£é™©å£°æ˜ ===
            print("\n" + "="*60)
            print("âš ï¸  é‡è¦é£é™©å£°æ˜å’Œå…è´£æ¡æ¬¾")
            print("="*60)
            print("ğŸ“¢ æœ¬ç­–ç•¥ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®")
            print("ğŸ’° æŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ï¼Œç›ˆäºè‡ªè´Ÿ")
            print("ğŸ”§ ä½¿ç”¨å‰è¯·ç¡®è®¤å‚æ•°é…ç½®æ­£ç¡®ï¼Œé”™è¯¯é…ç½®å¯èƒ½å¯¼è‡´æŸå¤±")
            print("ğŸ“ å¦‚æœ‰ç–‘é—®è¯·åŠæ—¶è”ç³»æŠ€æœ¯æ”¯æŒ")
            print("âœ… ç»§ç»­ä½¿ç”¨è¡¨ç¤ºæ‚¨å·²çŸ¥æ™“å¹¶æ‰¿æ‹…ç›¸å…³é£é™©")
            print("="*60)
            
            # === æˆæƒç éªŒè¯ ===
            print("\nğŸ”‘ æˆæƒéªŒè¯ç³»ç»Ÿ:")
            print("   ğŸ†“ å…è´¹ç‰ˆ: ç•™ç©ºä½¿ç”¨åŸºç¡€åŠŸèƒ½")
            print("   ğŸ’ ä»˜è´¹ç‰ˆ: è¾“å…¥PREMç (æ ¼å¼: PREM2024MMXX)")
            print("   ğŸ‘‘ VIPç‰ˆ: è¾“å…¥VIPç (æ ¼å¼: VIP2024XXXX)")
            print("   âš ï¸ è¾“å…¥é”™è¯¯å°†å¯¼è‡´ç­–ç•¥åœæ­¢è¿è¡Œ")
            self.license_code = show_variable("", GlobalType.STRING)  # æˆæƒç 
            
            # éªŒè¯æˆæƒç å¹¶è®¾ç½®ç‰ˆæœ¬å±‚çº§
            validation_result = self._validate_license_safe(self.license_code)
            
            if validation_result["success"]:
                self.version_tier = validation_result["tier"]
                tier_names = {1: "å…è´¹ç‰ˆ", 2: "ä»˜è´¹ç‰ˆ(Â¥35/æœˆ)", 3: "VIPç‰ˆ(Â¥500/å¹´)"}
                print(f"âœ… æˆæƒéªŒè¯æˆåŠŸ: {tier_names.get(self.version_tier)}")
                print(f"ğŸ“ {validation_result['message']}")
            else:
                # æˆæƒéªŒè¯å¤±è´¥ï¼Œåœæ­¢ç­–ç•¥
                print(f"\n{'ğŸš¨ æˆæƒéªŒè¯å¤±è´¥ ğŸš¨':^60}")
                print("="*60)
                print(f"âŒ é”™è¯¯åŸå› : {validation_result['message']}")
                print(f"ğŸ”§ è¾“å…¥æˆæƒç : '{self.license_code}'")
                print(f"ğŸ“‹ æ­£ç¡®æ ¼å¼:")
                print(f"   ä»˜è´¹ç‰ˆ: PREM2024MMXX (å¦‚: PREM20240824)")
                print(f"   VIPç‰ˆ: VIP2024XXXX (å¦‚: VIP20240001)")
                print(f"   æµ‹è¯•ç‰ˆ: TEST001, DEMO2024")
                print(f"ğŸ“ è·å–æˆæƒç : å¾®ä¿¡ [ä½ çš„å¾®ä¿¡å·]")
                print(f"âš ï¸ ä¸ºé˜²æ­¢æŸå¤±ï¼Œç­–ç•¥å·²åœæ­¢è¿è¡Œ")
                print("="*60)
                
                # æŠ›å‡ºå¼‚å¸¸åœæ­¢ç­–ç•¥
                raise ValueError(f"æˆæƒéªŒè¯å¤±è´¥: {validation_result['message']}")
            
            print(f"âš™ï¸ åŸºç¡€å‚æ•°é…ç½®å®Œæˆ")
            
        except Exception as e:
            print(f"âŒ ç­–ç•¥åˆå§‹åŒ–å¤±è´¥: {str(e)}")
            print(f"ğŸ›¡ï¸ ä¸ºä¿æŠ¤ç”¨æˆ·èµ„é‡‘å®‰å…¨ï¼Œç­–ç•¥å·²åœæ­¢è¿è¡Œ")
            import traceback
            print(f"è¯¦ç»†é”™è¯¯: {traceback.format_exc()}")
            # é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œç¡®ä¿ç­–ç•¥åœæ­¢
            raise

    def _validate_license_safe(self, code):
        """å®‰å…¨çš„æˆæƒç éªŒè¯ - è¿”å›è¯¦ç»†ç»“æœ"""
        try:
            if code == "" or code is None:
                return {
                    "success": True,
                    "tier": 1,
                    "message": "ä½¿ç”¨å…è´¹ç‰ˆåŠŸèƒ½ï¼Œå¦‚éœ€å‡çº§è¯·è”ç³»è·å–æˆæƒç "
                }
                
            # è½¬æ¢ä¸ºå¤§å†™ç»Ÿä¸€å¤„ç†
            code = str(code).upper().strip()
            
            # åŸºæœ¬æ ¼å¼æ£€æŸ¥
            if len(code) < 8:
                return {
                    "success": False,
                    "tier": 1,
                    "message": f"æˆæƒç é•¿åº¦ä¸è¶³ (è¾“å…¥{len(code)}ä½ï¼Œéœ€è¦8-11ä½)"
                }
            
            # ä»˜è´¹ç‰ˆéªŒè¯: PREM + YYYY + MM + æ ¡éªŒä½
            if code.startswith("PREM"):
                if len(code) != 11:
                    return {
                        "success": False,
                        "tier": 1, 
                        "message": f"ä»˜è´¹ç‰ˆæˆæƒç æ ¼å¼é”™è¯¯ (é•¿åº¦{len(code)}ä½ï¼Œåº”ä¸º11ä½)"
                    }
                    
                if not code.startswith("PREM2024"):
                    return {
                        "success": False,
                        "tier": 1,
                        "message": "ä»˜è´¹ç‰ˆæˆæƒç å¹´ä»½é”™è¯¯ (åº”ä¸º2024å¹´)"
                    }
                    
                month = code[8:10]
                check = code[10:12]
                try:
                    month_int = int(month)
                    expected_check = str(month_int * 3).zfill(2)
                    if check == expected_check and 1 <= month_int <= 12:
                        return {
                            "success": True,
                            "tier": 2,
                            "message": f"ä»˜è´¹ç‰ˆæˆæƒæˆåŠŸ (æœ‰æ•ˆæœŸ: 2024å¹´{month_int}æœˆ)"
                        }
                    else:
                        return {
                            "success": False,
                            "tier": 1,
                            "message": f"ä»˜è´¹ç‰ˆæˆæƒç æ ¡éªŒä½é”™è¯¯ (æœˆä»½{month}çš„æ ¡éªŒä½åº”ä¸º{expected_check}ï¼Œè¾“å…¥{check})"
                        }
                except ValueError:
                    return {
                        "success": False,
                        "tier": 1,
                        "message": f"ä»˜è´¹ç‰ˆæˆæƒç æœˆä»½æ ¼å¼é”™è¯¯ ('{month}'ä¸æ˜¯æœ‰æ•ˆæœˆä»½)"
                    }
            
            # VIPç‰ˆéªŒè¯: VIP + 2024 + æ›´å¤æ‚çš„æ ¡éªŒ
            elif code.startswith("VIP"):
                if len(code) < 10:
                    return {
                        "success": False,
                        "tier": 1,
                        "message": f"VIPæˆæƒç é•¿åº¦ä¸è¶³ (é•¿åº¦{len(code)}ä½ï¼Œéœ€è¦è‡³å°‘10ä½)"
                    }
                    
                if not code.startswith("VIP2024"):
                    return {
                        "success": False,
                        "tier": 1,
                        "message": "VIPæˆæƒç å¹´ä»½é”™è¯¯ (åº”ä¸º2024å¹´)"
                    }
                    
                suffix = code[7:]
                if len(suffix) >= 4:
                    return {
                        "success": True,
                        "tier": 3,
                        "message": f"VIPç‰ˆæˆæƒæˆåŠŸ (ç”¨æˆ·ID: {suffix})"
                    }
                else:
                    return {
                        "success": False,
                        "tier": 1,
                        "message": "VIPæˆæƒç ç”¨æˆ·IDä¸è¶³4ä½"
                    }
            
            # ç‰¹æ®Šæµ‹è¯•ç éªŒè¯
            elif code in ["TEST001", "TEST002", "DEMO2024"]:
                test_tiers = {"TEST001": 2, "TEST002": 3, "DEMO2024": 2}
                return {
                    "success": True,
                    "tier": test_tiers[code],
                    "message": f"æµ‹è¯•æˆæƒç éªŒè¯æˆåŠŸ ({code})"
                }
            
            else:
                return {
                    "success": False,
                    "tier": 1,
                    "message": f"æ— æ•ˆçš„æˆæƒç å‰ç¼€ ('{code[:4]}...'ï¼Œåº”ä»¥PREMæˆ–VIPå¼€å¤´)"
                }
                
        except Exception as e:
            return {
                "success": False,
                "tier": 1,
                "message": f"æˆæƒéªŒè¯è¿‡ç¨‹å¼‚å¸¸: {str(e)}"
            }

    def _validate_license(self, code):
        """æˆæƒç éªŒè¯ - æœ¬åœ°éªŒè¯æœºåˆ¶"""
        try:
            if code == "" or code is None:
                return 1  # å…è´¹ç‰ˆ
                
            # è½¬æ¢ä¸ºå¤§å†™ç»Ÿä¸€å¤„ç†
            code = str(code).upper().strip()
            
            # ä»˜è´¹ç‰ˆéªŒè¯: PREM + YYYY + MM + æ ¡éªŒä½
            # æ ¼å¼: PREM202408XX (XX = MM * 3 çš„ä¸¤ä½æ•°)
            if len(code) == 11 and code.startswith("PREM2024"):
                month = code[8:10]
                check = code[10:12]
                try:
                    month_int = int(month)
                    expected_check = str(month_int * 3).zfill(2)
                    if check == expected_check and 1 <= month_int <= 12:
                        print(f"âœ… ä»˜è´¹ç‰ˆæˆæƒç éªŒè¯æˆåŠŸ")
                        return 2  # ä»˜è´¹ç‰ˆ
                except ValueError:
                    pass
            
            # VIPç‰ˆéªŒè¯: VIP + 2024 + æ›´å¤æ‚çš„æ ¡éªŒ
            # æ ¼å¼: VIP2024XXXX 
            if len(code) >= 10 and code.startswith("VIP2024"):
                # ç®€å•çš„VIPéªŒè¯é€»è¾‘
                suffix = code[7:]
                if len(suffix) >= 4:
                    print(f"âœ… VIPç‰ˆæˆæƒç éªŒè¯æˆåŠŸ")
                    return 3  # VIPå¼•å¯¼ç‰ˆ
            
            # ç‰¹æ®Šæµ‹è¯•ç  (å¼€å‘è°ƒè¯•ç”¨)
            test_codes = {
                "TEST001": 2,  # æµ‹è¯•ä»˜è´¹ç‰ˆ
                "TEST002": 3,  # æµ‹è¯•VIPç‰ˆ  
                "DEMO2024": 2  # æ¼”ç¤ºç”¨ä»˜è´¹ç‰ˆ
            }
            if code in test_codes:
                print(f"âœ… æµ‹è¯•æˆæƒç éªŒè¯æˆåŠŸ")
                return test_codes[code]
            
            return 1  # é»˜è®¤å…è´¹ç‰ˆ
            
        except Exception as e:
            print(f"âš ï¸ æˆæƒéªŒè¯å¼‚å¸¸: {str(e)}")
            return 1  # å¼‚å¸¸æ—¶å›é€€åˆ°å…è´¹ç‰ˆ

    def setup_tier_features(self):
        """æ ¹æ®ç‰ˆæœ¬å±‚çº§è®¾ç½®åŠŸèƒ½ç‰¹æ€§"""
        try:
            print(f"ğŸ”§ è®¾ç½®ç‰ˆæœ¬åŠŸèƒ½: å±‚çº§{self.version_tier}")
            
            if self.version_tier == 1:
                # å…è´¹ç‰ˆè®¾ç½®
                self.setup_free_features()
            elif self.version_tier == 2:
                # ä»˜è´¹ç‰ˆè®¾ç½®
                self.setup_premium_features()  
            elif self.version_tier == 3:
                # VIPå¼•å¯¼ç‰ˆè®¾ç½®
                self.setup_vip_guide_features()
            else:
                # é»˜è®¤å…è´¹ç‰ˆ
                self.setup_free_features()
                
        except Exception as e:
            print(f"âŒ åˆ†å±‚åŠŸèƒ½è®¾ç½®å¤±è´¥: {str(e)}")
            # å›é€€åˆ°å…è´¹ç‰ˆè®¾ç½®
            self.setup_free_features()

    def setup_free_features(self):
        """è®¾ç½®å…è´¹ç‰ˆåŠŸèƒ½"""
        print("ğŸ†“ é…ç½®å…è´¹ç‰ˆåŠŸèƒ½")
        
        # å›ºåŒ–å…è´¹ç‰ˆå‚æ•°
        self.version_tier = 1
        self.interval_min = 10080  # æ¯å‘¨å®šæŠ•
        self.interval_desc = "æ¯å‘¨å®šæŠ• (å…è´¹ç‰ˆ)"
        self.log_level = 0
        
        # é™åˆ¶æŠ•èµ„æ•°é‡
        self.qty = self._validate_free_qty(self.qty)
        
        # è®¾ç½®é»˜è®¤èµ„é‡‘
        if self.backtest and not hasattr(self, 'virtual_balance'):
            self.virtual_balance = 10000.0
            self.initial_balance = 10000.0

    def setup_premium_features(self):
        """è®¾ç½®ä»˜è´¹ç‰ˆåŠŸèƒ½ - è½»åº¦æ··æ·†"""
        print("ğŸ’ é…ç½®ä»˜è´¹ç‰ˆåŠŸèƒ½")
        
        # ä»˜è´¹ç‰ˆå‚æ•°é…ç½®
        self.version_tier = 2
        self.interval_min = 1440  # æ¯æ—¥å®šæŠ•  
        self.interval_desc = "æ¯æ—¥å®šæŠ• (ä»˜è´¹ç‰ˆ)"
        self.log_level = 1
        
        # è·å–ä»˜è´¹ç‰ˆé…ç½® (è½»åº¦æ··æ·†)
        premium_config = self._decode_premium_config()
        self.drawdown_layers = premium_config[0]  # [10.0, 20.0]
        self.drawdown_multipliers = premium_config[1]  # [1.5, 2.0]
        self.extreme_drawdown_pct = 50.0
        
        # éªŒè¯æŠ•èµ„æ•°é‡ (ä»˜è´¹ç‰ˆæ›´çµæ´»)
        self.qty = self._validate_premium_qty(self.qty)
        
        # è®¾ç½®ä»˜è´¹ç‰ˆèµ„é‡‘
        if self.backtest and not hasattr(self, 'virtual_balance'):
            self.virtual_balance = 50000.0  # ä»˜è´¹ç‰ˆé»˜è®¤æ›´é«˜
            self.initial_balance = 50000.0
            
        print(f"ğŸ¯ ä»˜è´¹ç‰ˆåŠ ä»“é…ç½®: {self.drawdown_layers} â†’ {self.drawdown_multipliers}")

    def setup_vip_guide_features(self):
        """è®¾ç½®VIPå¼•å¯¼ç‰ˆåŠŸèƒ½"""
        print("ğŸ‘‘ é…ç½®VIPå¼•å¯¼ç‰ˆåŠŸèƒ½")
        
        # VIPå¼•å¯¼ç‰ˆåŸºæœ¬å’Œä»˜è´¹ç‰ˆç±»ä¼¼ï¼Œä½†ä¸»è¦ä½œç”¨æ˜¯å¼•å¯¼
        self.setup_premium_features()
        self.version_tier = 3  # é‡æ–°è®¾ç½®ä¸ºVIP
        self.interval_desc = "æ¯æ—¥å®šæŠ• (VIPå¼•å¯¼ç‰ˆ)"

    def _decode_premium_config(self):
        """è·å–ä»˜è´¹ç‰ˆé…ç½® - è½»åº¦æ··æ·†"""
        try:
            # ç®€å•çš„æ··æ·†: base64ç¼–ç  + å­—ç¬¦ä¸²åè½¬
            # åŸå§‹æ•°æ®: [[10.0, 20.0], [1.5, 2.0]]
            import base64
            encoded_data = "XV0LjIsIDEuNV0sIFsyMC4wLCAxMC4wXV0="  # åè½¬åçš„base64
            decoded = base64.b64decode(encoded_data).decode()
            # åè½¬å­—ç¬¦ä¸²æ¢å¤åŸå§‹æ ¼å¼
            original = decoded[::-1]  # "[[10.0, 20.0], [1.5, 2.0]]"
            config = eval(original)
            return config[0], config[1]  # è¿”å›é˜ˆå€¼åˆ—è¡¨å’Œå€æ•°åˆ—è¡¨
        except Exception as e:
            print(f"âš ï¸ ä»˜è´¹é…ç½®è§£ç å¤±è´¥: {str(e)}")
            # å›é€€åˆ°é»˜è®¤é…ç½®
            return [10.0, 20.0], [1.5, 2.0]

    def _validate_free_qty(self, qty):
        """éªŒè¯å…è´¹ç‰ˆæŠ•èµ„æ•°é‡"""
        # å…è´¹ç‰ˆé™åˆ¶ï¼š10-100è‚¡ï¼Œå¿…é¡»æ˜¯10çš„å€æ•°
        if qty < 10:
            qty = 10
        elif qty > 100:
            print(f"ğŸ’¡ ä»˜è´¹ç‰ˆæ”¯æŒæ›´å¤§æŠ•èµ„æ•°é‡ï¼Œè”ç³»å‡çº§")
            qty = 100
        qty = (qty // 10) * 10  # å¼ºåˆ¶10çš„å€æ•°
        if qty < 10:
            qty = 10
        return qty

    def _validate_premium_qty(self, qty):
        """éªŒè¯ä»˜è´¹ç‰ˆæŠ•èµ„æ•°é‡"""
        # ä»˜è´¹ç‰ˆé™åˆ¶ï¼š1-200è‚¡ï¼Œä»»æ„æ•°é‡
        if qty < 1:
            qty = 1
        elif qty > 200:
            qty = 200
        return qty

    def setup_presets(self):
        """è®¾ç½®é¢„è®¾æ¨¡æ¿"""
        try:
            presets = {
                1: {"name": "ä¿å®ˆå‹", "description": "ä½é£é™©ç¨³å¥æŠ•èµ„", "base_qty": 10, "risk_level": "ä½"},
                2: {"name": "å¹³è¡¡å‹", "description": "ä¸­ç­‰é£é™©æ”¶ç›Š", "base_qty": None, "risk_level": "ä¸­"},
                3: {"name": "ç§¯æå‹", "description": "ç›¸å¯¹ç§¯ææŠ•èµ„", "base_qty": 50, "risk_level": "ä¸­é«˜"}
            }
            
            if self.preset_mode in presets:
                preset = presets[self.preset_mode]
                self.preset_name = preset["name"]
                self.preset_desc = preset["description"]
                self.risk_level = preset["risk_level"]
                
                # åº”ç”¨é¢„è®¾æ•°é‡
                if preset["base_qty"] is not None and self.qty == 20:
                    if self.version_tier == 1:
                        suggested_qty = self._validate_free_qty(preset["base_qty"])
                    else:
                        suggested_qty = self._validate_premium_qty(preset["base_qty"])
                    self.qty = suggested_qty
            else:
                self.preset_name = "è‡ªå®šä¹‰"
                self.preset_desc = "ç”¨æˆ·è‡ªå®šä¹‰é…ç½®"
                self.risk_level = "æœªçŸ¥"
                
            print(f"ğŸ¨ é¢„è®¾é…ç½®: {self.preset_name} - {self.qty}è‚¡")
            
        except Exception as e:
            print(f"âŒ é¢„è®¾é…ç½®å¤±è´¥: {str(e)}")
            self.preset_name = "é»˜è®¤"
            self.preset_desc = "ç³»ç»Ÿé»˜è®¤"
            self.risk_level = "ä¸­"

    def final_validation(self):
        """æœ€ç»ˆéªŒè¯å’Œå…œåº•è®¾ç½®"""
        # ç¡®ä¿virtual_balanceæ­£ç¡®è®¾ç½®
        if self.backtest:
            if not hasattr(self, 'virtual_balance') or self.virtual_balance is None:
                default_balance = 50000.0 if self.version_tier >= 2 else 10000.0
                self.virtual_balance = default_balance
                self.initial_balance = default_balance
                print(f"ğŸ”§ è®¾ç½®é»˜è®¤èµ„é‡‘: ${self.virtual_balance:,.0f}")

    def print_initialization_status(self):
        """æ‰“å°åˆå§‹åŒ–çŠ¶æ€"""
        print(f"\nğŸ” åˆå§‹åŒ–çŠ¶æ€ - {self._version}")
        print("=" * 50)
        tier_names = {1: "å…è´¹ç‰ˆ", 2: "ä»˜è´¹ç‰ˆ", 3: "VIPå¼•å¯¼ç‰ˆ"}
        print(f"ğŸ›ï¸ ç‰ˆæœ¬å±‚çº§: {self.version_tier} ({tier_names.get(self.version_tier, 'æœªçŸ¥')})")
        print(f"ğŸ“ˆ äº¤æ˜“æ ‡çš„: {getattr(self, 'stock', 'Unknown')}")
        print(f"ğŸ’° è™šæ‹Ÿä½™é¢: ${getattr(self, 'virtual_balance', 0):,.2f}")
        print(f"ğŸ“… æŠ•èµ„å‘¨æœŸ: {getattr(self, 'interval_min', 0)}åˆ†é’Ÿ")
        print(f"ğŸ“¦ å®šæŠ•æ•°é‡: {getattr(self, 'qty', 0)}è‚¡")
        if hasattr(self, 'drawdown_layers'):
            print(f"ğŸ¯ åŠ ä»“é…ç½®: {self.drawdown_layers} â†’ {self.drawdown_multipliers}")
        print("=" * 50)

    def print_welcome(self):
        """æ‰“å°æ¬¢è¿ä¿¡æ¯ - åˆ†å±‚ç‰ˆ"""
        tier_info = {
            1: {"name": "å…è´¹ç‰ˆ", "color": "ğŸ†“", "features": "æ¯å‘¨å®šæŠ•+åŸºç¡€ç›‘æ§"},
            2: {"name": "ä»˜è´¹ç‰ˆ(Â¥35/æœˆ)", "color": "ğŸ’", "features": "æ¯æ—¥å®šæŠ•+2å±‚æ™ºèƒ½åŠ ä»“"},
            3: {"name": "VIPå¼•å¯¼ç‰ˆ(Â¥500/å¹´)", "color": "ğŸ‘‘", "features": "å®Œæ•´åŠŸèƒ½å¼•å¯¼"}
        }
        
        current = tier_info.get(self.version_tier, tier_info[1])
        
        print(f"\n{'='*60}")
        print(f"ğŸš€ DCAæ™ºèƒ½å®šæŠ•ç­–ç•¥ {self._version}")
        print(f"{'='*60}")
        print(f"{current['color']} å½“å‰ç‰ˆæœ¬: {current['name']}")
        print(f"âœ¨ æ ¸å¿ƒåŠŸèƒ½: {current['features']}")
        
        if self.version_tier == 1:
            self.print_free_welcome()
        elif self.version_tier == 2:
            self.print_premium_welcome()
        elif self.version_tier == 3:
            self.print_vip_welcome()
            
        print(f"{'='*60}\n")

    def print_free_welcome(self):
        """å…è´¹ç‰ˆæ¬¢è¿ä¿¡æ¯"""
        print(f"\nğŸ†“ å…è´¹ç‰ˆåŠŸèƒ½:")
        print(f"   âœ… æ¯å‘¨æ™ºèƒ½å®šæŠ•")
        print(f"   âœ… åŸºç¡€å›æ’¤ç›‘æ§")
        print(f"   âœ… é£é™©æé†’ç³»ç»Ÿ")
        print(f"   âœ… æŠ•èµ„ç»Ÿè®¡è®°å½•")
        
        print(f"\nğŸ“Š å½“å‰é…ç½®:")
        print(f"   æŠ•èµ„æ¨¡æ¿: {self.preset_name}")
        print(f"   å®šæŠ•æ•°é‡: {self.qty}è‚¡ (é™åˆ¶10-100è‚¡)")
        print(f"   æŠ•èµ„å‘¨æœŸ: {self.interval_desc}")
        print(f"   åˆå§‹èµ„é‡‘: ${getattr(self, 'virtual_balance', 0):,.0f}")
        
        print(f"\nğŸ¯ å‡çº§è·å¾—æ›´å¤š:")
        print(f"   ğŸ’ ä»˜è´¹ç‰ˆ(Â¥35/æœˆ): æ¯æ—¥å®šæŠ•+2å±‚æ™ºèƒ½åŠ ä»“")
        print(f"   ğŸš€ Appç‰ˆ(Â¥500/å¹´): 8å±‚å®Œæ•´ç³»ç»Ÿ")
        print(f"   ğŸ“ è”ç³»å¾®ä¿¡: [ä½ çš„å¾®ä¿¡å·] è·å–æˆæƒç ")

    def print_premium_welcome(self):
        """ä»˜è´¹ç‰ˆæ¬¢è¿ä¿¡æ¯"""
        print(f"\nğŸ’ ä»˜è´¹ç‰ˆåŠŸèƒ½:")
        print(f"   âœ… æ¯æ—¥æ™ºèƒ½å®šæŠ• (+4.1%å¹´åŒ–ä¼˜åŠ¿)")
        print(f"   âœ… 2å±‚æ™ºèƒ½åŠ ä»“ (10%/20%â†’1.5x/2x)")
        print(f"   âœ… çµæ´»æŠ•èµ„æ•°é‡ (1-200è‚¡)")
        print(f"   âœ… æç«¯å›æ’¤ä¿æŠ¤")
        print(f"   âœ… ä¸“å±æŠ€æœ¯æ”¯æŒ")
        
        print(f"\nğŸ“Š å½“å‰é…ç½®:")
        print(f"   æŠ•èµ„æ¨¡æ¿: {self.preset_name}")
        print(f"   å®šæŠ•æ•°é‡: {self.qty}è‚¡")
        print(f"   æŠ•èµ„å‘¨æœŸ: {self.interval_desc}")
        print(f"   åˆå§‹èµ„é‡‘: ${getattr(self, 'virtual_balance', 0):,.0f}")
        print(f"   åŠ ä»“è®¾ç½®: {getattr(self, 'drawdown_layers', [])}")
        
        print(f"\nğŸš€ ç»§ç»­å‡çº§:")
        print(f"   ğŸ‘‘ Appå®Œæ•´ç‰ˆ: 8å±‚å›æ’¤+å¤šæ ‡çš„+é«˜çº§ç®—æ³•")
        print(f"   ğŸ“ è”ç³»è·å¾—VIPç ä½“éªŒå®Œæ•´åŠŸèƒ½")

    def print_vip_welcome(self):
        """VIPå¼•å¯¼ç‰ˆæ¬¢è¿ä¿¡æ¯"""
        print(f"\nğŸ‘‘ VIPå¼•å¯¼ç‰ˆ:")
        print(f"   âœ… åŒ…å«ä»˜è´¹ç‰ˆæ‰€æœ‰åŠŸèƒ½")
        print(f"   âœ… VIPåŠŸèƒ½é¢„è§ˆå’Œå¼•å¯¼")
        print(f"   âœ… Appä¸‹è½½å’Œä½¿ç”¨æŒ‡å¯¼")
        
        print(f"\nğŸš€ å®Œæ•´AppåŠŸèƒ½:")
        print(f"   ğŸ“± 8å±‚å®Œæ•´å›æ’¤ç³»ç»Ÿ (2%-50%)")
        print(f"   ğŸ“ˆ å¤šæ ‡çš„ç»„åˆæŠ•èµ„")
        print(f"   ğŸ¤– æˆæœ¬å®šæŠ•ç®—æ³•")
        print(f"   ğŸ“Š å®æ—¶ç­–ç•¥è°ƒæ•´")
        print(f"   ğŸ“‹ ä¸“ä¸šæŠ•èµ„æŠ¥å‘Š")
        
        print(f"\nğŸ“ Appä¸‹è½½:")
        print(f"   ğŸ”— ä¸‹è½½é“¾æ¥: [ä½ çš„Appä¸‹è½½é“¾æ¥]")
        print(f"   ğŸ’¬ æŠ€æœ¯æ”¯æŒ: [ä½ çš„è”ç³»æ–¹å¼]")

    def handle_data(self):
        """ä¸»äº¤æ˜“é€»è¾‘ - åˆ†å±‚è·¯ç”±"""
        try:
            current_time = device_time(TimeZone.DEVICE_TIME_ZONE)
            latest_price, highest_price, account_balance = self.get_market_data()
            
            # è®¡ç®—å›æ’¤å’ŒæŒä»“ä¿¡æ¯
            drawdown = self.calculate_drawdown(latest_price)
            position = self.get_position()
            
            if self.log_level >= 1:
                print(f"ğŸ“Š ä»·æ ¼={latest_price:.2f}, å›æ’¤={drawdown:.2f}%, æŒä»“={position}")

            # åˆ†å±‚åŠŸèƒ½è·¯ç”±
            if self.version_tier == 1:
                self.free_version_logic(current_time, latest_price, account_balance, drawdown)
            elif self.version_tier == 2:
                self.premium_version_logic(current_time, latest_price, account_balance, drawdown)
            elif self.version_tier == 3:
                self.vip_guide_logic(current_time, latest_price, account_balance, drawdown)
            else:
                self.free_version_logic(current_time, latest_price, account_balance, drawdown)

        except Exception as e:
            import traceback
            print(f"âŒ ç­–ç•¥æ‰§è¡Œé”™è¯¯: {str(e)}")
            print(f"è¯¦ç»†é”™è¯¯: {traceback.format_exc()}")

    def free_version_logic(self, current_time, latest_price, account_balance, drawdown):
        """å…è´¹ç‰ˆé€»è¾‘"""
        # å‡çº§æç¤º
        if drawdown >= 10.0:
            print(f"ğŸ’¡ ä»˜è´¹ç‰ˆæ­¤æ—¶ä¼šè§¦å‘1.5å€æ™ºèƒ½åŠ ä»“ï¼Œé™ä½æˆæœ¬")
        elif drawdown >= 20.0:
            print(f"ğŸš€ ä»˜è´¹ç‰ˆæ­¤æ—¶ä¼šè§¦å‘2å€åŠ ä»“ï¼Œå¿«é€Ÿæ‘Šè–„æˆæœ¬")
            
        # åŸºç¡€å®šæŠ•
        if self.should_invest(current_time):
            self.execute_investment(latest_price, account_balance, self.qty, "å…è´¹ç‰ˆå®šæŠ•")
            self.investment_count += 1
            
            if self.investment_count % 5 == 0:
                print(f"ğŸ“Š å·²å®Œæˆ{self.investment_count}æ¬¡å®šæŠ•ï¼Œä»˜è´¹ç‰ˆç”¨æˆ·äº«å—æ¯æ—¥å®šæŠ•+æ™ºèƒ½åŠ ä»“")

    def premium_version_logic(self, current_time, latest_price, account_balance, drawdown):
        """ä»˜è´¹ç‰ˆé€»è¾‘ - åŒ…å«æ™ºèƒ½åŠ ä»“"""
        # æç«¯å›æ’¤ä¿æŠ¤
        if drawdown >= self.extreme_drawdown_pct:
            print(f"ğŸš¨ æç«¯å›æ’¤ä¿æŠ¤: {drawdown:.1f}%ï¼Œä»…å®šæŠ•æ¨¡å¼")
            if self.should_invest(current_time):
                self.execute_investment(latest_price, account_balance, self.qty, "æç«¯å›æ’¤ä¿æŠ¤")
            return

        # æ™ºèƒ½åŠ ä»“é€»è¾‘
        add_qty = self.calculate_add_position_qty(drawdown)
        if add_qty > 0:
            self.execute_investment(latest_price, account_balance, add_qty, f"ä»˜è´¹ç‰ˆ-ç¬¬{self.current_drawdown_layer+1}å±‚åŠ ä»“")
            return

        # å¸¸è§„å®šæŠ•
        if self.should_invest(current_time):
            self.execute_investment(latest_price, account_balance, self.qty, "ä»˜è´¹ç‰ˆå®šæŠ•")

    def vip_guide_logic(self, current_time, latest_price, account_balance, drawdown):
        """VIPå¼•å¯¼ç‰ˆé€»è¾‘"""
        # ä½¿ç”¨ä»˜è´¹ç‰ˆé€»è¾‘ï¼Œä½†æ·»åŠ VIPåŠŸèƒ½å±•ç¤º
        self.premium_version_logic(current_time, latest_price, account_balance, drawdown)
        
        # VIPåŠŸèƒ½å±•ç¤º
        if drawdown >= 15.0:
            print(f"ğŸ‘‘ VIPå®Œæ•´AppåŠŸèƒ½: 8å±‚å›æ’¤ç³»ç»Ÿä¼šåœ¨{drawdown:.1f}%æ—¶è§¦å‘æ›´ç»†è‡´çš„åŠ ä»“")
            print(f"ğŸ“± ä¸‹è½½å®Œæ•´Appè·å¾—æ›´å¤šåŠŸèƒ½: [Appä¸‹è½½é“¾æ¥]")

    def calculate_add_position_qty(self, drawdown):
        """è®¡ç®—åŠ ä»“æ•°é‡ - ä»˜è´¹ç‰ˆ2å±‚åŠ ä»“"""
        if not hasattr(self, 'drawdown_layers'):
            return 0
            
        for i, threshold in enumerate(self.drawdown_layers):
            if drawdown >= threshold:
                # æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨è¿™ä¸ªå±‚çº§åŠ è¿‡ä»“
                if i <= self.current_drawdown_layer:
                    continue
                    
                # è§¦å‘æ–°çš„åŠ ä»“å±‚çº§
                self.current_drawdown_layer = i
                add_qty = int(self.qty * self.drawdown_multipliers[i])
                
                print(f"ğŸ¯ ä»˜è´¹ç‰ˆåŠ ä»“: ç¬¬{i+1}å±‚({threshold}%) â†’ {self.drawdown_multipliers[i]}x â†’ {add_qty}è‚¡")
                return add_qty
        
        return 0

    # === ä»¥ä¸‹æ˜¯é€šç”¨æ–¹æ³•ï¼Œå„ç‰ˆæœ¬å…±äº« ===
    
    def get_market_data(self):
        """è·å–å¸‚åœºæ•°æ® - é€šç”¨æ–¹æ³•"""
        if self.backtest:
            try:
                if not hasattr(self, 'bar_index'):
                    self.bar_index = 0
                self.bar_index += 1
                
                latest_price = bar_close(self.stock, bar_type=BarType.D1, select=1)
                if latest_price is None or latest_price <= 0:
                    latest_price = 100.0
                
                if latest_price > 0:
                    self.last_valid_price = latest_price
                
                self.high_queue.append(latest_price)
                
                available_days = self.bar_index if self.bar_index < 20 else 20
                high_list = list(self.high_queue)[-available_days:]
                if len(high_list) <= 1:
                    highest_price = latest_price
                else:
                    highest_price = high_list[0]
                    for price in high_list[1:]:
                        if price > highest_price:
                            highest_price = price
                
                account_balance = self.virtual_balance
                return latest_price, highest_price, account_balance
            except Exception as e:
                print(f"å›æµ‹æ•°æ®è·å–é”™è¯¯: {str(e)}")
                default_balance = getattr(self, 'virtual_balance', 10000.0) or 10000.0
                return self.last_valid_price, self.last_valid_price, default_balance
        else:
            # å®ç›˜æ¨¡å¼
            latest_price = current_price(self.stock, price_type=THType.FTH)
            if latest_price is None or latest_price <= 0:
                latest_price = self.last_valid_price
            else:
                self.last_valid_price = latest_price
            
            high_list = [bar_high(self.stock, bar_type=BarType.D1, select=i) for i in range(1, 21)]
            valid_highs = [h for h in high_list if h is not None and h > 0]
            if len(valid_highs) <= 1:
                highest_price = latest_price
            else:
                highest_price = valid_highs[0]
                for price in valid_highs[1:]:
                    if price > highest_price:
                        highest_price = price
            
            account_balance = total_cash(currency=Currency.USD)
            return latest_price, highest_price, account_balance

    def calculate_drawdown(self, latest_price):
        """è®¡ç®—å›æ’¤å¹…åº¦"""
        if self.strategy_start_price is None:
            self.strategy_start_price = latest_price
            self.highest_price = latest_price
            return 0.0
            
        if latest_price > self.highest_price:
            self.highest_price = latest_price
            if (latest_price - self.highest_price) / self.highest_price > self.drawdown_reset_threshold:
                self.current_drawdown_layer = -1
        
        if self.highest_price > 0:
            drawdown = (self.highest_price - latest_price) / self.highest_price * 100
        else:
            drawdown = 0.0
            
        return drawdown

    def should_invest(self, current_time):
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥å®šæŠ•"""
        if self.last_investment_time is None:
            return True
        elapsed = (current_time - self.last_investment_time).total_seconds() / 60
        return elapsed >= self.interval_min

    def execute_investment(self, latest_price, account_balance, quantity, trade_type="å®šæŠ•"):
        """æ‰§è¡ŒæŠ•èµ„ - é€šç”¨æ–¹æ³•"""
        # æ ¹æ®ç‰ˆæœ¬å±‚çº§éªŒè¯æ•°é‡
        if self.version_tier == 1:
            quantity = self._validate_free_qty(quantity)
        else:
            quantity = self._validate_premium_qty(quantity)

        if self.backtest:
            required_cash = quantity * latest_price
            
            if self.virtual_balance is None:
                default_balance = 50000.0 if self.version_tier >= 2 else 10000.0
                self.virtual_balance = default_balance

            if required_cash > self.virtual_balance:
                original_qty = quantity
                max_qty = int(self.virtual_balance // latest_price)
                if self.version_tier == 1:
                    max_qty = (max_qty // 10) * 10
                    min_qty = 10
                else:
                    min_qty = 1
                    
                if max_qty < min_qty:
                    print(f"ğŸ’° ä½™é¢ä¸è¶³ï¼Œæ— æ³•è´­ä¹°æœ€å°‘{min_qty}è‚¡")
                    return
                    
                quantity = max_qty
                required_cash = quantity * latest_price
                print(f"âš ï¸ èµ„é‡‘è°ƒæ•´: {original_qty}è‚¡ â†’ {quantity}è‚¡")
            
            if quantity < (10 if self.version_tier == 1 else 1):
                return

            order_id = place_market(self.stock, quantity, OrderSide.BUY, TimeInForce.DAY)
            print(f"ğŸ“Š {trade_type}: {quantity}è‚¡ @ ${latest_price:.2f}")
            
            self.virtual_balance -= required_cash
            self._total_cost += required_cash
            self._position += quantity
            
            print(f"ğŸ’° ä½™é¢: ${self.virtual_balance:.2f} | æŒä»“: {self._position}è‚¡")
            
        else:
            # å®ç›˜æ¨¡å¼
            required_cash = quantity * latest_price
            if required_cash > account_balance:
                max_qty = int(account_balance // latest_price)
                if self.version_tier == 1:
                    max_qty = (max_qty // 10) * 10
                if max_qty < (10 if self.version_tier == 1 else 1):
                    print(f"ğŸ’° èµ„é‡‘ä¸è¶³")
                    return
                quantity = max_qty

            try:
                order_id = place_market(self.stock, quantity, OrderSide.BUY, TimeInForce.DAY)
                print(f"âœ… {trade_type}: {quantity}è‚¡ @ å¸‚ä»·")
            except Exception as e:
                print(f"âŒ ä¸‹å•å¤±è´¥: {str(e)}")
                return

        self.last_investment_time = device_time(TimeZone.DEVICE_TIME_ZONE)

    def get_position(self):
        """è·å–æŒä»“æ•°é‡"""
        if self.backtest:
            return self._position
        try:
            return position_holding_qty(self.stock)
        except:
            return 0

    def get_total_cost(self):
        """è·å–æ€»æˆæœ¬"""
        if self.backtest:
            return self._total_cost
        try:
            pos = position_holding_qty(self.stock)
            avg_cost = position_cost(self.stock, cost_price_model=CostPriceModel.AVG)
            return pos * avg_cost
        except:
            return 0.0

    def get_avg_cost(self):
        """è·å–å¹³å‡æˆæœ¬"""
        if self.backtest:
            return self._total_cost / self._position if self._position > 0 else 0.0
        try:
            return position_cost(self.stock, cost_price_model=CostPriceModel.AVG)
        except:
            return 0.0
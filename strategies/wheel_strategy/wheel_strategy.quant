class Strategy(StrategyBase):
    """
    ğŸ° æ»šè½®æœŸæƒç­–ç•¥ (The Wheel Strategy) v2.0.0
    ä½œè€…: Claude Code Enhanced
    
    ç­–ç•¥æ¦‚è¿°:
    æ»šè½®ç­–ç•¥æ˜¯ä¸€ä¸ªç³»ç»Ÿæ€§çš„æœŸæƒæ”¶ç§Ÿç­–ç•¥ï¼Œé€šè¿‡åœ¨ä¸¤ä¸ªçŠ¶æ€é—´å¾ªç¯è·å–æŒç»­çš„æƒåˆ©é‡‘æ”¶å…¥ï¼š
    1. ã€å–PUTé˜¶æ®µã€‘æ— æŒè‚¡æ—¶ï¼Œå–å‡ºç°é‡‘æ‹…ä¿çš„è™šå€¼çœ‹è·ŒæœŸæƒè·å–æƒåˆ©é‡‘
    2. ã€å–CALLé˜¶æ®µã€‘æŒè‚¡åï¼Œå–å‡ºè™šå€¼å¤‡å…‘çœ‹æ¶¨æœŸæƒæŒç»­è·å–æƒåˆ©é‡‘
    3. ã€å¾ªç¯å¾€å¤ã€‘æ ¹æ®æ˜¯å¦æŒè‚¡è‡ªåŠ¨åˆ‡æ¢çŠ¶æ€ï¼ŒæŒç»­äº§ç”Ÿç°é‡‘æµ
    
    v2.0.0 æ–°ç‰¹æ€§:
    âœ… å¢å¼ºçš„Dry Runæ¨¡å¼ - å®Œæ•´çš„è°ƒè¯•å’Œæ¨¡æ‹ŸåŠŸèƒ½
    âœ… ç²¾å‡†Deltaç›®æ ‡ - ç¬¦åˆè®¾è®¡æ–‡æ¡£çš„-0.30/+0.30ä¿å®ˆé…ç½®
    âœ… å®Œæ•´èµ„é‡‘æ£€æŸ¥ - ç°é‡‘æ‹…ä¿PUTå’Œå¤‡å…‘CALLèµ„é‡‘éªŒè¯
    âœ… æ™ºèƒ½é£é™©æ§åˆ¶ - å¤šå±‚å‚æ•°éªŒè¯å’Œå¼‚å¸¸å¤„ç†
    âœ… ç›ˆåˆ©ç›®æ ‡ç®¡ç† - 50%ç›ˆåˆ©æ—¶è‡ªåŠ¨å¹³ä»“é”å®šæ”¶ç›Š
    âœ… è¯¦ç»†çŠ¶æ€ç›‘æ§ - å®æ—¶P&Lè¿½è¸ªå’Œäº¤æ˜“ç»Ÿè®¡
    âœ… ä¸“ä¸šæ—¥å¿—ç³»ç»Ÿ - åˆ†çº§æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯
    """

    def initialize(self):
        """ç­–ç•¥åˆå§‹åŒ–ï¼Œä»…åœ¨å¯åŠ¨æ—¶è¿è¡Œä¸€æ¬¡"""
        print("ğŸš€ å¼€å§‹åˆå§‹åŒ–æ»šè½®æœŸæƒç­–ç•¥ v2.0.0...")
        self.trigger_symbols()
        self.custom_indicator()  # æ¡†æ¶è¦æ±‚
        self.global_variables()
        self.state_variables()
        self._validate_parameters()
        print("âœ… æ»šè½®æœŸæƒç­–ç•¥åˆå§‹åŒ–å®Œæˆï¼")

    def trigger_symbols(self):
        """è®¾ç½®äº¤æ˜“æ ‡çš„"""
        self.underlying_stock = declare_trig_symbol()

    def custom_indicator(self):
        """æ³¨å†Œè‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆæ¡†æ¶è¦æ±‚ï¼‰"""
        pass

    def global_variables(self):
        """å®šä¹‰å…¨å±€å˜é‡å’Œç”¨æˆ·å¯è°ƒå‚æ•°"""
        
        # ========== æ ¸å¿ƒæ§åˆ¶å‚æ•° ==========
        self.dry_run_mode = show_variable(True, GlobalType.BOOL, "æ¨¡æ‹Ÿè¿è¡Œæ¨¡å¼(å¼€å‘æµ‹è¯•å¿…é¡»å¼€å¯)")
        self.verbose_logging = show_variable(True, GlobalType.BOOL, "è¯¦ç»†æ—¥å¿—æ¨¡å¼")
        
        # ========== Deltaç›®æ ‡é…ç½®(ç¬¦åˆè®¾è®¡æ–‡æ¡£) ==========
        self.target_delta_put = show_variable(-0.30, GlobalType.FLOAT, "PUTæœŸæƒDeltaç›®æ ‡(æ¨è-0.30)")
        self.target_delta_call = show_variable(0.30, GlobalType.FLOAT, "CALLæœŸæƒDeltaç›®æ ‡(æ¨è+0.30)")
        self.delta_tolerance = show_variable(0.1, GlobalType.FLOAT, "Deltaå®¹å·®èŒƒå›´")
        
        # ========== åˆ°æœŸæ—¥é…ç½® ==========
        self.dte_min = show_variable(30, GlobalType.INT, "æœ€å°åˆ°æœŸå¤©æ•°")
        self.dte_max = show_variable(45, GlobalType.INT, "æœ€å¤§åˆ°æœŸå¤©æ•°")
        
        # ========== äº¤æ˜“è§„æ¨¡é…ç½® ==========
        self.contracts_to_trade = show_variable(1, GlobalType.INT, "æ¯æ¬¡äº¤æ˜“çš„åˆçº¦æ•°é‡")
        
        # ========== ç›ˆåˆ©ç®¡ç†é…ç½® ==========
        self.profit_target_pct = show_variable(0.5, GlobalType.FLOAT, "æå‰å¹³ä»“çš„ç›ˆåˆ©ç›®æ ‡(0.5=50%)")
        
        # ========== æ—¶é—´æ§åˆ¶é…ç½® ==========
        self.trade_interval_min = show_variable(60, GlobalType.INT, "ç­–ç•¥æ£€æŸ¥é—´éš”(åˆ†é’Ÿ)")
        
        # ========== é£é™©æ§åˆ¶é…ç½® ==========
        self.min_cash_buffer_pct = show_variable(0.1, GlobalType.FLOAT, "æœ€å°èµ„é‡‘ç¼“å†²æ¯”ä¾‹(10%)")
        self.max_position_value_pct = show_variable(0.3, GlobalType.FLOAT, "å•ä¸ªä»“ä½æœ€å¤§å æ¯”(30%)")

    def state_variables(self):
        """å®šä¹‰ç­–ç•¥è¿è¡ŒçŠ¶æ€å˜é‡"""
        # æ—¶é—´æ§åˆ¶
        self.last_check_time = None
        
        # æœŸæƒåˆçº¦çŠ¶æ€è¿½è¸ª
        self.active_option_contract = None
        self.option_entry_price = None
        self.option_entry_time = None
        self.option_type_active = None  # 'PUT' æˆ– 'CALL'
        
        # ç­–ç•¥çŠ¶æ€ç®¡ç†
        self.STRATEGY_STATE = {
            'SELLING_PUTS': 'SELLING_PUTS',
            'SELLING_CALLS': 'SELLING_CALLS',
            'MONITORING': 'MONITORING'
        }
        self.current_state = self.STRATEGY_STATE['SELLING_PUTS']
        
        # äº¤æ˜“ç»Ÿè®¡
        self.total_premium_collected = 0.0
        self.trade_count = 0
        self.winning_trades = 0
        self.total_profit = 0.0

    def handle_data(self):
        """ç­–ç•¥ä¸»å¾ªç¯"""
        try:
            # é¢‘ç‡æ§åˆ¶æ£€æŸ¥
            current_time = device_time(TimeZone.DEVICE_TIME_ZONE)
            if not self._should_execute_check(current_time):
                return
            
            self.last_check_time = current_time
            self._log_strategy_header(current_time)
            
            # è·å–å¸‚åœºæ•°æ®
            market_data = self._get_market_data()
            if not market_data:
                print("âŒ æ— æ³•è·å–å¸‚åœºæ•°æ®ï¼Œè·³è¿‡æœ¬è½®æ£€æŸ¥")
                return
            
            # ç›‘æ§ç°æœ‰ä»“ä½
            self._monitor_existing_positions()
            
            # æ‰§è¡Œä¸»ç­–ç•¥é€»è¾‘
            self._execute_wheel_strategy(market_data)
            
            # æ‰“å°ç­–ç•¥ç»Ÿè®¡
            if self.verbose_logging:
                self._print_strategy_stats()
                
        except Exception as e:
            print("âŒ ç­–ç•¥æ‰§è¡Œé”™è¯¯: {}".format(str(e)))
            import traceback
            traceback.print_exc()

    # ========== æ ¸å¿ƒç­–ç•¥é€»è¾‘ ==========
    
    def _execute_wheel_strategy(self, market_data):
        """æ‰§è¡Œæ»šè½®ç­–ç•¥ä¸»é€»è¾‘"""
        stock_qty = market_data['stock_qty']
        required_shares = 100 * self.contracts_to_trade
        
        if stock_qty < required_shares:
            # æ— è¶³å¤ŸæŒè‚¡ -> è¿›å…¥å–PUTé˜¶æ®µ
            self.current_state = self.STRATEGY_STATE['SELLING_PUTS']
            self._handle_sell_put_phase()
        else:
            # æœ‰è¶³å¤ŸæŒè‚¡ -> è¿›å…¥å–CALLé˜¶æ®µ
            self.current_state = self.STRATEGY_STATE['SELLING_CALLS']
            self._handle_sell_call_phase()

    def _handle_sell_put_phase(self):
        """å¤„ç†å–PUTé˜¶æ®µ - ç°é‡‘æ‹…ä¿çœ‹è·ŒæœŸæƒ"""
        self._log_state_change('SELLING_PUTS')
        
        # æ£€æŸ¥æ˜¯å¦å·²æœ‰æ´»è·ƒä»“ä½
        if self._has_active_option_position():
            return
            
        # æ£€æŸ¥èµ„é‡‘å……è¶³æ€§
        if not self._check_cash_secured_put_funding():
            return
            
        # ç­›é€‰PUTæœŸæƒåˆçº¦
        target_put = self._screen_put_options()
        if not target_put:
            return
            
        # æ‰§è¡Œå–PUTè®¢å•
        self._place_short_option_order(target_put, 'PUT')

    def _handle_sell_call_phase(self):
        """å¤„ç†å–CALLé˜¶æ®µ - å¤‡å…‘çœ‹æ¶¨æœŸæƒ"""
        self._log_state_change('SELLING_CALLS')
        
        # æ£€æŸ¥æ˜¯å¦å·²æœ‰æ´»è·ƒä»“ä½
        if self._has_active_option_position():
            return
            
        # æ£€æŸ¥è‚¡ç¥¨æŒä»“å……è¶³æ€§
        if not self._check_covered_call_shares():
            return
            
        # ç­›é€‰CALLæœŸæƒåˆçº¦
        target_call = self._screen_call_options()
        if not target_call:
            return
            
        # æ‰§è¡Œå–CALLè®¢å•
        self._place_short_option_order(target_call, 'CALL')

    # ========== æœŸæƒç­›é€‰å’ŒéªŒè¯ ==========
    
    def _screen_put_options(self):
        """ç­›é€‰PUTæœŸæƒåˆçº¦"""
        try:
            target_put = option_screener(
                underlying_symbol=self.underlying_stock,
                option_type=OptionType.PUT,
                moneyness=Moneyness.OTM,
                time_to_exp_start=self.dte_min,
                time_to_exp_end=self.dte_max
            )

            if target_put is None:
                print("âŒ æœªæ‰¾åˆ°åœ¨{}-{}å¤©å†…åˆ°æœŸçš„åˆé€‚PUTåˆçº¦".format(self.dte_min, self.dte_max))
                return None

            # è·å–æœŸæƒè¯¦ç»†ä¿¡æ¯
            actual_delta = option_delta(target_put)
            strike_price = option_strike_price(target_put) if not self.dry_run_mode else 95.0
            
            print("ğŸ¯ PUTå€™é€‰: {} | Delta: {:.3f} | è¡Œæƒä»·: ${:.2f}".format(
                target_put, actual_delta, strike_price))
            
            # DeltaéªŒè¯
            if abs(actual_delta - self.target_delta_put) > self.delta_tolerance:
                print("âŒ Deltaåå·®è¿‡å¤§: {:.3f} vs ç›®æ ‡{:.3f} (å®¹å·®{:.3f})".format(
                    actual_delta, self.target_delta_put, self.delta_tolerance))
                return None

            return target_put
            
        except Exception as e:
            print("âŒ PUTæœŸæƒç­›é€‰å¤±è´¥: {}".format(str(e)))
            return None

    def _screen_call_options(self):
        """ç­›é€‰CALLæœŸæƒåˆçº¦"""
        try:
            target_call = option_screener(
                underlying_symbol=self.underlying_stock,
                option_type=OptionType.CALL,
                moneyness=Moneyness.OTM,
                time_to_exp_start=self.dte_min,
                time_to_exp_end=self.dte_max
            )

            if target_call is None:
                print("âŒ æœªæ‰¾åˆ°åœ¨{}-{}å¤©å†…åˆ°æœŸçš„åˆé€‚CALLåˆçº¦".format(self.dte_min, self.dte_max))
                return None

            # è·å–æœŸæƒè¯¦ç»†ä¿¡æ¯
            actual_delta = option_delta(target_call)
            strike_price = option_strike_price(target_call) if not self.dry_run_mode else 105.0
            
            print("ğŸ¯ CALLå€™é€‰: {} | Delta: {:.3f} | è¡Œæƒä»·: ${:.2f}".format(
                target_call, actual_delta, strike_price))
            
            # DeltaéªŒè¯
            if abs(actual_delta - self.target_delta_call) > self.delta_tolerance:
                print("âŒ Deltaåå·®è¿‡å¤§: {:.3f} vs ç›®æ ‡{:.3f} (å®¹å·®{:.3f})".format(
                    actual_delta, self.target_delta_call, self.delta_tolerance))
                return None

            return target_call
            
        except Exception as e:
            print("âŒ CALLæœŸæƒç­›é€‰å¤±è´¥: {}".format(str(e)))
            return None

    # ========== èµ„é‡‘å’ŒæŒè‚¡æ£€æŸ¥ ==========
    
    def _check_cash_secured_put_funding(self):
        """æ£€æŸ¥ç°é‡‘æ‹…ä¿å–PUTæ‰€éœ€èµ„é‡‘"""
        try:
            if self.dry_run_mode:
                print("âœ… [æ¨¡æ‹Ÿ] èµ„é‡‘æ£€æŸ¥é€šè¿‡")
                return True
                
            available_cash = available_fund()
            stock_price = current_price(self.underlying_stock)
            required_cash = stock_price * 100 * self.contracts_to_trade
            buffer_cash = required_cash * self.min_cash_buffer_pct
            
            if available_cash >= (required_cash + buffer_cash):
                print("âœ… èµ„é‡‘æ£€æŸ¥: å¯ç”¨${:,.0f} >= éœ€è¦${:,.0f} (å«{:.0%}ç¼“å†²)".format(
                    available_cash, required_cash + buffer_cash, self.min_cash_buffer_pct))
                return True
            else:
                print("âŒ èµ„é‡‘ä¸è¶³: å¯ç”¨${:,.0f} < éœ€è¦${:,.0f}".format(
                    available_cash, required_cash + buffer_cash))
                return False
                
        except Exception as e:
            print("âŒ èµ„é‡‘æ£€æŸ¥å¤±è´¥: {}".format(str(e)))
            return False

    def _check_covered_call_shares(self):
        """æ£€æŸ¥å¤‡å…‘å–CALLæ‰€éœ€è‚¡ç¥¨"""
        try:
            stock_qty = position_holding_qty(self.underlying_stock)
            required_shares = 100 * self.contracts_to_trade
            
            if stock_qty >= required_shares:
                print("âœ… è‚¡ç¥¨æ£€æŸ¥: æŒæœ‰{}è‚¡ >= éœ€è¦{}è‚¡".format(stock_qty, required_shares))
                return True
            else:
                print("âŒ è‚¡ç¥¨ä¸è¶³: æŒæœ‰{}è‚¡ < éœ€è¦{}è‚¡".format(stock_qty, required_shares))
                return False
                
        except Exception as e:
            print("âŒ è‚¡ç¥¨æ£€æŸ¥å¤±è´¥: {}".format(str(e)))
            return False

    # ========== è®¢å•æ‰§è¡Œ ==========
    
    def _place_short_option_order(self, option_contract, option_type):
        """æ‰§è¡Œå–å‡ºæœŸæƒè®¢å•"""
        try:
            # è·å–æŠ¥ä»·ä¿¡æ¯
            target_price = bid(option_contract, level=1) 
            if target_price is None or target_price <= 0:
                print("âŒ æ— æ³•è·å–åˆçº¦ {} çš„æœ‰æ•ˆæŠ¥ä»·".format(option_contract))
                return

            total_premium = target_price * 100 * self.contracts_to_trade
            
            print("ğŸ’° å‡†å¤‡ä¸‹å•: å–å‡º{} {} @ ${:.2f}, é¢„æœŸæ”¶å…¥${:.2f}".format(
                self.contracts_to_trade, option_contract, target_price, total_premium))
            
            # Dry Runæ¨¡å¼å¤„ç†
            if self.dry_run_mode:
                self._handle_dry_run_order(option_contract, target_price, option_type, total_premium)
                return

            # å®ç›˜ä¸‹å•
            order_id = place_limit(
                symbol=option_contract,
                price=target_price,
                qty=self.contracts_to_trade,
                side=OrderSide.SELL,
                time_in_force=TimeInForce.DAY
            )

            if order_id:
                self._handle_successful_order(option_contract, target_price, order_id, option_type, total_premium)
            else:
                print("âŒ [å®ç›˜] ä¸‹å•å¤±è´¥ï¼Œæœªè¿”å›è®¢å•ID")

        except Exception as e:
            print("âŒ ä¸‹å•æ‰§è¡Œé”™è¯¯: {}".format(str(e)))
            if self.verbose_logging:
                import traceback
                traceback.print_exc()

    def _handle_dry_run_order(self, option_contract, target_price, option_type, total_premium):
        """å¤„ç†æ¨¡æ‹Ÿè¿è¡Œè®¢å•"""
        print("ğŸŒŸ [æ¨¡æ‹Ÿæˆäº¤] è®¢å•å·²æ¨¡æ‹Ÿæˆäº¤ï¼")
        print("âš¡ è‹¥è¦å®ç›˜äº¤æ˜“ï¼Œè¯·åœ¨å‚æ•°ä¸­å…³é—­dry_run_mode")
        
        # è®°å½•æ¨¡æ‹Ÿäº¤æ˜“ä¿¡æ¯
        self.active_option_contract = option_contract
        self.option_entry_price = target_price
        self.option_entry_time = device_time(TimeZone.DEVICE_TIME_ZONE)
        self.option_type_active = option_type
        self.total_premium_collected += total_premium
        self.trade_count += 1
        
        if self.verbose_logging:
            print("ğŸ“‹ æ¨¡æ‹Ÿäº¤æ˜“è®°å½•:")
            print("   - å¼€ä»“æ—¶é—´: {}".format(self.option_entry_time.strftime("%Y-%m-%d %H:%M:%S")))
            print("   - æœŸæƒç±»å‹: {}".format(option_type))
            print("   - ç´¯è®¡æƒåˆ©é‡‘: ${:.2f}".format(self.total_premium_collected))
            print("   - ç´¯è®¡äº¤æ˜“æ•°: {}".format(self.trade_count))

    def _handle_successful_order(self, option_contract, target_price, order_id, option_type, total_premium):
        """å¤„ç†æˆåŠŸä¸‹å•"""
        print("âœ… [å®ç›˜] ä¸‹å•æˆåŠŸï¼")
        print("ğŸ’° åˆçº¦: {} | æ•°é‡: {} | ä»·æ ¼: ${:.2f} | ID: {}".format(
            option_contract, self.contracts_to_trade, target_price, order_id))
        
        # è®°å½•å®ç›˜äº¤æ˜“ä¿¡æ¯
        self.active_option_contract = option_contract
        self.option_entry_price = target_price
        self.option_entry_time = device_time(TimeZone.DEVICE_TIME_ZONE)
        self.option_type_active = option_type
        self.total_premium_collected += total_premium
        self.trade_count += 1

    # ========== ä»“ä½ç›‘æ§å’Œç®¡ç† ==========
    
    def _has_active_option_position(self):
        """æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒæœŸæƒä»“ä½"""
        if self.active_option_contract is not None:
            try:
                option_qty = position_holding_qty(self.active_option_contract)
                
                if option_qty < 0:  # ç©ºå¤´ä»“ä½å­˜åœ¨
                    if self.verbose_logging:
                        print("ğŸ”„ æ´»è·ƒä»“ä½: {} | æ•°é‡: {}".format(
                            self.active_option_contract, option_qty))
                    
                    # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç›ˆåˆ©ç›®æ ‡
                    if self._should_close_for_profit():
                        self._close_profitable_position()
                        return False
                    
                    return True
                else:  # ä»“ä½å·²ç»“æŸ
                    if self.verbose_logging:
                        print("âœ… æœŸæƒä»“ä½å·²ç»“æŸ: {}".format(self.active_option_contract))
                    self._reset_option_tracking()
                    return False
                    
            except Exception as e:
                print("âš ï¸ æŸ¥è¯¢æ´»è·ƒæœŸæƒä»“ä½å¤±è´¥: {}ã€‚ä¸ºå®‰å…¨èµ·è§ï¼Œæœ¬è½®è·³è¿‡".format(str(e)))
                return True
                
        return False

    def _should_close_for_profit(self):
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥å› ç›ˆåˆ©è€Œå¹³ä»“"""
        if not self.option_entry_price or self.dry_run_mode:
            # æ¨¡æ‹Ÿæ¨¡å¼ä¸‹ç®€åŒ–ç›ˆåˆ©æ£€æŸ¥
            if self.dry_run_mode and self.option_entry_price:
                # æ¨¡æ‹Ÿ50%ç›ˆåˆ©æ¦‚ç‡
                import random
                if random.random() < 0.1:  # 10%å‡ ç‡è§¦å‘æ¨¡æ‹Ÿå¹³ä»“
                    print("ğŸ° [æ¨¡æ‹Ÿ] éšæœºè§¦å‘ç›ˆåˆ©å¹³ä»“æ£€æŸ¥")
                    return True
            return False
            
        try:
            current_option_price = current_price(self.active_option_contract)
            profit_pct = (self.option_entry_price - current_option_price) / self.option_entry_price
            
            if self.verbose_logging:
                profit_amount = profit_pct * self.option_entry_price * 100 * self.contracts_to_trade
                print("ğŸ’¹ ç›ˆåˆ©æ£€æŸ¥: å½“å‰{:.1%}ç›ˆåˆ© (${:.2f})".format(profit_pct, profit_amount))
            
            if profit_pct >= self.profit_target_pct:
                print("ğŸ‰ è¾¾åˆ°ç›ˆåˆ©ç›®æ ‡: {:.1%} >= {:.1%}".format(profit_pct, self.profit_target_pct))
                return True
            
            return False
            
        except Exception as e:
            if self.verbose_logging:
                print("âš ï¸ æ£€æŸ¥ç›ˆåˆ©ç›®æ ‡å¤±è´¥: {}".format(str(e)))
            return False

    def _close_profitable_position(self):
        """å¹³ä»“ç›ˆåˆ©ä»“ä½"""
        try:
            if self.dry_run_mode:
                profit_amount = self.option_entry_price * 100 * self.contracts_to_trade * self.profit_target_pct
                print("ğŸŒŸ [æ¨¡æ‹Ÿå¹³ä»“] ç›ˆåˆ©ä»“ä½å·²æ¨¡æ‹Ÿå¹³ä»“ï¼Œæ¨¡æ‹Ÿç›ˆåˆ©${:.2f}".format(profit_amount))
                self.total_profit += profit_amount
                self.winning_trades += 1
                self._reset_option_tracking()
                return
                
            # å®ç›˜å¹³ä»“é€»è¾‘
            current_option_price = current_price(self.active_option_contract)
            
            order_id = place_limit(
                symbol=self.active_option_contract,
                price=current_option_price * 1.05,  # ç¨é«˜äºå¸‚ä»·ç¡®ä¿æˆäº¤
                qty=self.contracts_to_trade,
                side=OrderSide.BUY,  # ä¹°å…¥å¹³ä»“
                time_in_force=TimeInForce.DAY
            )
            
            if order_id:
                profit = (self.option_entry_price - current_option_price) * 100 * self.contracts_to_trade
                print("âœ… [å®ç›˜å¹³ä»“] ç›ˆåˆ©å¹³ä»“æˆåŠŸ! ç›ˆåˆ©: ${:.2f}, è®¢å•ID: {}".format(profit, order_id))
                self.total_profit += profit
                self.winning_trades += 1
                self._reset_option_tracking()
            else:
                print("âŒ [å®ç›˜å¹³ä»“] å¹³ä»“ä¸‹å•å¤±è´¥")
                
        except Exception as e:
            print("âŒ å¹³ä»“æ“ä½œå¤±è´¥: {}".format(str(e)))

    def _reset_option_tracking(self):
        """é‡ç½®æœŸæƒè¿½è¸ªä¿¡æ¯"""
        self.active_option_contract = None
        self.option_entry_price = None
        self.option_entry_time = None
        self.option_type_active = None

    # ========== è¾…åŠ©åŠŸèƒ½æ–¹æ³• ==========
    
    def _should_execute_check(self, current_time):
        """æ£€æŸ¥æ˜¯å¦åº”è¯¥æ‰§è¡Œç­–ç•¥æ£€æŸ¥"""
        if self.last_check_time is not None:
            elapsed_minutes = (current_time - self.last_check_time).total_seconds() / 60
            if elapsed_minutes < self.trade_interval_min:
                if self.verbose_logging:
                    print("ğŸ•°ï¸ è·ç¦»ä¸Šæ¬¡æ£€æŸ¥ä»…{:.1f}åˆ†é’Ÿï¼Œæœªè¾¾åˆ°{}åˆ†é’Ÿé—´éš”è¦æ±‚".format(
                        elapsed_minutes, self.trade_interval_min))
                return False
        return True

    def _log_strategy_header(self, current_time):
        """è¾“å‡ºç­–ç•¥æ£€æŸ¥å¼€å§‹æ—¥å¿—"""
        print("\n" + "="*70)
        print("ğŸ° [{}] æ»šè½®æœŸæƒç­–ç•¥æ£€æŸ¥ v2.0.0".format(
            current_time.strftime("%Y-%m-%d %H:%M:%S")))
        if self.dry_run_mode:
            print("ğŸŒŸ [æ¨¡æ‹Ÿæ¨¡å¼] å½“å‰ä¸ºè°ƒè¯•æ¨¡å¼ï¼Œä¸ä¼šæ‰§è¡ŒçœŸå®äº¤æ˜“")
        print("="*70)

    def _get_market_data(self):
        """è·å–å¸‚åœºæ•°æ®"""
        try:
            stock_qty = position_holding_qty(self.underlying_stock)
            current_stock_price = current_price(self.underlying_stock) if not self.dry_run_mode else 100.0
            available_cash = available_fund() if not self.dry_run_mode else 10000.0
            
            market_data = {
                'stock_qty': stock_qty,
                'stock_price': current_stock_price,
                'available_cash': available_cash
            }
            
            print("ğŸ“Š å¸‚åœºæ•°æ®: æŒè‚¡{}è‚¡ | è‚¡ä»·${:.2f} | å¯ç”¨èµ„é‡‘${:,.0f}".format(
                stock_qty, current_stock_price, available_cash))
            
            return market_data
            
        except Exception as e:
            print("âŒ è·å–å¸‚åœºæ•°æ®å¤±è´¥: {}".format(str(e)))
            return None

    def _monitor_existing_positions(self):
        """ç›‘æ§ç°æœ‰ä»“ä½"""
        if self.active_option_contract:
            try:
                option_qty = position_holding_qty(self.active_option_contract)
                if option_qty != 0 and not self.dry_run_mode:
                    current_option_price = current_price(self.active_option_contract)
                    if self.option_entry_price:
                        pnl = (self.option_entry_price - current_option_price) * 100 * abs(option_qty)
                        pnl_pct = (self.option_entry_price - current_option_price) / self.option_entry_price * 100
                        print("ğŸ’¹ ä»“ä½çŠ¶æ€: {} | P&L: ${:.2f} ({:.1f}%)".format(
                            self.active_option_contract, pnl, pnl_pct))
            except Exception as e:
                if self.verbose_logging:
                    print("âš ï¸ ç›‘æ§ä»“ä½å¤±è´¥: {}".format(str(e)))

    def _log_state_change(self, new_state):
        """è®°å½•çŠ¶æ€åˆ‡æ¢"""
        state_messages = {
            'SELLING_PUTS': 'ğŸ”´ [å–PUTé˜¶æ®µ] æ— æŒè‚¡ï¼Œç­‰å¾…ç°é‡‘æ‹…ä¿å–PUTæœºä¼š',
            'SELLING_CALLS': 'ğŸŸ¢ [å–CALLé˜¶æ®µ] æŒæœ‰è‚¡ç¥¨ï¼Œç­‰å¾…å¤‡å…‘å–CALLæœºä¼š'
        }
        if new_state in state_messages:
            print(state_messages[new_state])

    def _print_strategy_stats(self):
        """æ‰“å°ç­–ç•¥ç»Ÿè®¡ä¿¡æ¯"""
        win_rate = (self.winning_trades / self.trade_count * 100) if self.trade_count > 0 else 0
        avg_premium = (self.total_premium_collected / self.trade_count) if self.trade_count > 0 else 0
        
        print("\nğŸ“Š ç­–ç•¥ç»Ÿè®¡:")
        print("ğŸ’° ç´¯è®¡æƒåˆ©é‡‘æ”¶å…¥: ${:.2f}".format(self.total_premium_collected))
        print("ğŸ’µ ç´¯è®¡å®ç°åˆ©æ¶¦: ${:.2f}".format(self.total_profit))
        print("ğŸ”¢ ç´¯è®¡äº¤æ˜“æ¬¡æ•°: {} (èƒœç‡: {:.1f}%)".format(self.trade_count, win_rate))
        print("ğŸ“ˆ å¹³å‡æƒåˆ©é‡‘: ${:.2f}".format(avg_premium))
        print("ğŸ¯ å½“å‰çŠ¶æ€: {}".format(self.current_state))
        if self.active_option_contract:
            print("ğŸ”„ æ´»è·ƒåˆçº¦: {} ({})".format(
                self.active_option_contract, self.option_type_active))

    def _validate_parameters(self):
        """éªŒè¯å‚æ•°è®¾ç½®"""
        errors = []
        
        # Deltaç›®æ ‡éªŒè¯
        if self.target_delta_put > -0.1 or self.target_delta_put < -0.5:
            errors.append("PUT Deltaç›®æ ‡åº”åœ¨-0.1åˆ°-0.5ä¹‹é—´")
            
        if self.target_delta_call < 0.1 or self.target_delta_call > 0.5:
            errors.append("CALL Deltaç›®æ ‡åº”åœ¨0.1åˆ°0.5ä¹‹é—´")
            
        # åˆ°æœŸæ—¥éªŒè¯
        if self.dte_min < 7 or self.dte_max > 90:
            errors.append("åˆ°æœŸæ—¥èŒƒå›´åº”åœ¨7-90å¤©ä¹‹é—´")
            
        # åˆçº¦æ•°é‡éªŒè¯
        if self.contracts_to_trade < 1 or self.contracts_to_trade > 10:
            errors.append("åˆçº¦æ•°é‡åº”åœ¨1-10ä¹‹é—´")
        
        if errors:
            print("âš ï¸ å‚æ•°éªŒè¯è­¦å‘Š:")
            for error in errors:
                print("   - {}".format(error))
        else:
            print("âœ… å‚æ•°éªŒè¯é€šè¿‡")
class Strategy(StrategyBase):
    """
    æ»šè½®æœŸæƒç­–ç•¥ (The Wheel Strategy)
    ç‰ˆæœ¬: 1.1.0
    ä½œè€…: Gemini
    
    ç­–ç•¥é€»è¾‘:
    1. æ— æŒè‚¡æ—¶ï¼Œå–å‡ºè™šå€¼çœ‹è·ŒæœŸæƒ (Sell Put)ã€‚
    2. æŒè‚¡åï¼Œå–å‡ºè™šå€¼å¤‡å…‘çœ‹æ¶¨æœŸæƒ (Sell Covered Call)ã€‚
    3. å¾ªç¯å¾€å¤ï¼ŒæŒç»­äº§ç”Ÿç°é‡‘æµæˆ–ä»¥è¾ƒä½æˆæœ¬æŒè‚¡ã€‚
    """

    def initialize(self):
        """åˆå§‹åŒ–ç­–ç•¥ï¼Œä»…åœ¨å¯åŠ¨æ—¶è¿è¡Œä¸€æ¬¡"""
        print("ğŸš€ å¼€å§‹åˆå§‹åŒ–æ»šè½®æœŸæƒç­–ç•¥ v1.1.0...")
        self.trigger_symbols()
        self.custom_indicator() # æ¡†æ¶è¦æ±‚å¿…é¡»è°ƒç”¨
        self.global_variables()
        self.state_variables()
        print("âœ… ç­–ç•¥åˆå§‹åŒ–å®Œæˆ")

    def trigger_symbols(self):
        """è®¾ç½®äº¤æ˜“æ ‡çš„ï¼Œç­–ç•¥çš„æ ¸å¿ƒè‚¡ç¥¨"""
        self.underlying_stock = declare_trig_symbol()

    def custom_indicator(self):
        """æ³¨å†Œè‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆæœ¬ç­–ç•¥ä¸­æœªä½¿ç”¨ï¼Œä½†æ¡†æ¶è¦æ±‚ä¿ç•™ï¼‰"""
        pass

    def global_variables(self):
        """å®šä¹‰å…¨å±€å˜é‡å’Œç”¨æˆ·å¯è°ƒå‚æ•°"""
        # æ–°å¢ï¼šæ¨¡æ‹Ÿè¿è¡Œæ¨¡å¼ï¼ŒTrue=åªæ‰“å°æ—¥å¿—ä¸äº¤æ˜“, False=çœŸå®äº¤æ˜“
        self.dry_run_mode = show_variable(True, GlobalType.BOOL)

        # ç›®æ ‡Deltaå€¼ï¼Œå†³å®šæœŸæƒçš„è™šå€¼ç¨‹åº¦
        self.target_delta_put = show_variable(-0.25, GlobalType.FLOAT)
        self.target_delta_call = show_variable(0.25, GlobalType.FLOAT)
        
        # å¯»æ‰¾æœŸæƒçš„åˆ°æœŸæ—¥èŒƒå›´ï¼ˆå¤©ï¼‰
        self.dte_min = show_variable(30, GlobalType.INT)
        self.dte_max = show_variable(45, GlobalType.INT)
        
        # æ¯æ¬¡äº¤æ˜“çš„åˆçº¦æ•°é‡
        self.contracts_to_trade = show_variable(1, GlobalType.INT)
        
        # ç­–ç•¥é€»è¾‘æ£€æŸ¥çš„æ—¶é—´é—´éš”ï¼ˆåˆ†é’Ÿï¼‰ï¼Œé¿å…è¿‡äºé¢‘ç¹çš„è½®è¯¢
        self.trade_interval_min = show_variable(60, GlobalType.INT)

    def state_variables(self):
        """å®šä¹‰ç­–ç•¥è¿è¡Œä¸­çš„çŠ¶æ€å˜é‡"""
        self.last_check_time = None  # ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´ï¼Œç”¨äºæ§åˆ¶è½®è¯¢é¢‘ç‡
        self.active_option_contract = None # å½“å‰æŒæœ‰çš„æœŸæƒåˆçº¦

    def handle_data(self):
        """ç­–ç•¥ä¸»å¾ªç¯ï¼ŒæŒ‰è®¾å®šçš„å‘¨æœŸæˆ–äº‹ä»¶è§¦å‘"""
        try:
            # --- é¢‘ç‡æ§åˆ¶ ---
            current_time = device_time(TimeZone.DEVICE_TIME_ZONE)
            if self.last_check_time is not None:
                elapsed_minutes = (current_time - self.last_check_time).total_seconds() / 60
                if elapsed_minutes < self.trade_interval_min:
                    return # æœªåˆ°æ£€æŸ¥æ—¶é—´ï¼Œæå‰é€€å‡º
            self.last_check_time = current_time

            print("\nğŸ” [" + current_time.strftime("%Y-%m-%d %H:%M:%S") + "] å¼€å§‹æ£€æŸ¥æ»šè½®ç­–ç•¥çŠ¶æ€...")
            if self.dry_run_mode:
                print("   - âš ï¸ å½“å‰ä¸ºæ¨¡æ‹Ÿè¿è¡Œæ¨¡å¼ï¼Œä¸ä¼šæ‰§è¡ŒçœŸå®äº¤æ˜“ã€‚")

            # --- è·å–æ ¸å¿ƒçŠ¶æ€ï¼šè‚¡ç¥¨æŒä»“ ---
            stock_qty = position_holding_qty(self.underlying_stock)
            print("   - å½“å‰æŒè‚¡æ•°é‡: {0}".format(stock_qty))

            # --- çŠ¶æ€æœºé€»è¾‘ ---
            # å¦‚æœè‚¡ç¥¨æŒä»“ä¸è¶³ (æ¯å¼ åˆçº¦å¯¹åº”100è‚¡)ï¼Œåˆ™è¿›å…¥â€œå–Putâ€é€»è¾‘
            if stock_qty < 100 * self.contracts_to_trade:
                self.handle_sell_put_logic()
            # å¦åˆ™ï¼Œè¿›å…¥â€œå–Callâ€é€»è¾‘
            else:
                self.handle_sell_call_logic()

        except Exception as e:
            print("âŒ handle_data æ‰§è¡Œé”™è¯¯: {0}".format(str(e)))

    def handle_sell_put_logic(self):
        """å¤„ç†å–å‡ºçœ‹è·ŒæœŸæƒï¼ˆSell Putï¼‰çš„é€»è¾‘"""
        print("   - çŠ¶æ€: [å–å‡ºPut] - å½“å‰æ— è¶³å¤ŸæŒè‚¡ï¼Œå‡†å¤‡å¯»æ‰¾Putåˆçº¦ã€‚")

        if self.check_if_has_active_short_option():
            return

        target_put = option_screener(
            underlying_symbol=self.underlying_stock,
            option_type=OptionType.PUT,
            moneyness=Moneyness.OTM,
            time_to_exp_start=self.dte_min,
            time_to_exp_end=self.dte_max
        )

        if target_put is None:
            print("   - ç»“æœ: æœªæ‰¾åˆ°åœ¨ {0}-{1} å¤©å†…åˆ°æœŸçš„åˆé€‚Putåˆçº¦ã€‚".format(self.dte_min, self.dte_max))
            return

        actual_delta = option_delta(target_put)
        print("   - æ‰¾åˆ°å€™é€‰Put: {0}, Deltaä¸º {1:.4f}".format(target_put, actual_delta))
        
        if abs(actual_delta - self.target_delta_put) > 0.1:
            print("   - ç»“æœ: Delta ({0:.4f}) ä¸ç›®æ ‡ ({1}) ç›¸å·®è¿‡å¤§ï¼Œæœ¬è½®ä¸äº¤æ˜“ã€‚".format(actual_delta, self.target_delta_put))
            return

        self.place_short_option_order(target_put)

    def handle_sell_call_logic(self):
        """å¤„ç†å–å‡ºå¤‡å…‘çœ‹æ¶¨æœŸæƒï¼ˆSell Covered Callï¼‰çš„é€»è¾‘"""
        print("   - çŠ¶æ€: [å–å‡ºCall] - å·²æŒæœ‰è‚¡ç¥¨ï¼Œå‡†å¤‡å¯»æ‰¾Callåˆçº¦ã€‚")

        if self.check_if_has_active_short_option():
            return

        target_call = option_screener(
            underlying_symbol=self.underlying_stock,
            option_type=OptionType.CALL,
            moneyness=Moneyness.OTM,
            time_to_exp_start=self.dte_min,
            time_to_exp_end=self.dte_max
        )

        if target_call is None:
            print("   - ç»“æœ: æœªæ‰¾åˆ°åœ¨ {0}-{1} å¤©å†…åˆ°æœŸçš„åˆé€‚Callåˆçº¦ã€‚".format(self.dte_min, self.dte_max))
            return

        actual_delta = option_delta(target_call)
        print("   - æ‰¾åˆ°å€™é€‰Call: {0}, Deltaä¸º {1:.4f}".format(target_call, actual_delta))

        if abs(actual_delta - self.target_delta_call) > 0.1:
            print("   - ç»“æœ: Delta ({0:.4f}) ä¸ç›®æ ‡ ({1}) ç›¸å·®è¿‡å¤§ï¼Œæœ¬è½®ä¸äº¤æ˜“ã€‚".format(actual_delta, self.target_delta_call))
            return

        self.place_short_option_order(target_call)

    def place_short_option_order(self, option_contract):
        """æ‰§è¡Œå–å‡ºæœŸæƒçš„ä¸‹å•æ“ä½œ"""
        try:
            target_price = bid(option_contract, level=1)
            if target_price is None or target_price <= 0:
                print("   - é”™è¯¯: æ— æ³•è·å–åˆçº¦ {0} çš„æœ‰æ•ˆæŠ¥ä»·ã€‚".format(option_contract))
                return

            print("   - å‡†å¤‡ä¸‹å•: å–å‡º {0} @ ${1}".format(option_contract, target_price))
            
            # æ¨¡æ‹Ÿè¿è¡Œæ¨¡å¼æ£€æŸ¥
            if self.dry_run_mode:
                print("   - âš ï¸ [æ¨¡æ‹Ÿè¿è¡Œ] è®¢å•å·²æ¨¡æ‹Ÿæˆäº¤ã€‚è‹¥è¦å®ç›˜äº¤æ˜“ï¼Œè¯·åœ¨å‚æ•°ä¸­å…³é—­æ¨¡æ‹Ÿæ¨¡å¼ã€‚")
                self.active_option_contract = option_contract # æ¨¡æ‹ŸæŒä»“ï¼Œè®©ç­–ç•¥é€»è¾‘ç»§ç»­
                return # é€€å‡ºï¼Œä¸æ‰§è¡ŒçœŸå®ä¸‹å•

            # çœŸå®ä¸‹å•
            order_id = place_limit(
                symbol=option_contract,
                price=target_price,
                qty=self.contracts_to_trade,
                side=OrderSide.SELL,
                time_in_force=TimeInForce.DAY
            )

            if order_id:
                print("âœ… [å®ç›˜] ä¸‹å•æˆåŠŸ! åˆçº¦: {0}, æ•°é‡: {1}, ä»·æ ¼: ${2}, è®¢å•ID: {3}".format(
                    option_contract, self.contracts_to_trade, target_price, order_id))
                self.active_option_contract = option_contract
            else:
                print("âŒ [å®ç›˜] ä¸‹å•å¤±è´¥ï¼Œæœªè¿”å›è®¢å•IDã€‚")

        except Exception as e:
            print("âŒ place_short_option_order æ‰§è¡Œé”™è¯¯: {0}".format(str(e)))

    def check_if_has_active_short_option(self):
        """æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»æœ‰æ´»è·ƒçš„ç©ºå¤´æœŸæƒä»“ä½ï¼Œé˜²æ­¢é‡å¤å¼€ä»“"""
        if self.active_option_contract is not None:
            try:
                option_qty = position_holding_qty(self.active_option_contract)
                if option_qty < 0:
                    print("   - æç¤º: å·²æŒæœ‰æ´»è·ƒçš„ç©ºå¤´æœŸæƒä»“ä½ ({0})ï¼Œæœ¬è½®è·³è¿‡ã€‚".format(self.active_option_contract))
                    return True
                else:
                    self.active_option_contract = None
                    return False
            except Exception as e:
                print("   - è­¦å‘Š: æŸ¥è¯¢æ´»è·ƒæœŸæƒä»“ä½å¤±è´¥: {0}ã€‚ä¸ºå®‰å…¨èµ·è§ï¼Œæœ¬è½®è·³è¿‡ã€‚".format(e))
                return True
        return False
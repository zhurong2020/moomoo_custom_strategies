# MARA网格交易策略说明文档

## 1. 核心功能概述

这是一个基于网格交易法则的自动化交易策略，专门针对MARA Holdings (US.MARA)股票开发，主要特点包括：
- 基于2%网格间距动态创建交易网格
- 单网格交易量固定为20股，由最大总持仓(500股)限制控制
- 在美股常规交易时间（9:30-16:00 ET）运行
- 采用单个网格2%止盈策略
- 支持动态网格重置和持仓管理

## 2. 关键参数设置

### 策略参数
- `max_position`: 最大持仓限额，默认500股
- `grid_size`: 每次交易数量，默认20股
- `grid_height`: 网格间距，默认2%
- `profit_ratio`: 止盈比例，默认2%
- `min_reset_interval`: 最小网格重置间隔，默认6小时
- `order_timeout`: 订单超时时间，默认300秒

### 参数约束关系
1. 单次交易数量与最大持仓限额关系：
   ```
   grid_size * (预期最大建仓次数) ≤ max_position
   例如：20股 * 25次 ≤ 500股
   ```

2. 止盈比例与网格间距关系：
   ```
   profit_ratio ≤ grid_height
   例如：2% = 2%，确保在达到网格边界时可以止盈
   ```

## 3. 交易逻辑

### 3.1 网格管理
- 以当前价格为基准价格，设置基准网格
- 向上设置1个网格（+2%）
- 向下设置1个网格（-2%）
- 价格突破网格边界时触发重置
- 执行网格重置需满足最小间隔时间限制

### 3.2 建仓逻辑
1. 建仓条件：
   - 当前持仓未达到最大限额
   - 无进行中的买入订单
   - 价格位于有效交易区间
   
2. 执行建仓：
   - 使用限价单进行买入
   - 每次固定购买20股
   - 设置订单超时机制（300秒）
   - 记录买入价格、数量和时间戳

### 3.3 平仓逻辑
- 按单个网格计算盈利比例
- 当某网格盈利达到2%时触发平仓
- 多个网格同时满足条件时批量平仓
- 立即尝试在平仓价位重新建仓
- 保持交易连续性

## 4. 风险控制机制

### 4.1 订单管理
- 使用限价单控制成交价格
- 订单超时自动撤销（300秒）
- 详细记录订单状态变化
- 实现订单查询和监控
- 处理订单异常情况

### 4.2 持仓控制
- 严格执行最大持仓限制（500股）
- 实时跟踪各网格持仓
- 计算并更新持仓均价
- 定期输出持仓汇总信息
- 记录持仓变动历史

### 4.3 交易时间控制
- 仅在美股常规交易时间交易（9:30-16:00 ET）
- 每个交易日重置执行状态
- 网格重置时间间隔限制（6小时）
- 防止频繁交易的机制
- 支持节假日交易暂停

## 5. 数据分析和监控

### 5.1 性能指标
- 订单成功率统计
- 平均持仓时间分析
- 单笔交易盈亏统计
- 资金利用率计算
- 交易频率监控

### 5.2 风险指标
- 最大持仓比例
- 单笔交易规模
- 持仓集中度
- 交易成本分析
- 盈亏比统计

## 6. 系统实现特点

### 6.1 关键函数
- `initialize()`: 策略初始化
- `_update_grid()`: 网格更新管理
- `_check_grid_profit()`: 盈利检测
- `_place_buy_order()`: 买入订单管理
- `_process_executions()`: 订单执行处理
- `handle_data()`: 主要交易逻辑

### 6.2 异常处理
- 价格数据异常处理
- 订单执行异常处理
- 网络连接异常处理
- 持仓数据异常处理
- 系统重启恢复机制

## 7. 待优化方向

1. 引入止损机制
   - 设置单笔交易止损
   - 实现总体止损控制
   - 添加追踪止损功能

2. 开发自适应网格间距
   - 基于波动率动态调整
   - 考虑市场趋势影响
   - 优化网格重置时机

3. 优化网格重置条件
   - 加入趋势判断
   - 考虑成交量因素
   - 优化重置时间间隔

4. 加入技术指标辅助判断
   - MA指标支持
   - MACD信号
   - RSI超买超卖

5. 完善资金管理策略
   - 动态仓位控制
   - 资金利用率优化
   - 交易成本管理

6. 增加回撤控制机制
   - 设置最大回撤限制
   - 实现动态风险控制
   - 添加平仓保护机制
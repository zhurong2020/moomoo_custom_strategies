class Strategy(StrategyBase):
    """å…è´¹DCAå®šæŠ•ç­–ç•¥ - v2.2.5-Free-Public
    
    ä¸“ä¸ºè§£å†³Moomooç”¨æˆ·å®šæŠ•ç—›ç‚¹è®¾è®¡çš„å¼€æºå…è´¹ç­–ç•¥
    - å›ºå®šå‘¨æœŸæ™ºèƒ½å®šæŠ• (æ¯å‘¨)
    - åŸºç¡€å›æ’¤ç›‘æ§æé†’
    - å®Œå–„çš„é£é™©æ§åˆ¶ç³»ç»Ÿ
    - æ”¯æŒå›æµ‹å’Œå®ç›˜äº¤æ˜“
    
    [v2.2.5 æ ¸å¿ƒåŠŸèƒ½]
    âœ… æ¯å‘¨æ™ºèƒ½å®šæŠ•ï¼Œå¹³æ»‘å¸‚åœºæ³¢åŠ¨
    âœ… åŸºç¡€é£é™©ç›‘æ§ï¼ŒåŠæ—¶æé†’ç”¨æˆ·
    âœ… å®Œå–„å¼‚å¸¸å¤„ç†ï¼Œç¨³å®šå¯é è¿è¡Œ
    âœ… å¤šç§é¢„è®¾æ¨¡æ¿ï¼Œé€‚åˆä¸åŒé£é™©åå¥½
    âœ… å®Œå…¨å¼€æºï¼Œç¤¾åŒºæ”¯æŒ
    
    ğŸ’¡ ä»˜è´¹ç‰ˆ(Â¥35/æœˆ)é¢å¤–åŠŸèƒ½:
    - æ¯æ—¥å®šæŠ• (+4.1%å¹´åŒ–æ”¶ç›Šä¼˜åŠ¿)
    - 2å±‚æ™ºèƒ½åŠ ä»“ç³»ç»Ÿ(10%/20%â†’1.5x/2x)
    - è‡ªå®šä¹‰èµ„é‡‘å’ŒæŠ•èµ„å‘¨æœŸé…ç½®
    - æç«¯å›æ’¤ä¿æŠ¤å’Œä¸ªæ€§åŒ–å‚æ•°
    - ä¸“å±å®¢æœå’ŒæŠ€æœ¯æ”¯æŒ
    
    ğŸš€ Appå®Œæ•´ç‰ˆ(Â¥500/å¹´)é¡¶çº§åŠŸèƒ½:
    - 8å±‚å®Œæ•´å›æ’¤ç³»ç»Ÿ(2%-50%)
    - å¤šæ ‡çš„ç»„åˆæŠ•èµ„
    - æˆæœ¬å®šæŠ•ç®—æ³•(æ³¢åŠ¨ç‡è‡ªé€‚åº”)
    - å®æ—¶ç­–ç•¥è°ƒæ•´å’Œä¸“ä¸šæŠ¥å‘Š
    """

    def initialize(self):
        """åˆå§‹åŒ–ç­–ç•¥"""
        try:
            self._version = "v2.2.5-Free-Public"
            self._tier = "å…è´¹å¼€æºç‰ˆ"
            self._description = (
                "ğŸ†“ å…è´¹DCAå®šæŠ•ç­–ç•¥ - å¼€æºç¨³å®šç‰ˆ\n"
                "âœ… æ¯å‘¨æ™ºèƒ½å®šæŠ•ï¼Œå¹³æ»‘å¸‚åœºæ³¢åŠ¨\n" 
                "âœ… åŸºç¡€é£é™©ç›‘æ§ï¼ŒåŠæ—¶æé†’ç”¨æˆ·\n"
                "âœ… å®Œå–„å¼‚å¸¸å¤„ç†ï¼Œç¨³å®šå¯é è¿è¡Œ\n"
                "âœ… å¤šç§é¢„è®¾æ¨¡æ¿ï¼Œé€‚åˆä¸åŒé£é™©åå¥½\n"
                "âœ… å®Œå…¨å¼€æºï¼Œç¤¾åŒºæ”¯æŒå’Œåé¦ˆ\n"
                "ğŸ’¡ ä»˜è´¹ç‰ˆè§£é”æ¯æ—¥å®šæŠ•å’Œ2å±‚æ™ºèƒ½åŠ ä»“åŠŸèƒ½"
            )
            
            print(f"ğŸš€ å¼€å§‹åˆå§‹åŒ– {self._version}")
            
            # é¦–å…ˆè®¾ç½®æ ¸å¿ƒçŠ¶æ€å˜é‡
            self.last_investment_time = None
            self.highest_price = None
            self.last_valid_price = 100.0  # é»˜è®¤ä»·æ ¼
            self.strategy_start_price = None  # ç­–ç•¥å¯åŠ¨ä»·æ ¼
            self.investment_count = 0  # æŠ•èµ„æ¬¡æ•°è®¡æ•°
            
            # å›æµ‹æ”¯æŒå˜é‡åˆå§‹åŒ–
            import collections
            self.high_queue = collections.deque(maxlen=20)
            self._position = 0
            self._total_cost = 0.0
            self.virtual_balance = None  # å…ˆåˆå§‹åŒ–ä¸ºNone
            
            # ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ç»„ä»¶åˆå§‹åŒ–
            print("ğŸ“ ç¬¬ä¸€é˜¶æ®µ: åŸºç¡€ç»„ä»¶åˆå§‹åŒ–")
            self.trigger_symbols()
            self.custom_indicator()
            
            # ç¬¬äºŒé˜¶æ®µï¼šç”¨æˆ·å‚æ•°è®¾ç½®
            print("ğŸ“ ç¬¬äºŒé˜¶æ®µ: å…è´¹ç‰ˆå‚æ•°è®¾ç½®")
            self.global_variables()
            
            # ç¬¬ä¸‰é˜¶æ®µï¼šé¢„è®¾é…ç½®åº”ç”¨
            print("ğŸ“ ç¬¬ä¸‰é˜¶æ®µ: é¢„è®¾é…ç½®åº”ç”¨")
            self.setup_presets()
            
            # ç¬¬å››é˜¶æ®µï¼šæœ€ç»ˆéªŒè¯å’Œå…œåº•è®¾ç½®
            print("ğŸ“ ç¬¬å››é˜¶æ®µ: æœ€ç»ˆéªŒè¯å’Œå…œåº•è®¾ç½®")
            self.setup_free_features()
            
            # æœ€åç¡®ä¿è™šæ‹Ÿä½™é¢å·²æ­£ç¡®è®¾ç½®
            if self.backtest:
                if not hasattr(self, 'initial_balance') or self.initial_balance is None:
                    try:
                        self.initial_balance = total_cash(currency=Currency.USD)
                        if self.initial_balance is None or self.initial_balance <= 0:
                            self.initial_balance = 10000.0  # å…è´¹ç‰ˆé»˜è®¤1ä¸‡
                    except:
                        self.initial_balance = 10000.0
                        print("âš ï¸ åˆå§‹åŒ–ï¼šæ— æ³•è·å–è´¦æˆ·ä½™é¢ï¼Œä½¿ç”¨å…è´¹ç‰ˆé»˜è®¤$10,000")
                        
                if not hasattr(self, 'virtual_balance') or self.virtual_balance is None:
                    self.virtual_balance = self.initial_balance
                    
            print(f"âœ… åˆå§‹åŒ–å®Œæˆï¼šè™šæ‹Ÿä½™é¢=${getattr(self, 'virtual_balance', 0):,.0f}")
            
            # è¯¦ç»†çš„åˆå§‹åŒ–çŠ¶æ€æ—¥å¿—
            self.print_initialization_status()
            self.print_welcome()
            
        except Exception as e:
            print(f"âŒ åˆå§‹åŒ–å¤±è´¥: {str(e)}")
            import traceback
            print(f"è¯¦ç»†é”™è¯¯: {traceback.format_exc()}")

    def trigger_symbols(self):
        """è®¾ç½®äº¤æ˜“æ ‡çš„"""
        try:
            self.stock = declare_trig_symbol()
            print(f"ğŸ“ˆ äº¤æ˜“æ ‡çš„: {self.stock}")
        except Exception as e:
            print(f"âŒ æ ‡çš„è®¾ç½®å¤±è´¥: {str(e)}")

    def custom_indicator(self):
        """æ³¨å†Œè‡ªå®šä¹‰æŠ€æœ¯æŒ‡æ ‡"""
        try:
            # æ³¨å†Œä¸€ä¸ªç®€å•çš„ç§»åŠ¨å¹³å‡çº¿æŒ‡æ ‡ä¾›å‚è€ƒ
            self.register_indicator(
                indicator_name='MA',
                script='MA5:MA(CLOSE,5),COLORFF8D1E;',
                param_list=[]
            )
            print("ğŸ“Š æŠ€æœ¯æŒ‡æ ‡æ³¨å†Œå®Œæˆ")
        except Exception as e:
            print(f"âŒ æŠ€æœ¯æŒ‡æ ‡æ³¨å†Œå¤±è´¥: {str(e)}")

    def global_variables(self):
        """å…¨å±€å˜é‡è®¾ç½® - å…è´¹ç‰ˆ"""
        try:
            # === å…è´¹ç‰ˆåŸºç¡€å‚æ•° (ç”¨æˆ·å¯é…ç½®) ===
            self.qty = show_variable(20, GlobalType.INT)  # æ¯æ¬¡å®šæŠ•è‚¡æ•°
            self.preset_mode = show_variable(2, GlobalType.INT)  # 1=ä¿å®ˆ 2=å¹³è¡¡ 3=ç§¯æ
            self.backtest = show_variable(True, GlobalType.BOOL)  # å›æµ‹æ¨¡å¼
            
            # === å…è´¹ç‰ˆå›ºåŒ–å‚æ•° (ä¸å¯ä¿®æ”¹) ===
            self.version_tier = 1  # å›ºåŒ–ä¸ºå…è´¹ç‰ˆ
            self.interval_min = 10080  # å›ºå®šæ¯å‘¨å®šæŠ• (7å¤© * 24å°æ—¶ * 60åˆ†é’Ÿ)
            self.interval_desc = "æ¯å‘¨å®šæŠ• (å…è´¹ç‰ˆå›ºå®š)"
            self.log_level = 0  # ç®€åŒ–æ—¥å¿—
            
            # éªŒè¯å’Œä¿®æ­£ç”¨æˆ·è¾“å…¥å‚æ•°
            self.qty = self._validate_free_qty(self.qty)
            
            print(f"âš™ï¸ å…è´¹ç‰ˆå‚æ•°é…ç½®å®Œæˆ")
            print(f"ğŸ” å½“å‰å‚æ•°è®¾ç½®:")
            print(f"   å®šæŠ•æ•°é‡: {self.qty}è‚¡ (é™åˆ¶: 10-100è‚¡ï¼Œ10çš„å€æ•°)")
            print(f"   æŠ•èµ„å‘¨æœŸ: {self.interval_desc}")
            print(f"   é¢„è®¾æ¨¡å¼: {self.preset_mode} (1=ä¿å®ˆ 2=å¹³è¡¡ 3=ç§¯æ)")
            
        except Exception as e:
            print(f"âŒ å‚æ•°è®¾ç½®å¤±è´¥: {str(e)}")
            import traceback
            print(f"è¯¦ç»†é”™è¯¯: {traceback.format_exc()}")

    def _validate_free_qty(self, qty):
        """éªŒè¯å’Œä¿®æ­£å…è´¹ç‰ˆæŠ•èµ„æ•°é‡"""
        try:
            # å…è´¹ç‰ˆé™åˆ¶ï¼š10-100è‚¡ï¼Œå¿…é¡»æ˜¯10çš„å€æ•°
            if qty < 10:
                print(f"âš ï¸ æŠ•èµ„æ•°é‡è¿‡å° ({qty}è‚¡)ï¼Œè°ƒæ•´ä¸ºæœ€å°å€¼10è‚¡")
                return 10
            elif qty > 100:
                print(f"âš ï¸ æŠ•èµ„æ•°é‡è¿‡å¤§ ({qty}è‚¡)ï¼Œè°ƒæ•´ä¸ºæœ€å¤§å€¼100è‚¡")
                print(f"ğŸ’¡ ä»˜è´¹ç‰ˆæ”¯æŒæ›´å¤§æŠ•èµ„æ•°é‡(1-200è‚¡)ï¼Œè”ç³»å‡çº§è·å–æ›´å¤šåŠŸèƒ½")
                return 100
            elif qty % 10 != 0:
                # è°ƒæ•´åˆ°æœ€æ¥è¿‘çš„10çš„å€æ•°
                adjusted = (qty // 10) * 10
                if adjusted < 10:
                    adjusted = 10
                print(f"âš ï¸ æŠ•èµ„æ•°é‡å¿…é¡»ä¸º10çš„å€æ•°ï¼Œ{qty}è‚¡è°ƒæ•´ä¸º{adjusted}è‚¡")
                print(f"ğŸ’¡ ä»˜è´¹ç‰ˆæ”¯æŒä»»æ„æ•°é‡é…ç½®ï¼Œè”ç³»å‡çº§è·å–æ›´å¤šçµæ´»æ€§")
                return adjusted
            else:
                return qty
        except:
            print(f"âš ï¸ æŠ•èµ„æ•°é‡éªŒè¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼20è‚¡")
            return 20

    def setup_presets(self):
        """è®¾ç½®é¢„è®¾æ¨¡æ¿"""
        try:
            print(f"ğŸ¨ å¼€å§‹åº”ç”¨é¢„è®¾é…ç½®: preset_mode={getattr(self, 'preset_mode', 'None')}")
            
            presets = {
                1: {  # ä¿å®ˆå‹
                    "name": "ä¿å®ˆå‹",
                    "description": "ä½é£é™©ï¼Œé€‚åˆç¨³å¥æŠ•èµ„è€…",
                    "base_qty": 10,
                    "risk_level": "ä½"
                },
                2: {  # å¹³è¡¡å‹  
                    "name": "å¹³è¡¡å‹",
                    "description": "ä¸­ç­‰é£é™©æ”¶ç›Šï¼Œé€‚åˆå¤§å¤šæ•°ç”¨æˆ·", 
                    "base_qty": None,  # ä½¿ç”¨ç”¨æˆ·è¾“å…¥å€¼
                    "risk_level": "ä¸­"
                },
                3: {  # ç§¯æå‹
                    "name": "ç§¯æå‹", 
                    "description": "ç›¸å¯¹ç§¯æï¼Œé€‚åˆé£é™©æ‰¿å—èƒ½åŠ›è¾ƒå¼ºçš„ç”¨æˆ·",
                    "base_qty": 50,
                    "risk_level": "ä¸­é«˜"
                }
            }
            
            if self.preset_mode in presets:
                preset = presets[self.preset_mode]
                self.preset_name = preset["name"]
                self.preset_desc = preset["description"] 
                self.risk_level = preset["risk_level"]
                
                # åº”ç”¨é¢„è®¾æ•°é‡ï¼ˆä»…åœ¨é¢„è®¾æœ‰ç‰¹å®šå€¼ä¸”ç”¨æˆ·ä½¿ç”¨é»˜è®¤å€¼æ—¶ï¼‰
                if preset["base_qty"] is not None and self.qty == 20:  # é»˜è®¤å€¼20
                    # å…è´¹ç‰ˆä»éœ€è¦éµå¾ªæ•°é‡é™åˆ¶
                    suggested_qty = self._validate_free_qty(preset["base_qty"])
                    print(f"ğŸ“¦ åº”ç”¨é¢„è®¾æ•°é‡: {self.qty} -> {suggested_qty}")
                    self.qty = suggested_qty
                else:
                    print(f"ğŸ“¦ ä¿æŒç”¨æˆ·æ•°é‡è®¾ç½®: {self.qty}")
                    
            else:
                self.preset_name = "è‡ªå®šä¹‰"
                self.preset_desc = "ç”¨æˆ·è‡ªå®šä¹‰å‚æ•°"
                self.risk_level = "æœªçŸ¥"
                
            print(f"ğŸ¨ é¢„è®¾é…ç½®å®Œæˆ: {self.preset_name} - æ•°é‡: {self.qty}è‚¡")
            
        except Exception as e:
            print(f"âŒ é¢„è®¾é…ç½®å¤±è´¥: {str(e)}")
            # è®¾ç½®é»˜è®¤å€¼
            self.preset_name = "é»˜è®¤"
            self.preset_desc = "ç³»ç»Ÿé»˜è®¤é…ç½®"
            self.risk_level = "ä¸­"

    def setup_free_features(self):
        """è®¾ç½®å…è´¹ç‰ˆå›ºåŒ–åŠŸèƒ½ç‰¹æ€§"""
        try:
            print(f"ğŸ†“ è®¾ç½®å…è´¹ç‰ˆåŠŸèƒ½ç‰¹æ€§")
            
            # å…è´¹ç‰ˆå›ºåŒ–è®¾ç½®
            self.version_tier = 1  # ç¡®ä¿å›ºåŒ–ä¸ºå…è´¹ç‰ˆ
            self.interval_min = 10080  # å›ºå®šæ¯å‘¨å®šæŠ•
            self.interval_desc = "æ¯å‘¨å®šæŠ• (å…è´¹ç‰ˆå›ºå®š)"
            
            # å…è´¹ç‰ˆä¸åŒ…å«æ™ºèƒ½åŠ ä»“åŠŸèƒ½
            # è¿™é‡Œä¸è®¾ç½® drawdown_layers ç­‰åŠ ä»“ç›¸å…³å‚æ•°
            
            print(f"ğŸ“… æŠ•èµ„å‘¨æœŸ: {self.interval_desc}")
            print(f"ğŸ›ï¸ ç‰ˆæœ¬å±‚çº§: {self.version_tier} (å…è´¹ç‰ˆ)")
            
        except Exception as e:
            import traceback
            print(f"âŒ å…è´¹ç‰ˆåŠŸèƒ½è®¾ç½®å¤±è´¥: {str(e)}")
            print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
            # å›é€€åˆ°é»˜è®¤è®¾ç½®
            self.version_tier = 1
            self.interval_min = 10080
            self.interval_desc = "æ¯å‘¨å®šæŠ• (å¼‚å¸¸å›é€€)"

    def print_initialization_status(self):
        """æ‰“å°è¯¦ç»†çš„åˆå§‹åŒ–çŠ¶æ€ - ç”¨äºè°ƒè¯•"""
        print(f"\nğŸ” åˆå§‹åŒ–çŠ¶æ€è¯¦æƒ… - {self._version}")
        print("=" * 50)
        print(f"ğŸ“Š ç‰ˆæœ¬ä¿¡æ¯: {self._tier}")
        print(f"ğŸ“ˆ äº¤æ˜“æ ‡çš„: {getattr(self, 'stock', 'Unknown')}")
        print(f"ğŸ›ï¸ ç‰ˆæœ¬å±‚çº§: {getattr(self, 'version_tier', 'Unknown')} (å…è´¹ç‰ˆ)")
        print(f"ğŸ’° è™šæ‹Ÿä½™é¢: ${getattr(self, 'virtual_balance', 0):,.2f}")
        print(f"ğŸ“… æŠ•èµ„å‘¨æœŸ: {getattr(self, 'interval_min', 0)}åˆ†é’Ÿ")
        print(f"ğŸ“¦ å®šæŠ•æ•°é‡: {getattr(self, 'qty', 0)}è‚¡")
        print(f"ğŸ”§ å›æµ‹æ¨¡å¼: {getattr(self, 'backtest', False)}")
        
        # æ£€æŸ¥å…³é”®å±æ€§
        critical_attrs = ['interval_min', 'virtual_balance', 'qty', 'version_tier']
        missing_attrs = []
        for attr in critical_attrs:
            if not hasattr(self, attr) or getattr(self, attr) is None:
                missing_attrs.append(attr)
        
        if missing_attrs:
            print(f"âš ï¸ ç¼ºå¤±å±æ€§: {missing_attrs}")
        else:
            print(f"âœ… æ‰€æœ‰å…³é”®å±æ€§å·²åˆå§‹åŒ–")
        print("=" * 50)

    def print_welcome(self):
        """æ‰“å°æ¬¢è¿ä¿¡æ¯ - å…è´¹ç‰ˆä¸“ç”¨"""        
        print("\n" + "="*60)
        print(f"ğŸš€ DCAæ™ºèƒ½å®šæŠ•ç­–ç•¥ {self._version}")
        print("="*60)
        print(f"ğŸ†“ å½“å‰ç‰ˆæœ¬: å…è´¹å¼€æºç‰ˆ")
        print(f"âœ¨ æ ¸å¿ƒåŠŸèƒ½: å›ºå®šå‘¨æœŸæ™ºèƒ½å®šæŠ•")
        
        print("\nğŸ†“ å…è´¹ç‰ˆåŠŸèƒ½:")
        print("   âœ… æ¯å‘¨æ™ºèƒ½å®šæŠ•ï¼Œå¹³æ»‘å¸‚åœºæ³¢åŠ¨")
        print("   âœ… åŸºç¡€å›æ’¤ç›‘æ§æé†’")
        print("   âœ… é£é™©ä¿æŠ¤ç³»ç»Ÿ")
        print("   âœ… æŠ•èµ„è®°å½•ç»Ÿè®¡")
        print("   âœ… å¤šç§é¢„è®¾æ¨¡æ¿")
        print("   âœ… å®Œå…¨å¼€æºï¼Œç¤¾åŒºæ”¯æŒ")
            
        print("\nğŸ“Š å½“å‰é…ç½®:")
        print(f"   ç‰ˆæœ¬ç­‰çº§: {self.version_tier} (å…è´¹ç‰ˆ)")
        print(f"   æŠ•èµ„æ¨¡æ¿: {self.preset_name} ({self.preset_desc})")
        print(f"   é£é™©ç­‰çº§: {self.risk_level}")
        print(f"   å®šæŠ•æ•°é‡: {self.qty}è‚¡ (é™åˆ¶: 10-100è‚¡ï¼Œ10çš„å€æ•°)")
        print(f"   æŠ•èµ„å‘¨æœŸ: {getattr(self, 'interval_desc', 'æ¯å‘¨')}")
        if hasattr(self, 'virtual_balance'):
            print(f"   åˆå§‹èµ„é‡‘: ${self.virtual_balance:,.0f}")
        print(f"   è¿è¡Œæ¨¡å¼: {'å›æµ‹' if self.backtest else 'å®ç›˜'}")
        
        print("\nğŸ¯ å‡çº§è·å¾—æ›´å¤šåŠŸèƒ½:")
        print("   ğŸ’ ä»˜è´¹ç‰ˆ(Â¥35/æœˆ):")
        print("     - æ¯æ—¥å®šæŠ• (+4.1%å¹´åŒ–æ”¶ç›Šä¼˜åŠ¿)")
        print("     - 2å±‚æ™ºèƒ½åŠ ä»“ç³»ç»Ÿ(10%/20%â†’1.5x/2x)")
        print("     - è‡ªå®šä¹‰æŠ•èµ„æ•°é‡(1-200è‚¡)")
        print("     - è‡ªå®šä¹‰èµ„é‡‘é…ç½®(10K-500K)")
        print("     - ä¸“å±æŠ€æœ¯æ”¯æŒ")
        print("   ğŸš€ Appå®Œæ•´ç‰ˆ(Â¥500/å¹´):")
        print("     - 8å±‚å®Œæ•´å›æ’¤ç³»ç»Ÿ")
        print("     - å¤šæ ‡çš„ç»„åˆæŠ•èµ„")
        print("     - æˆæœ¬å®šæŠ•ç®—æ³•")
        print("     - å®æ—¶ç­–ç•¥è°ƒæ•´")
        
        print("\nğŸ“ è”ç³»æ–¹å¼:")
        print("   ğŸ”— GitHub: https://github.com/ä½ çš„ç”¨æˆ·å/moomoo_custom_strategies")
        print("   ğŸ“§ é‚®ç®±: your_email@example.com")
        print("   ğŸ’¬ å¾®ä¿¡: [ä½ çš„å¾®ä¿¡å·]")
        
        print("="*60 + "\n")

    def handle_data(self):
        """ä¸»è¦äº¤æ˜“é€»è¾‘ - å…è´¹ç‰ˆ"""
        try:
            current_time = device_time(TimeZone.DEVICE_TIME_ZONE)
            latest_price, highest_price, account_balance = self.get_market_data()
            
            # è®¡ç®—å›æ’¤ (ä»…ç”¨äºæ˜¾ç¤ºï¼Œä¸è§¦å‘åŠ ä»“)
            drawdown = self.calculate_drawdown(latest_price)
            position = self.get_position()
            
            if self.log_level >= 1:
                print(f"ğŸ“Š ä»·æ ¼={latest_price:.2f}, å›æ’¤={drawdown:.2f}%, æŒä»“={position}")

            # å…è´¹ç‰ˆç­–ç•¥é€»è¾‘
            self.free_version_logic(current_time, latest_price, account_balance, drawdown)

        except Exception as e:
            import traceback
            error_msg = str(e) if str(e) else "æœªçŸ¥é”™è¯¯"
            print(f"âŒ ç­–ç•¥æ‰§è¡Œé”™è¯¯: {error_msg}")
            print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")

    def get_market_data(self):
        """è·å–å¸‚åœºæ•°æ®"""
        if self.backtest:
            # å›æµ‹æ¨¡å¼
            try:
                if not hasattr(self, 'bar_index'):
                    self.bar_index = 0
                self.bar_index += 1
                
                latest_price = bar_close(self.stock, bar_type=BarType.D1, select=1)
                if latest_price is None or latest_price <= 0:
                    print(f"âš ï¸ è·å–ä»·æ ¼å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä»·æ ¼")
                    latest_price = 100.0  # é»˜è®¤ä»·æ ¼
                
                # è®°å½•æœ‰æ•ˆä»·æ ¼ä¾›åç»­ä½¿ç”¨
                if latest_price > 0:
                    self.last_valid_price = latest_price
                
                self.high_queue.append(latest_price)
                
                # ä½¿ç”¨æ¡ä»¶åˆ¤æ–­æ›¿ä»£min()å‡½æ•°
                available_days = self.bar_index if self.bar_index < 20 else 20
                high_list = list(self.high_queue)[-available_days:]
                if len(high_list) == 0:
                    highest_price = latest_price
                elif len(high_list) == 1:
                    highest_price = high_list[0]
                else:
                    # æ‰¾å‡ºæœ€é«˜ä»·
                    highest_price = high_list[0]
                    for price in high_list[1:]:
                        if price > highest_price:
                            highest_price = price
                
                account_balance = self.virtual_balance
                return latest_price, highest_price, account_balance
            except Exception as e:
                print(f"å›æµ‹æ•°æ®è·å–é”™è¯¯: {str(e)}")
                # è¿”å›é»˜è®¤å€¼é¿å…ç­–ç•¥å´©æºƒ
                default_balance = getattr(self, 'virtual_balance', 10000.0) or 10000.0
                return self.last_valid_price, self.last_valid_price, default_balance
        else:
            # å®ç›˜æ¨¡å¼
            latest_price = current_price(self.stock, price_type=THType.FTH)
            if latest_price is None or latest_price <= 0:
                latest_price = self.last_valid_price
            else:
                self.last_valid_price = latest_price
            
            high_list = [bar_high(self.stock, bar_type=BarType.D1, select=i) for i in range(1, 21)]
            # å¤„ç†å¯èƒ½çš„Noneå€¼å¹¶æ‰¾å‡ºæœ€å¤§å€¼
            valid_highs = [h for h in high_list if h is not None and h > 0]
            if len(valid_highs) == 0:
                highest_price = latest_price
            elif len(valid_highs) == 1:
                highest_price = valid_highs[0]
            else:
                highest_price = valid_highs[0]
                for price in valid_highs[1:]:
                    if price > highest_price:
                        highest_price = price
            
            account_balance = total_cash(currency=Currency.USD)
            return latest_price, highest_price, account_balance

    def calculate_drawdown(self, latest_price):
        """è®¡ç®—å›æ’¤å¹…åº¦ - ä»…ç”¨äºæ˜¾ç¤º"""
        # åˆå§‹åŒ–ç­–ç•¥å¯åŠ¨ä»·æ ¼å’Œæœ€é«˜ä»·
        if self.strategy_start_price is None:
            self.strategy_start_price = latest_price
            self.highest_price = latest_price
            return 0.0
            
        # æ›´æ–°æœ€é«˜ä»·ï¼ˆåªèƒ½ä¸Šå‡ï¼Œä¸èƒ½ä¸‹é™ï¼‰
        if latest_price > self.highest_price:
            self.highest_price = latest_price
        
        # è®¡ç®—å½“å‰å›æ’¤
        if self.highest_price > 0:
            drawdown = (self.highest_price - latest_price) / self.highest_price * 100
        else:
            drawdown = 0.0
            
        return drawdown

    def should_invest(self, current_time):
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥å®šæŠ•"""
        if self.last_investment_time is None:
            return True
        elapsed = (current_time - self.last_investment_time).total_seconds() / 60
        return elapsed >= self.interval_min

    def free_version_logic(self, current_time, latest_price, account_balance, drawdown):
        """å…è´¹ç‰ˆç­–ç•¥é€»è¾‘ - åŸºç¡€å®šæŠ• + å‡çº§å¼•å¯¼"""
        
        # å‡çº§ä»·å€¼å±•ç¤º - åœ¨å…³é”®æ—¶åˆ»æç¤º
        self.show_upgrade_hints(drawdown)
        
        # åŸºç¡€å®šæŠ•é€»è¾‘
        if self.should_invest(current_time):
            self.execute_investment(latest_price, account_balance, self.qty, "å…è´¹ç‰ˆå®šæŠ•")
            self.investment_count += 1
            
            # å®šæœŸæ˜¾ç¤ºç‰ˆæœ¬å¯¹æ¯”
            if self.investment_count % 5 == 0:  # æ¯5æ¬¡æŠ•èµ„æç¤ºä¸€æ¬¡
                self.show_periodic_upgrade_hint()

    def show_upgrade_hints(self, drawdown):
        """æ˜¾ç¤ºå‡çº§ä»·å€¼æç¤º"""
        # å›æ’¤æ—¶æ˜¾ç¤ºä»˜è´¹ç‰ˆä»·å€¼
        if drawdown >= 10.0:
            print(f"ğŸ’¡ ä»˜è´¹ç‰ˆç”¨æˆ·æ­¤æ—¶ä¼šè§¦å‘æ™ºèƒ½åŠ ä»“1.5å€ï¼Œé™ä½å¹³å‡æˆæœ¬")
            print(f"ğŸ“ è”ç³»è·å–ä»˜è´¹ç‰ˆæˆæƒç (Â¥35/æœˆ)è§£é”2å±‚æ™ºèƒ½åŠ ä»“")
        elif drawdown >= 20.0:
            print(f"ğŸš€ ä»˜è´¹ç‰ˆ2å±‚åŠ ä»“ç³»ç»Ÿæ­¤æ—¶è§¦å‘2å€æŠ•èµ„ï¼Œå¿«é€Ÿæ‘Šè–„æˆæœ¬")
            print(f"ğŸ’° å†å²æ•°æ®æ˜¾ç¤ºï¼šä»˜è´¹ç‰ˆåœ¨å¤§å›æ’¤æ—¶èƒ½èŠ‚çœ15-25%å¹³å‡æˆæœ¬")

    def show_periodic_upgrade_hint(self):
        """å®šæœŸæ˜¾ç¤ºç‰ˆæœ¬å¯¹æ¯”æç¤º"""
        print(f"\nğŸ“Š æŠ•èµ„è¿›åº¦: å·²å®Œæˆ{self.investment_count}æ¬¡å®šæŠ•")
        print(f"ğŸ’¡ ç‰ˆæœ¬å¯¹æ¯”æé†’:")
        print(f"   å…è´¹ç‰ˆ: æ¯å‘¨å®šæŠ•ï¼Œé€‚åˆé•¿æœŸä½“éªŒ")  
        print(f"   ä»˜è´¹ç‰ˆ: æ¯æ—¥å®šæŠ•+æ™ºèƒ½åŠ ä»“ï¼Œ+4.1%å¹´åŒ–æ”¶ç›Š")
        print(f"   Appç‰ˆ: 8å±‚å®Œæ•´ç³»ç»Ÿï¼Œ+12%å¹´åŒ–æ”¶ç›Š")
        print(f"ğŸ“ å‡çº§å’¨è¯¢: å¾®ä¿¡ [ä½ çš„å¾®ä¿¡å·] | é‚®ç®± your_email@example.com\n")

    def execute_investment(self, latest_price, account_balance, quantity, trade_type="å®šæŠ•"):
        """æ‰§è¡ŒæŠ•èµ„"""
        
        # å…è´¹ç‰ˆå‚æ•°æ£€æŸ¥å’Œé™åˆ¶
        quantity = self._validate_free_qty(quantity)

        if self.backtest:
            # å›æµ‹æ¨¡å¼ - ä½¿ç”¨place_marketäº§ç”ŸGUIäº¤æ˜“æ‰“ç‚¹
            required_cash = quantity * latest_price
            
            # ç¡®ä¿virtual_balanceä¸ä¸ºNone
            if self.virtual_balance is None:
                self.virtual_balance = 10000.0
                print(f"âš ï¸ è™šæ‹Ÿä½™é¢ä¸ºNoneï¼Œè®¾ç½®å…è´¹ç‰ˆé»˜è®¤å€¼${self.virtual_balance:,.0f}")
            
            if required_cash > self.virtual_balance:
                # èµ„é‡‘ä¸è¶³ï¼Œè‡ªåŠ¨è°ƒæ•´æŠ•èµ„æ•°é‡
                original_qty = quantity
                max_qty = int(self.virtual_balance // latest_price)
                # å…è´¹ç‰ˆå¿…é¡»æ˜¯10çš„å€æ•°
                max_qty = (max_qty // 10) * 10
                if max_qty < 10:
                    print(f"ğŸ’° è™šæ‹Ÿä½™é¢ä¸è¶³ï¼Œæ— æ³•è´­ä¹°æœ€å°‘10è‚¡: éœ€è¦${required_cash:.2f}, å¯ç”¨${self.virtual_balance:.2f}")
                    return
                quantity = max_qty
                required_cash = quantity * latest_price
                print(f"âš ï¸ èµ„é‡‘è°ƒæ•´: åŸè®¡åˆ’ä¹°{original_qty}è‚¡ï¼Œè°ƒæ•´ä¸º{quantity}è‚¡")
            
            if quantity < 10:
                print(f"ğŸ’° è°ƒæ•´åæ•°é‡ä¸è¶³10è‚¡(å…è´¹ç‰ˆæœ€ä½è¦æ±‚)ï¼Œè·³è¿‡æœ¬æ¬¡æŠ•èµ„")
                return

            # è°ƒç”¨place_marketæ¨¡æ‹Ÿä¸‹å•ï¼Œäº§ç”ŸGUIäº¤æ˜“æ‰“ç‚¹
            order_id = place_market(self.stock, quantity, OrderSide.BUY, TimeInForce.DAY)
            
            # ç®€åŒ–æ—¥å¿—è¾“å‡º
            print(f"ğŸ“Š {trade_type}: {quantity}è‚¡ @ ${latest_price:.2f}")
            
            # æ›´æ–°è™šæ‹Ÿè´¦æˆ·
            self.virtual_balance -= required_cash
            self._total_cost += required_cash
            self._position += quantity
            
            print(f"ğŸ’° ä½™é¢: ${self.virtual_balance:.2f} | æŒä»“: {self._position}è‚¡")
            
        else:
            # å®ç›˜æ¨¡å¼
            required_cash = quantity * latest_price
            if required_cash > account_balance:
                # èµ„é‡‘ä¸è¶³ï¼ŒæŒ‰å¯ç”¨èµ„é‡‘è°ƒæ•´æ•°é‡ï¼Œä¿æŒ10çš„å€æ•°
                max_qty = int((account_balance // latest_price) // 10) * 10
                if max_qty < 10:
                    print(f"ğŸ’° èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•æŠ•èµ„æœ€å°‘10è‚¡")
                    return
                quantity = max_qty
                print(f"âš ï¸ èµ„é‡‘è°ƒæ•´: æŠ•èµ„æ•°é‡è°ƒæ•´ä¸º {quantity}è‚¡")

            try:
                # ä½¿ç”¨å¸‚ä»·ä¹°å…¥ç¡®ä¿æˆäº¤
                order_id = place_market(self.stock, quantity, OrderSide.BUY, TimeInForce.DAY)
                print(f"âœ… {trade_type}è®¢å•: {quantity}è‚¡ @ å¸‚ä»·, è®¢å•å·: {order_id}")
            except Exception as e:
                print(f"âŒ ä¸‹å•å¤±è´¥: {str(e)}")
                return

        self.last_investment_time = device_time(TimeZone.DEVICE_TIME_ZONE)

    def get_position(self):
        """è·å–æŒä»“æ•°é‡"""
        if self.backtest:
            return self._position
        try:
            return position_holding_qty(self.stock)
        except:
            return 0

    def get_total_cost(self):
        """è·å–æ€»æˆæœ¬"""
        if self.backtest:
            return self._total_cost
        try:
            pos = position_holding_qty(self.stock)
            avg_cost = position_cost(self.stock, cost_price_model=CostPriceModel.AVG)
            return pos * avg_cost
        except:
            return 0.0

    def get_avg_cost(self):
        """è·å–å¹³å‡æˆæœ¬"""
        if self.backtest:
            return self._total_cost / self._position if self._position > 0 else 0.0
        try:
            return position_cost(self.stock, cost_price_model=CostPriceModel.AVG)
        except:
            return 0.0
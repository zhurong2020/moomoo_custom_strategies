class Strategy(StrategyBase):
    """DCAå®šæŠ•ç­–ç•¥ - ç»Ÿä¸€å¼€å‘ç‰ˆ v2.8.1"""

    def initialize(self):
        """åˆå§‹åŒ–ç­–ç•¥"""
        try:
            self._version = "v2.8.1-MainDev"
            
            print("ğŸš€ å¼€å§‹åˆå§‹åŒ– {0}".format(self._version))
            
            # æ ¸å¿ƒçŠ¶æ€å˜é‡
            self.last_investment_time = None
            self.highest_price = None  # å…¼å®¹æ€§ä¿ç•™
            self.run_highest_price = None  # æ–°çš„è¿è¡Œæ—¶æœ€é«˜ä»·
            self.last_valid_price = 100.0
            self.strategy_start_price = None
            self.drawdown_reset_threshold = 0.05
            
            # ç®€åŒ–çŠ¶æ€ç®¡ç†
            
            # å›æµ‹æ”¯æŒå˜é‡
            import collections
            self.high_queue = collections.deque(maxlen=20)
            self._position = 0
            self._total_cost = 0.0
            self.virtual_balance = None
            
            # VIPæ¨å¹¿æ§åˆ¶å˜é‡
            self._vip_promotion_shown = False
            self._layer_promotion_shown = {}
            
            # åˆå§‹åŒ–ç»„ä»¶
            self.trigger_symbols()
            self.custom_indicator()
            self.global_variables()
            self.setup_presets()  # é¢„è®¾è®¾ç½®å…ˆæ‰§è¡Œï¼Œè®¾å®šeffective_qty
            self.setup_tier_features()  # åˆ†å±‚åŠŸèƒ½åæ‰§è¡Œï¼Œä¾èµ–effective_qty
            
            # v2.4.0 æ–°å¢: åˆå§‹åŒ–å†å²æœ€é«˜ä»·åŸºå‡†
            self.initialize_highest_price_baseline()
            
            print("âœ… åˆå§‹åŒ–å®Œæˆ")
            self.print_welcome()
            
        except Exception as e:
            print("âŒ åˆå§‹åŒ–å¤±è´¥: {0}".format(str(e)))

    def trigger_symbols(self):
        """è®¾ç½®äº¤æ˜“æ ‡çš„"""
        try:
            self.stock = declare_trig_symbol()
            print("ğŸ“ˆ äº¤æ˜“æ ‡çš„: {0}".format(self.stock))
        except Exception as e:
            print("âŒ æ ‡çš„è®¾ç½®å¤±è´¥: {0}".format(str(e)))

    def custom_indicator(self):
        """æ³¨å†Œè‡ªå®šä¹‰æŠ€æœ¯æŒ‡æ ‡"""
        try:
            self.register_indicator(
                indicator_name='MA',
                script='MA5:MA(CLOSE,5),COLORFF8D1E;',
                param_list=[]
            )
        except Exception as e:
            print("âŒ æŠ€æœ¯æŒ‡æ ‡æ³¨å†Œå¤±è´¥: {0}".format(str(e)))

    def global_variables(self):
        """å…¨å±€å˜é‡è®¾ç½®"""
        try:
            # === åŸºç¡€å‚æ•° ===
            self.qty = show_variable(20, GlobalType.INT)
            self.preset_mode = show_variable(2, GlobalType.INT)  # é»˜è®¤å¹³è¡¡å‹
            self.backtest = show_variable(True, GlobalType.BOOL)
            self.basic_invest_only = show_variable(False, GlobalType.BOOL)
            
            # === åˆ†å±‚åŠŸèƒ½å‚æ•° ===
            self.version_tier = show_variable(2, GlobalType.INT)  # 1=å…è´¹ç‰ˆ 2=ä»˜è´¹ç‰ˆ
            self.balance_mode = show_variable(2, GlobalType.INT)  # ä½¿ç”¨è‡ªå®šä¹‰èµ„é‡‘
            self.custom_balance = show_variable(100000, GlobalType.INT)  # å¢åŠ åˆ°10ä¸‡
            self.interval_mode = show_variable(1, GlobalType.INT)  # è‡ªåŠ¨æ¨¡å¼
            self.custom_interval_min = show_variable(1440, GlobalType.INT)
            
            # === v2.4.0 æ–°å¢: æ¿€è¿›ä¹˜æ•°ç³»ç»Ÿ ===
            self.aggressive_multiplier = show_variable(1.0, GlobalType.FLOAT)  # 1.0-2.5å€ä¹˜æ•°
            
            # === v2.8.0 æ–°å¢: æ•°æ®æ”¶é›†æ¨¡å¼ ===  
            self.data_collection_mode = show_variable(0, GlobalType.INT)  # 0=æ­£å¸¸ 1=çº¯æ•°æ®æ”¶é›†
            
            # åŸºç¡€å›ºå®šå‚æ•° - v2.5.0æ‰©å±•æ”¯æŒ
            # å…è´¹ç‰ˆ: 3å±‚, ä»˜è´¹ç‰ˆ: 5å±‚
            if self.version_tier == 1:
                self.drawdown_layers = [5.0, 10.0, 20.0]
                self.base_multipliers = [1.5, 2.0, 3.0]
            else:  # self.version_tier == 2 (ä»˜è´¹ç‰ˆ)
                self.drawdown_layers = [5.0, 10.0, 20.0, 35.0, 50.0] 
                self.base_multipliers = [1.5, 2.0, 3.0, 4.0, 5.0]
            
            self.extreme_drawdown_pct = 60.0  # è¶…è¿‡æœ€é«˜å±‚çš„æç«¯å›æ’¤é˜ˆå€¼
            self.log_level = 0
            
            # v2.6.0æ–°å¢: åŠŸèƒ½ä½“éªŒåˆ¸ç³»ç»Ÿ
            self.trial_voucher_used = False  # æ˜¯å¦å·²ä½¿ç”¨ä½“éªŒåˆ¸
            self.trial_voucher_available = (self.version_tier == 1)  # ä»…å…è´¹ç‰ˆæä¾›ä½“éªŒåˆ¸
            
            # åŠ¨æ€è®¡ç®—æœ€ç»ˆå€æ•° - åœ¨setup_tier_features()ä¸­è®¾ç½®
            self.drawdown_multipliers = self.base_multipliers  # é»˜è®¤å€¼
            
            print("âš™ï¸ å‚æ•°é…ç½®å®Œæˆ")
            
        except Exception as e:
            print("âŒ å‚æ•°è®¾ç½®å¤±è´¥: {0}".format(str(e)))

    def setup_presets(self):
        """è®¾ç½®é¢„è®¾æ¨¡æ¿ - å®é™…åº”ç”¨æ•°é‡è®¾ç½®"""
        try:
            presets = {
                1: {"name": "ä¿å®ˆå‹", "description": "ä½é£é™©", "base_qty": 10, "risk_level": "ä½"},
                2: {"name": "å¹³è¡¡å‹", "description": "ä¸­ç­‰é£é™©", "base_qty": 15, "risk_level": "ä¸­"},
                3: {"name": "ç§¯æå‹", "description": "é«˜é£é™©", "base_qty": 25, "risk_level": "é«˜"}
            }
            
            if self.preset_mode in presets:
                preset = presets[self.preset_mode]
                self.preset_name = preset["name"]
                self.preset_desc = preset["description"]
                self.risk_level = preset["risk_level"]
                
                # å°Šé‡ç”¨æˆ·è®¾ç½®ï¼Œé¢„è®¾ä»…ä½œä¸ºå»ºè®®
                self.effective_qty = self.qty
                recommended_qty = preset["base_qty"]
                
                if self.qty != recommended_qty:
                    print("ğŸ’¡ é¢„è®¾å»ºè®®: {0}æ¨è{1}è‚¡ï¼Œæ‚¨é€‰æ‹©{2}è‚¡".format(
                        self.preset_name, recommended_qty, self.qty))
                else:
                    print("âœ… é¢„è®¾åŒ¹é…: {0} - æŠ•èµ„æ•°é‡: {1}è‚¡".format(
                        self.preset_name, self.qty))
                    
            else:
                self.preset_name = "è‡ªå®šä¹‰"
                self.preset_desc = "ç”¨æˆ·è‡ªå®šä¹‰å‚æ•°"
                self.risk_level = "ä¸­"
                self.effective_qty = self.qty
                
            print("ğŸ¨ é¢„è®¾é…ç½®: {0} - æ•°é‡: {1}è‚¡".format(self.preset_name, self.effective_qty))
            
        except Exception as e:
            print("âŒ é¢„è®¾é…ç½®å¤±è´¥: {0}".format(str(e)))
            self.preset_name = "é»˜è®¤"
            self.preset_desc = "ç³»ç»Ÿé»˜è®¤é…ç½®"
            self.risk_level = "ä¸­"
            self.effective_qty = self.qty

    def setup_tier_features(self):
        """è®¾ç½®åˆ†å±‚åŠŸèƒ½ç‰¹æ€§"""
        try:
            # èµ„é‡‘ç®¡ç†è®¾ç½®
            if self.version_tier >= 2 and self.balance_mode == 2:
                if self.backtest:
                    self.initial_balance = self.custom_balance
                    self.virtual_balance = self.custom_balance
                print("ğŸ’° ä½¿ç”¨è‡ªå®šä¹‰èµ„é‡‘: ${0:,}".format(self.custom_balance))
            else:
                if self.backtest:
                    try:
                        self.initial_balance = total_cash(currency=Currency.USD)
                        if self.initial_balance is None or self.initial_balance <= 0:
                            self.initial_balance = 10000.0
                        self.virtual_balance = self.initial_balance
                    except:
                        self.initial_balance = 10000.0
                        self.virtual_balance = 10000.0
                        print("âš ï¸ ä½¿ç”¨é»˜è®¤èµ„é‡‘$10,000")
                
            # æŠ•èµ„å‘¨æœŸè®¾ç½®
            if self.interval_mode == 1:  # è‡ªåŠ¨æ¨¡å¼
                if self.version_tier == 1:
                    self.interval_min = 10080  # æ¯å‘¨
                    self.interval_desc = "æ¯å‘¨å®šæŠ• (å…è´¹ç‰ˆ)"
                else:
                    # ä»˜è´¹ç‰ˆæ™ºèƒ½é¢‘ç‡ï¼šæ ¹æ®èµ„é‡‘å’Œæ•°é‡è‡ªåŠ¨è°ƒæ•´
                    daily_cost = self.effective_qty * 600  # ä¼°ç®—æ¯æ—¥æˆæœ¬(SPYçº¦$600)
                    max_days = int(self.virtual_balance / daily_cost)
                    
                    # è€ƒè™‘æ™ºèƒ½åŠ ä»“é¢„ç•™èµ„é‡‘ (é¢„ç•™30%èµ„é‡‘ç”¨äºåŠ ä»“)
                    conservative_days = int(max_days * 0.7)
                    
                    if conservative_days >= 5:  # ä¿å®ˆé¢„ä¼°5å¤©ä»¥ä¸Šï¼Œä½¿ç”¨æ¯æ—¥å®šæŠ•
                        self.interval_min = 1440
                        self.interval_desc = "æ¯æ—¥å®šæŠ• (ä»˜è´¹ç‰ˆæ™ºèƒ½)"
                    elif conservative_days >= 2:  # ä¿å®ˆé¢„ä¼°2å¤©ä»¥ä¸Šï¼Œä½¿ç”¨æ¯å‘¨å®šæŠ•
                        self.interval_min = 10080
                        self.interval_desc = "æ¯å‘¨å®šæŠ• (ä»˜è´¹ç‰ˆæ™ºèƒ½)"
                    else:  # èµ„é‡‘ä¸¥é‡ä¸è¶³ï¼Œä½¿ç”¨åŒå‘¨
                        self.interval_min = 20160
                        self.interval_desc = "åŒå‘¨å®šæŠ• (èµ„é‡‘ä¼˜åŒ–)"
                        
                    print("ğŸ“Š æ™ºèƒ½é¢‘ç‡è®¡ç®—: é¢„ä¼°{0}å¤©èµ„é‡‘(ä¿å®ˆ{1}å¤©)ï¼Œé€‰æ‹©{2}".format(max_days, conservative_days, self.interval_desc))
                    
            elif self.interval_mode == 2:  # å¼ºåˆ¶æ¯æ—¥
                if self.version_tier >= 2:
                    self.interval_min = 1440
                    self.interval_desc = "æ¯æ—¥å®šæŠ•"
                else:
                    print("ğŸ’¡ æ¯æ—¥å®šæŠ•ä¸ºä»˜è´¹ç‰ˆåŠŸèƒ½")
                    self.interval_min = 10080
                    self.interval_desc = "æ¯å‘¨å®šæŠ• (å…è´¹ç‰ˆé™åˆ¶)"
            elif self.interval_mode == 3:  # æ¯å‘¨
                self.interval_min = 10080
                self.interval_desc = "æ¯å‘¨å®šæŠ•"
            elif self.interval_mode == 4:  # è‡ªå®šä¹‰
                if self.version_tier >= 2:
                    self.interval_min = self.custom_interval_min
                    self.interval_desc = "è‡ªå®šä¹‰å‘¨æœŸ ({0}åˆ†é’Ÿ)".format(self.interval_min)
                else:
                    print("ğŸ’¡ è‡ªå®šä¹‰å‘¨æœŸä¸ºä»˜è´¹ç‰ˆåŠŸèƒ½")
                    self.interval_min = 10080
                    self.interval_desc = "æ¯å‘¨å®šæŠ• (å…è´¹ç‰ˆé™åˆ¶)"
            
            print("ğŸ“… æŠ•èµ„å‘¨æœŸ: {0}".format(self.interval_desc))
            
            # v2.4.0 æ–°å¢: è®¾ç½®æ¿€è¿›ä¹˜æ•°ç³»ç»Ÿ
            self.setup_aggressive_multiplier_system()
            
        except Exception as e:
            print("âŒ åˆ†å±‚åŠŸèƒ½è®¾ç½®å¤±è´¥: {0}".format(str(e)))
            self.interval_min = 10080 if getattr(self, 'version_tier', 1) == 1 else 1440
            self.interval_desc = "é»˜è®¤å‘¨æœŸ ({0}åˆ†é’Ÿ)".format(self.interval_min)
            if not hasattr(self, 'virtual_balance') or self.virtual_balance is None:
                self.virtual_balance = 10000.0
                self.initial_balance = 10000.0

    def initialize_highest_price_baseline(self):
        """åˆå§‹åŒ–å†å²æœ€é«˜ä»·åŸºå‡† - v2.4.0æ–°å¢"""
        try:
            print("ğŸ“ˆ æ­£åœ¨åˆå§‹åŒ–å†å²æœ€é«˜ä»·åŸºå‡†...")
            
            # ä½¿ç”¨bar_custom APIè·å–è¿‡å»200ä¸ªäº¤æ˜“æ—¥çš„æœ€é«˜ä»·
            historical_high = bar_custom(
                symbol=self.stock,
                data_type=BarDataType.HIGH,
                custom_num=200,  # çº¦200ä¸ªäº¤æ˜“æ—¥ï¼ˆçº¦1å¹´ï¼‰
                custom_type=CustomType.D1,
                select=1
            )
            
            if historical_high and historical_high > 0:
                self.run_highest_price = historical_high
                print("âœ… å†å²æœ€é«˜ä»·åŸºå‡†: ${0:.2f} (200æ—¥å†…)".format(historical_high))
            else:
                # å¦‚æœæ— æ³•è·å–å†å²æ•°æ®ï¼Œä½¿ç”¨å½“å‰ä»·æ ¼
                current_price_val = current_price(self.stock, price_type=THType.FTH)
                if current_price_val and current_price_val > 0:
                    self.run_highest_price = current_price_val
                else:
                    self.run_highest_price = self.last_valid_price
                print("âš ï¸ æ— æ³•è·å–å†å²æ•°æ®ï¼Œä½¿ç”¨å½“å‰ä»·æ ¼: ${0:.2f}".format(self.run_highest_price))
            
            # å…¼å®¹æ€§è®¾ç½®
            self.highest_price = self.run_highest_price
            
        except Exception as e:
            print("âŒ å†å²æœ€é«˜ä»·åˆå§‹åŒ–å¤±è´¥: {0}".format(str(e)))
            # å›é€€åˆ°å½“å‰ä»·æ ¼
            self.run_highest_price = self.last_valid_price
            self.highest_price = self.run_highest_price
            print("ğŸ”§ ä½¿ç”¨é»˜è®¤å€¼: ${0:.2f}".format(self.run_highest_price))

    def setup_aggressive_multiplier_system(self):
        """è®¾ç½®æ¿€è¿›ä¹˜æ•°ç³»ç»Ÿ - v2.4.0æ–°å¢"""
        try:
            print("ğŸ¯ æ­£åœ¨è®¾ç½®æ¿€è¿›ä¹˜æ•°ç³»ç»Ÿ...")
            
            # æ ¹æ®ç‰ˆæœ¬å±‚çº§è®¾ç½®ä¹˜æ•°é™åˆ¶
            if self.version_tier == 1:
                # å…è´¹ç‰ˆï¼šå›ºå®šæ ‡å‡†å€æ•°
                self.aggressive_multiplier = 1.0
                print("ğŸ†“ å…è´¹ç‰ˆ: ä½¿ç”¨æ ‡å‡†ä¹˜æ•° 1.0x")
            elif self.version_tier == 2:
                # ä»˜è´¹ç‰ˆï¼šå…è®¸æ¿€è¿›ä¹˜æ•° 1.0-2.5
                multiplier_input = getattr(self, 'aggressive_multiplier', 1.0)
                if multiplier_input < 1.0:
                    self.aggressive_multiplier = 1.0
                    print("âš ï¸ ä¹˜æ•°ä¸èƒ½å°äº1.0ï¼Œè®¾ç½®ä¸º1.0x")
                elif multiplier_input > 2.5:
                    self.aggressive_multiplier = 2.5
                    print("âš ï¸ ä¹˜æ•°ä¸èƒ½è¶…è¿‡2.5ï¼Œè®¾ç½®ä¸º2.5x")
                else:
                    self.aggressive_multiplier = multiplier_input
                
                print("ğŸ’° ä»˜è´¹ç‰ˆ: ä½¿ç”¨æ¿€è¿›ä¹˜æ•° {0}x".format(self.aggressive_multiplier))
            
            # è®¡ç®—æœ€ç»ˆå€æ•°
            self.drawdown_multipliers = [
                m * self.aggressive_multiplier for m in self.base_multipliers
            ]
            
            print("ğŸ“‹ åŸºç¡€å€æ•°: {0}".format(self.base_multipliers))
            print("ğŸš€ æœ€ç»ˆå€æ•°: {0}".format(["{0:.1f}x".format(m) for m in self.drawdown_multipliers]))
            
            # æ˜¾ç¤ºå±‚çº§å’Œå€æ•°å¯¹åº”å…³ç³»
            for i, (layer, multiplier) in enumerate(zip(self.drawdown_layers, self.drawdown_multipliers)):
                print("   ç¬¬{0}å±‚: {1}%å›æ’¤ â†’ {2:.1f}å€åŠ ä»“".format(i+1, layer, multiplier))
            
        except Exception as e:
            print("âŒ æ¿€è¿›ä¹˜æ•°è®¾ç½®å¤±è´¥: {0}".format(str(e)))
            # å›é€€åˆ°æ ‡å‡†å€æ•°
            self.aggressive_multiplier = 1.0
            self.drawdown_multipliers = self.base_multipliers
            print("ğŸ”§ ä½¿ç”¨æ ‡å‡†å€æ•°")

    def print_welcome(self):
        """æ‰“å°æ¬¢è¿ä¿¡æ¯"""
        version_info = {
            1: {"name": "å…è´¹åŸºç¡€ç‰ˆ", "features": "å›ºå®šå®šæŠ•+æ™ºèƒ½ä½“éªŒåˆ¸", "color": "ğŸ†“"},
            2: {"name": "ä»˜è´¹è¿›é˜¶ç‰ˆ(Â¥35/æœˆ)", "features": "5å±‚æ™ºèƒ½åŠ ä»“ç³»ç»Ÿ", "color": "ğŸ’"}
        }
        
        current_version = version_info.get(self.version_tier, version_info[1])
        
        print("="*60)
        print("ğŸš€ DCAæ™ºèƒ½å®šæŠ•ç­–ç•¥ {0}".format(self._version))
        print("="*60)
        print("{0} å½“å‰ç‰ˆæœ¬: {1}".format(current_version['color'], current_version['name']))
        print("âœ¨ æ ¸å¿ƒåŠŸèƒ½: {0}".format(current_version['features']))
        
        print("\nğŸ“Š å½“å‰é…ç½®:")
        print("   ç‰ˆæœ¬ç­‰çº§: {0} ({1})".format(self.version_tier, 'å…è´¹ç‰ˆ' if self.version_tier == 1 else 'ä»˜è´¹ç‰ˆ'))
        print("   æŠ•èµ„æ¨¡æ¿: {0} ({1})".format(self.preset_name, self.preset_desc))
        print("   ç”¨æˆ·è®¾ç½®: {0}è‚¡".format(self.qty))
        print("   å®é™…æŠ•èµ„: {0}è‚¡".format(self.effective_qty))
        print("   æŠ•èµ„å‘¨æœŸ: {0}".format(getattr(self, 'interval_desc', 'æœªçŸ¥')))
        if hasattr(self, 'virtual_balance'):
            print("   åˆå§‹èµ„é‡‘: ${0:,.0f}".format(self.virtual_balance))
            # è®¡ç®—å¤§çº¦å¯æŠ•èµ„å¤©æ•°
            daily_cost = self.effective_qty * 600  # ä¼°ç®—
            estimated_days = int(self.virtual_balance / daily_cost)
            conservative_days = int(estimated_days * 0.7)
            print("   é¢„ä¼°æŠ•èµ„: çº¦{0}å¤© (ä¿å®ˆ{1}å¤©ï¼Œé¢„ç•™åŠ ä»“èµ„é‡‘)".format(estimated_days, conservative_days))
        print("   è¿è¡Œæ¨¡å¼: {0}".format('å›æµ‹' if self.backtest else 'å®ç›˜'))
        
        # v2.4.0 æ–°å¢ï¼šæ˜¾ç¤ºæ¿€è¿›ä¹˜æ•°ç³»ç»Ÿ
        if hasattr(self, 'run_highest_price'):
            print("   å†å²æœ€é«˜ä»·: ${0:.2f}".format(self.run_highest_price))
        if hasattr(self, 'aggressive_multiplier'):
            print("   æ¿€è¿›ä¹˜æ•°: {0}x".format(self.aggressive_multiplier))
        if hasattr(self, 'drawdown_multipliers'):
            print("   å›æ’¤å±‚çº§: {0}".format(self.drawdown_layers))
            print("   åŠ ä»“å€æ•°: {0}".format(["{0:.1f}x".format(m) for m in self.drawdown_multipliers]))
        
        if self.version_tier == 1:
            print("\nğŸ å…è´¹ç‰ˆä¸“äº«:")
            print("   âœ¨ æ™ºèƒ½åŠ ä»“ä½“éªŒåˆ¸: 1æ¬¡ (10%å›æ’¤æ—¶è‡ªåŠ¨è§¦å‘)")
            print("   ğŸ“ˆ ä½“éªŒ2.0å€åŠ ä»“å¨åŠ›ï¼Œæ„Ÿå—ä»˜è´¹ç‰ˆåŠŸèƒ½")
            print("\nğŸ¯ å‡çº§æç¤º:")
            print("   ğŸ’ ä»˜è´¹ç‰ˆæ”¯æŒå®Œæ•´5å±‚æ™ºèƒ½åŠ ä»“ç³»ç»Ÿ")
            print("   âš¡ æ¿€è¿›ä¹˜æ•°æœ€é«˜2.5xï¼Œé•¿æœŸæ”¶ç›Šæ›´ä¼˜")
            print("   ğŸ’° è”ç³»ä½œè€…å‡çº§è‡³ä»˜è´¹ç‰ˆ(Â¥35/æœˆ)")
        else:
            # ä»˜è´¹ç‰ˆæ˜¾ç¤ºæ•°æ®æ”¶é›†æ¨¡å¼è¯´æ˜
            if getattr(self, 'data_collection_mode', 0) == 1:
                print("\nğŸ” æ•°æ®æ”¶é›†æ¨¡å¼å·²å¯ç”¨:")
                print("   ğŸ“Š çº¯ç²¹æ¯æ—¥å®šæŠ• - æ— ä»»ä½•å¤æ‚è®¡ç®—å’Œåˆ¤æ–­")
                print("   âš¡ ä¸“ä¸ºå¿«é€Ÿè·å–é•¿æœŸå†å²æ•°æ®è®¾è®¡")
                print("   ğŸ“ˆ æ¯æ—¥æ— æ¡ä»¶æŠ•èµ„{0}è‚¡ï¼Œé€‚åˆ1å¹´+å›æµ‹".format(self.effective_qty))
                print("   ğŸš€ é«˜é€Ÿæ•°æ®æ”¶é›†ï¼Œæ— ç­–ç•¥é€»è¾‘å¹²æ‰°")
            else:
                print("\nğŸ’ ä»˜è´¹ç‰ˆé«˜çº§åŠŸèƒ½:")
                print("   ğŸ” æ•°æ®æ”¶é›†æ¨¡å¼: è®¾ç½®data_collection_mode=1å¯ç”¨")
                print("   ğŸ“Š çº¯æ¯æ—¥å®šæŠ•æ¨¡å¼ï¼Œä¸“ä¸ºè·å–å†å²æ•°æ®è®¾è®¡")
        
        print("="*60 + "\n")

    def handle_data(self):
        """ä¸»è¦äº¤æ˜“é€»è¾‘"""
        try:
            current_time = device_time(TimeZone.DEVICE_TIME_ZONE)
            latest_price, account_balance = self.get_market_data()
            
            drawdown = self.calculate_drawdown(latest_price)
            
            # æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼ˆå‡å°‘é¢‘ç‡ï¼‰
            if hasattr(self, 'bar_index') and self.bar_index % 20 == 0:  # æ¯20ä¸ªbaræ‰“å°ä¸€æ¬¡
                print("ğŸ“Š ç¬¬{0}å¤© | ä»·æ ¼: ${1:.2f} | ä½™é¢: ${2:,.0f}".format(
                    self.bar_index, latest_price, account_balance))
            
            # åˆ†å±‚åŠŸèƒ½è·¯ç”±
            if self.version_tier == 1:
                self.free_version_logic(current_time, latest_price, account_balance, drawdown)
            elif self.version_tier == 2:
                self.advanced_version_logic(current_time, latest_price, account_balance, drawdown)
            else:
                print("âš ï¸ ç‰ˆæœ¬å‚æ•°é”™è¯¯ï¼Œä½¿ç”¨å…è´¹ç‰ˆåŠŸèƒ½")
                self.free_version_logic(current_time, latest_price, account_balance, drawdown)

        except Exception as e:
            print("âŒ ç­–ç•¥æ‰§è¡Œé”™è¯¯: {0}".format(str(e)))

    def get_market_data(self):
        """è·å–å¸‚åœºæ•°æ® - v2.7.0é‡æ„ç»Ÿä¸€ç‰ˆ"""
        latest_price = None
        account_balance = None
        
        try:
            if self.backtest:
                latest_price = self._get_backtest_price()
                account_balance = self.virtual_balance
            else:
                latest_price = self._get_live_price()
                account_balance = self._get_live_balance()
            
            # ç»Ÿä¸€çš„ä»·æ ¼éªŒè¯å’Œæ›´æ–°é€»è¾‘
            latest_price = self._validate_and_update_price(latest_price)
            
            return latest_price, account_balance
            
        except Exception as e:
            print("å¸‚åœºæ•°æ®è·å–é”™è¯¯: {0}".format(str(e)))
            return self._get_fallback_data()
    
    def _get_backtest_price(self):
        """è·å–å›æµ‹ä»·æ ¼"""
        if not hasattr(self, 'bar_index'):
            self.bar_index = 0
        self.bar_index += 1
        
        price = bar_close(self.stock, bar_type=BarType.D1, select=1)
        return price if price and price > 0 else 100.0
    
    def _get_live_price(self):
        """è·å–å®ç›˜ä»·æ ¼"""
        return current_price(self.stock, price_type=THType.FTH)
    
    def _get_live_balance(self):
        """è·å–å®ç›˜ä½™é¢"""
        return total_cash(currency=Currency.USD)
    
    def _validate_and_update_price(self, price):
        """éªŒè¯å¹¶æ›´æ–°ä»·æ ¼"""
        if price is None or price <= 0:
            price = self.last_valid_price
        else:
            self.last_valid_price = price
        return price
    
    def _get_fallback_data(self):
        """è·å–å›é€€æ•°æ®"""
        default_balance = getattr(self, 'virtual_balance', 10000.0) or 10000.0
        return self.last_valid_price, default_balance

    def calculate_drawdown(self, latest_price):
        """è®¡ç®—å›æ’¤å¹…åº¦ - v2.4.0ä¿®å¤ç‰ˆ"""
        # åˆå§‹åŒ–æ£€æŸ¥
        if not hasattr(self, 'run_highest_price') or self.run_highest_price is None:
            self.run_highest_price = latest_price
            print("âš ï¸ è¿è¡Œæ—¶åˆå§‹åŒ–æœ€é«˜ä»·: ${0:.2f}".format(latest_price))
            
        # å®æ—¶æ›´æ–°è¿è¡Œæ—¶æœ€é«˜ä»·
        if latest_price > self.run_highest_price:
            old_high = self.run_highest_price
            self.run_highest_price = latest_price
            print("ğŸ“ˆ åˆ›æ–°é«˜: ${0:.2f} â†’ ${1:.2f}".format(old_high, latest_price))
            
            # ä»·æ ¼åˆ›æ–°é«˜æ—¶é‡ç½®å›æ’¤å±‚çº§
            if hasattr(self, 'current_drawdown_layer'):
                self.current_drawdown_layer = -1
        
        # å…¼å®¹æ€§æ›´æ–°æ—§çš„highest_price
        self.highest_price = self.run_highest_price
        
        # è®¡ç®—å‡†ç¡®å›æ’¤
        if self.run_highest_price > 0:
            drawdown = (self.run_highest_price - latest_price) / self.run_highest_price * 100
        else:
            drawdown = 0.0
            
        return drawdown

    def calculate_add_position_qty(self, drawdown):
        """è®¡ç®—åŠ ä»“æ•°é‡ - v2.4.1ä¿®å¤ç‰ˆï¼šä»é«˜å±‚çº§å¾€ä½å±‚çº§æ£€æŸ¥"""
        # v2.5.0æ–°å¢: æ£€æŸ¥æ˜¯å¦è¶…å‡ºæœ€é«˜å±‚çº§çš„æç«¯å›æ’¤
        max_layer_threshold = self.drawdown_layers[-1]
        if drawdown > max_layer_threshold and drawdown >= self.extreme_drawdown_pct:
            if not hasattr(self, '_extreme_drawdown_warned'):
                print("ğŸš¨ æç«¯å›æ’¤è­¦å‘Š: å½“å‰å›æ’¤{0:.1f}%è¶…è¿‡ç¬¬{1}å±‚({2}%)".format(
                    drawdown, len(self.drawdown_layers), max_layer_threshold))
                print("ğŸ“± å»ºè®®è€ƒè™‘VIP Appçš„é«˜çº§å›æ’¤ç®¡ç†åŠŸèƒ½")
                self._extreme_drawdown_warned = True
        
        # v2.6.0æ–°å¢: åŠŸèƒ½ä½“éªŒåˆ¸é€»è¾‘
        if self.version_tier == 1:  # ä»…å…è´¹ç‰ˆå¤„ç†ä½“éªŒåˆ¸
            return self._handle_free_tier_experience(drawdown)
        
        # ä»˜è´¹ç‰ˆæ­£å¸¸å¤„ç†
        return self._handle_paid_tier_drawdown(drawdown)
    
    def _handle_free_tier_experience(self, drawdown):
        """å¤„ç†å…è´¹ç‰ˆä½“éªŒåˆ¸é€»è¾‘"""
        # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç¬¬2å±‚(10%å›æ’¤)
        if drawdown >= 10.0:
            if self.trial_voucher_available and not self.trial_voucher_used:
                # ä½¿ç”¨ä½“éªŒåˆ¸ï¼
                self.trial_voucher_used = True
                add_qty = int(self.effective_qty * 2.0)  # ç¬¬2å±‚å€æ•°
                
                print("=" * 60)
                print("ğŸ‰ æ­å–œï¼æ‚¨å·²è§¦å‘å¹¶ä½¿ç”¨äº†ã€æ™ºèƒ½åŠ ä»“ä½“éªŒåˆ¸ã€‘ï¼")
                print("ğŸ¯ ä½“éªŒåŠŸèƒ½: ç¬¬2å±‚æ™ºèƒ½åŠ ä»“ (10%å›æ’¤é˜ˆå€¼)")
                print("ğŸ’° æœ¬æ¬¡åŠ ä»“: {0}è‚¡ (2.0å€å¢å¼º)".format(add_qty))
                print("âš¡ è¿™å°±æ˜¯ä»˜è´¹ç‰ˆçš„å¨åŠ› - è‡ªåŠ¨åœ¨æœ€ä½³æ—¶æœºåŠ ä»“ï¼")
                print("=" * 60)
                print("âš ï¸ é‡è¦æé†’: ä½“éªŒåˆ¸ä»…æ­¤ä¸€æ¬¡ï¼Œåç»­æ™ºèƒ½åŠ ä»“éœ€è¦å‡çº§ä»˜è´¹ç‰ˆ")
                print("ğŸ’ ä»˜è´¹ç‰ˆæä¾›å®Œæ•´çš„5å±‚æ™ºèƒ½åŠ ä»“ç³»ç»Ÿ")
                print("ğŸ“ˆ æ¿€è¿›ä¹˜æ•°æœ€é«˜2.5xï¼Œé•¿æœŸæŠ•èµ„æ”¶ç›Šæ›´ä¼˜")
                print("=" * 60)
                
                return add_qty
            else:
                # ä½“éªŒåˆ¸å·²ç”¨å®Œï¼Œæ˜¾ç¤ºç„¦è™‘é©±åŠ¨è½¬åŒ–
                if self.trial_voucher_used:
                    self._show_anxiety_driven_conversion(drawdown)
                else:
                    # è¿˜æœªä½¿ç”¨ä½“éªŒåˆ¸ä½†ä¸ç¬¦åˆæ¡ä»¶
                    print("ğŸ” å¸‚åœºå›è°ƒ{0:.1f}%ï¼Œæš‚æœªè¾¾åˆ°ä½“éªŒåˆ¸è§¦å‘é˜ˆå€¼(10%)".format(drawdown))
    
    def _show_anxiety_driven_conversion(self, drawdown):
        """æ˜¾ç¤ºç„¦è™‘é©±åŠ¨çš„ä»˜è´¹è½¬åŒ–æ–‡æ¡ˆ"""
        print("=" * 60)
        print("ğŸš¨ ã€å¸‚åœºé£é™©è­¦å‘Šã€‘å›æ’¤å·²è¾¾ {0:.1f}%ï¼".format(drawdown))
        print("ğŸ“‰ å½“å‰æ­£å¤„äºæŠ•èµ„çš„é»„é‡‘åŠ ä»“æ—¶æœºï¼Œä½†æ‚¨çš„ä½“éªŒåˆ¸å·²ç”¨å®Œ")
        
        if drawdown >= 20.0:
            print("ğŸ”¥ ã€æ·±åº¦å›æ’¤ã€‘è¿™æ˜¯ä»˜è´¹ç‰ˆç”¨æˆ·æœ€æ¿€åŠ¨çš„æ—¶åˆ»ï¼")
            print("ğŸ’ ä»˜è´¹ç‰ˆæ­¤æ—¶å°†è§¦å‘ç¬¬3å±‚æ™ºèƒ½åŠ ä»“ (3.0å€å¢å¼º)")
            print("ğŸ“ˆ å†å²æ•°æ®æ˜¾ç¤ºï¼š20%+å›æ’¤å6ä¸ªæœˆå†…å¹³å‡æ”¶ç›Š+15%")
        elif drawdown >= 15.0:
            print("âš¡ ã€æœºä¼šçª—å£ã€‘ä»˜è´¹ç‰ˆç”¨æˆ·æ­£åœ¨äº«å—æ™ºèƒ½åŠ ä»“ï¼")
            print("ğŸ’° ä»˜è´¹ç‰ˆæ­¤æ—¶å°†è§¦å‘ç¬¬2å±‚æ™ºèƒ½åŠ ä»“ (2.0å€)")
        else:
            print("ğŸ’¡ ã€é”™å¤±æœºä¼šã€‘ä»˜è´¹ç‰ˆç”¨æˆ·æ­¤æ—¶å°†è·å¾—æ™ºèƒ½åŠ ä»“ (2.0å€)")
        
        print("\nâœ… ã€ä»˜è´¹ç‰ˆè§£å†³æ–¹æ¡ˆã€‘")
        print("   ğŸ›¡ï¸ 5å±‚æ™ºèƒ½åŠ ä»“ç³»ç»Ÿ - æ¯ä¸ªå›æ’¤å±‚çº§éƒ½æœ‰ç²¾ç¡®åº”å¯¹")
        print("   âš¡ æ¿€è¿›ä¹˜æ•°æœ€é«˜2.5x - æç«¯å›æ’¤æ—¶åŠ å€æŠ„åº•")
        print("   ğŸ¯ å†å²éªŒè¯æ”¶ç›Š - é•¿æœŸè·‘èµ¢å…è´¹ç‰ˆ33-67%")
        
        print("\nâ° æœºä¼šç¨çºµå³é€ï¼Œç«‹å³å‡çº§äº«å—å®Œæ•´æ™ºèƒ½åŠ ä»“ï¼")
        print("=" * 60)
        
        return 0  # å…è´¹ç‰ˆä¸æä¾›å¸¸è§„æ™ºèƒ½åŠ ä»“
    
    def _handle_paid_tier_drawdown(self, drawdown):
        """å¤„ç†ä»˜è´¹ç‰ˆå›æ’¤åŠ ä»“"""
        # v2.4.1 ä¿®å¤: ä»æœ€é«˜å±‚çº§å¼€å§‹æ£€æŸ¥ï¼ˆä»åå¾€å‰éå†ï¼‰
        for i in reversed(range(len(self.drawdown_layers))):
            threshold = self.drawdown_layers[i]
            if drawdown >= threshold:
                # æ¿€è¿›æŠ„åº•ç­–ç•¥ - é€‰æ‹©æœ€é€‚åˆçš„å±‚çº§
                add_qty = int(self.effective_qty * self.drawdown_multipliers[i])
                
                print("ğŸ“Š å›æ’¤åŠ ä»“è§¦å‘: ç¬¬{0}å±‚ ({1}%), å®é™…å›æ’¤{2:.1f}%, æ•°é‡={3}è‚¡".format(
                    i+1, threshold, drawdown, add_qty))
                print("ğŸ“ˆ ä¹˜æ•°è¯¦æƒ…: åŸºç¡€{0}è‚¡ Ã— {1:.1f}å€ = {2}è‚¡".format(
                    self.effective_qty, self.drawdown_multipliers[i], add_qty))
                
                # VIPæ¨å¹¿ä¿¡æ¯ - æ¯ä¸ªå±‚çº§åªæ˜¾ç¤ºä¸€æ¬¡
                layer_key = "layer_{0}".format(i+1)
                if not self._vip_promotion_shown and layer_key not in self._layer_promotion_shown:
                    self._layer_promotion_shown[layer_key] = True
                    if i >= 2:  # ç¬¬3å±‚åŠä»¥ä¸Šæ˜¾ç¤ºVIPæ¨å¹¿
                        print("ğŸ’¡ VIPç‰ˆæœ¬æä¾›11å±‚æˆæœ¬å®šæŠ•ç®—æ³•ï¼Œåœ¨{0:.1f}%å›æ’¤æ—¶æœ‰æ›´ç²¾ç»†çš„åŠ ä»“ç­–ç•¥".format(drawdown))
                        print("ğŸ“ è”ç³»å¾®ä¿¡è·å–VIPå®Œæ•´ç‰ˆ(Â¥500/å¹´)ï¼ŒåŒ…å«AIå‚æ•°ä¼˜åŒ–å’Œå¤šæ ‡çš„æŠ•èµ„ç»„åˆ")
                        self._vip_promotion_shown = True  # å…¨å±€æ ‡è®°ï¼Œé¿å…åç»­å±‚çº§é‡å¤æ˜¾ç¤º
                
                return add_qty
        
        return 0

    def should_invest(self, current_time):
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥å®šæŠ•"""
        if self.last_investment_time is None:
            return True
        elapsed = (current_time - self.last_investment_time).total_seconds() / 60
        
        if not hasattr(self, 'interval_min') or self.interval_min is None:
            default_interval = 10080 if getattr(self, 'version_tier', 1) == 1 else 1440
            self.interval_min = default_interval
        
        should_invest_now = elapsed >= self.interval_min
        
        # è°ƒè¯•ä¿¡æ¯
        if elapsed > 0:
            print("â° å®šæŠ•æ£€æŸ¥: é—´éš”{0:.0f}åˆ†é’Ÿ / éœ€è¦{1}åˆ†é’Ÿ = {2}".format(
                elapsed, self.interval_min, "âœ…å¯å®šæŠ•" if should_invest_now else "â³ç­‰å¾…ä¸­"))
        
        return should_invest_now

    def free_version_logic(self, current_time, latest_price, account_balance, drawdown):
        """å…è´¹ç‰ˆç­–ç•¥é€»è¾‘"""
        
        # é£é™©æé†’åŠŸèƒ½
        if drawdown >= 20.0:
            print("âš ï¸ å…è´¹ç‰ˆé£é™©æé†’: å½“å‰å›æ’¤{0:.1f}%".format(drawdown))
        elif drawdown >= 10.0:
            print("ğŸ“¢ å›æ’¤ç›‘æ§: å½“å‰å›æ’¤{0:.1f}%".format(drawdown))
            
        # å®šæŠ•é€»è¾‘
        basic_only = bool(getattr(self, 'basic_invest_only', False))
        if basic_only or True:  # å…è´¹ç‰ˆåªåšå®šæŠ•
            if self.should_invest(current_time):
                self.execute_investment(latest_price, account_balance, self.effective_qty, "åŸºç¡€å®šæŠ•")

    def advanced_version_logic(self, current_time, latest_price, account_balance, drawdown):
        """ä»˜è´¹ç‰ˆç­–ç•¥é€»è¾‘"""
        
        if self.version_tier != 2:
            print("ğŸ’¡ æ™ºèƒ½åŠ ä»“åŠŸèƒ½éœ€è¦å‡çº§åˆ°ä»˜è´¹ç‰ˆ(Â¥35/æœˆ)")
            return self.free_version_logic(current_time, latest_price, account_balance, drawdown)
        
        # v2.8.0æ–°å¢: æ•°æ®æ”¶é›†æ¨¡å¼ - çº¯ç²¹çš„æ¯æ—¥å®šæŠ•ï¼Œæ— ä»»ä½•åˆ¤æ–­é€»è¾‘
        if getattr(self, 'data_collection_mode', 0) == 1:
            return self.data_collection_mode_logic(current_time, latest_price, account_balance)
        
        # æç«¯å›æ’¤ä¿æŠ¤
        if drawdown >= self.extreme_drawdown_pct:
            print("ğŸš¨ æç«¯å›æ’¤ä¿æŠ¤: {0:.1f}%ï¼Œä»…å®šæŠ•æ¨¡å¼".format(drawdown))
            if self.should_invest(current_time):
                self.execute_investment(latest_price, account_balance, self.effective_qty, "æç«¯å›æ’¤ä¿æŠ¤")
            return

        # æ™ºèƒ½åŠ ä»“ç³»ç»Ÿ
        add_qty = self.calculate_add_position_qty(drawdown)
        if add_qty > 0:
            self.execute_investment(latest_price, account_balance, add_qty, "ä»˜è´¹ç‰ˆ-æ™ºèƒ½åŠ ä»“")
            return

        # å¸¸è§„å®šæŠ•
        if self.should_invest(current_time):
            self.execute_investment(latest_price, account_balance, self.effective_qty, "ä»˜è´¹ç‰ˆ-å®šæœŸå®šæŠ•")
    
    def data_collection_mode_logic(self, current_time, latest_price, account_balance):
        """æ•°æ®æ”¶é›†æ¨¡å¼ - v2.8.0æ–°å¢: çº¯ç²¹æ¯æ—¥å®šæŠ•ï¼Œä¸“ä¸ºè·å–å†å²æ•°æ®è®¾è®¡"""
        
        # ç®€å•æ—¥å¿—è¾“å‡ºï¼Œè®°å½•å…³é”®æ•°æ®
        if hasattr(self, 'bar_index'):
            bar_count = self.bar_index
        else:
            bar_count = getattr(self, '_data_collection_day_count', 0)
            self._data_collection_day_count = bar_count + 1
        
        # æ¯10å¤©è¾“å‡ºä¸€æ¬¡è¿›åº¦ 
        if bar_count % 10 == 0:
            total_position = self.get_position()
            total_cost = self.get_total_cost()
            avg_cost = total_cost / total_position if total_position > 0 else 0
            current_value = total_position * latest_price
            
            print("ğŸ“Š æ•°æ®æ”¶é›†ç¬¬{0}å¤©: ä»·æ ¼=${1:.2f} | æŒä»“{2}è‚¡ | æˆæœ¬${3:.2f} | ä»·å€¼${4:,.0f}".format(
                bar_count, latest_price, total_position, avg_cost, current_value))
        
        # çº¯ç²¹çš„æ¯æ—¥å®šæŠ• - æ— ä»»ä½•æ¡ä»¶åˆ¤æ–­
        self.execute_investment(latest_price, account_balance, self.effective_qty, "æ•°æ®æ”¶é›†æ¨¡å¼")
        
        # è®°å½•æ•°æ®æ”¶é›†çŠ¶æ€
        if not hasattr(self, '_data_collection_started'):
            self._data_collection_started = True
            print("ğŸ” æ•°æ®æ”¶é›†æ¨¡å¼å·²å¯åŠ¨ - æ¯æ—¥æ— æ¡ä»¶æŠ•èµ„{0}è‚¡".format(self.effective_qty))
            print("ğŸ“ˆ æ­¤æ¨¡å¼ä¸“ä¸ºå¿«é€Ÿè·å–é•¿æœŸå†å²æ•°æ®è®¾è®¡ï¼Œæ— ä»»ä½•å¤æ‚é€»è¾‘")

    def execute_investment(self, latest_price, account_balance, quantity, trade_type="å®šæŠ•"):
        """æ‰§è¡ŒæŠ•èµ„ - v2.7.0é‡æ„ç»Ÿä¸€ç‰ˆ"""
        
        # 1. ç»Ÿä¸€çš„å‚æ•°éªŒè¯
        quantity = self._validate_investment_quantity(quantity)
        if quantity <= 0:
            return
        
        # 2. ç»Ÿä¸€çš„èµ„é‡‘æ£€æŸ¥å’Œè°ƒæ•´
        quantity, required_cash = self._adjust_quantity_for_balance(
            quantity, latest_price, account_balance)
        if quantity <= 0:
            return
            
        # 3. ç»Ÿä¸€çš„ä¸‹å•æ‰§è¡Œ
        success = self._execute_order(quantity, latest_price, trade_type)
        if not success:
            return
            
        # 4. ç»Ÿä¸€çš„è´¦æˆ·æ›´æ–°
        self._update_account_after_trade(quantity, required_cash)
        
        # 5. æ›´æ–°æœ€åæŠ•èµ„æ—¶é—´
        self.last_investment_time = device_time(TimeZone.DEVICE_TIME_ZONE)
    
    def _validate_investment_quantity(self, quantity):
        """éªŒè¯æŠ•èµ„æ•°é‡"""
        if self.version_tier == 2:
            # ä»˜è´¹ç‰ˆå‚æ•°éªŒè¯
            if quantity < 1 or quantity > 1000:
                print("âš ï¸ ä»˜è´¹ç‰ˆå‚æ•°ä¿®æ­£: æŠ•èµ„æ•°é‡ {0} -> {1}è‚¡".format(quantity, self.effective_qty))
                return self.effective_qty
        else:
            # å…è´¹ç‰ˆå‚æ•°éªŒè¯
            if quantity < 10 or quantity > 100 or quantity % 10 != 0:
                print("âš ï¸ å…è´¹ç‰ˆå‚æ•°ä¿®æ­£: æŠ•èµ„æ•°é‡ {0} -> 10è‚¡".format(quantity))
                return 10
        return quantity
    
    def _adjust_quantity_for_balance(self, quantity, latest_price, account_balance):
        """æ ¹æ®ä½™é¢è°ƒæ•´æŠ•èµ„æ•°é‡"""
        required_cash = quantity * latest_price
        
        if self.backtest:
            return self._adjust_for_backtest_balance(quantity, latest_price, required_cash)
        else:
            return self._adjust_for_live_balance(quantity, latest_price, account_balance, required_cash)
    
    def _adjust_for_backtest_balance(self, quantity, latest_price, required_cash):
        """å›æµ‹æ¨¡å¼èµ„é‡‘è°ƒæ•´"""
        if self.virtual_balance is None:
            self.virtual_balance = 10000.0
        
        if required_cash > self.virtual_balance:
            max_qty = int(self.virtual_balance // latest_price)
            if max_qty < 1:
                print("ğŸ’° è™šæ‹Ÿä½™é¢ä¸è¶³: ${0:.0f} < ${1:.0f}".format(self.virtual_balance, required_cash))
                print("ğŸ“Š å»ºè®®: å¢åŠ initial_balanceæˆ–å‡å°‘æŠ•èµ„é¢‘ç‡")
                return 0, 0
            
            quantity = max_qty
            required_cash = quantity * latest_price
            print("âš ï¸ æ™ºèƒ½èµ„é‡‘è°ƒæ•´: åŸè®¡åˆ’{0}è‚¡ â†’ å®é™…{1}è‚¡ (å‰©ä½™${2:.0f})".format(
                int(self.effective_qty), quantity, self.virtual_balance))
        
        return quantity, required_cash
    
    def _adjust_for_live_balance(self, quantity, latest_price, account_balance, required_cash):
        """å®ç›˜æ¨¡å¼èµ„é‡‘è°ƒæ•´"""
        if required_cash > account_balance:
            max_qty = int((account_balance // latest_price) // 10 * 10)
            if max_qty < 10:
                print("ğŸ’° èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•æŠ•èµ„")
                return 0, 0
            
            quantity = max_qty
            required_cash = quantity * latest_price
            print("âš ï¸ èµ„é‡‘è°ƒæ•´: æŠ•èµ„æ•°é‡è°ƒæ•´ä¸º {0}è‚¡".format(quantity))
        
        return quantity, required_cash
    
    def _execute_order(self, quantity, latest_price, trade_type):
        """æ‰§è¡Œä¸‹å•"""
        try:
            order_id = place_market(self.stock, quantity, OrderSide.BUY, TimeInForce.DAY)
            
            if self.backtest:
                # ç®€åŒ–å›æµ‹è¾“å‡º
                if "åŠ ä»“" in trade_type:
                    print("ğŸ”¥ {0}: {1}è‚¡ @ ${2:.2f}".format(trade_type, quantity, latest_price))
                else:
                    print("ğŸ“Š {0}: {1}è‚¡ @ ${2:.2f}".format(trade_type, quantity, latest_price))
            else:
                print("âœ… {0}è®¢å•: {1}è‚¡ @ å¸‚ä»·, ID: {2}".format(trade_type, quantity, order_id))
            
            return True
            
        except Exception as e:
            print("âŒ ä¸‹å•å¤±è´¥: {0}".format(str(e)))
            return False
    
    def _update_account_after_trade(self, quantity, required_cash):
        """äº¤æ˜“åæ›´æ–°è´¦æˆ·"""
        if self.backtest:
            self.virtual_balance -= required_cash
            self._total_cost += required_cash
            self._position += quantity
            if hasattr(self, 'bar_index') and self.bar_index % 10 == 0:  # æ¯10ä¸ªäº¤æ˜“æ—¥æ‰“å°ä¸€æ¬¡
                print("ğŸ’° ä½™é¢: ${0:,.0f} | æŒä»“: {1}è‚¡".format(self.virtual_balance, self._position))

    def get_position(self):
        """è·å–æŒä»“æ•°é‡"""
        if self.backtest:
            return self._position
        try:
            return position_holding_qty(self.stock)
        except:
            return 0

    def get_total_cost(self):
        """è·å–æ€»æˆæœ¬"""
        if self.backtest:
            return self._total_cost
        try:
            pos = position_holding_qty(self.stock)
            avg_cost = position_cost(self.stock, cost_price_model=CostPriceModel.AVG)
            return pos * avg_cost
        except:
            return 0.0

    def get_avg_cost(self):
        """è·å–å¹³å‡æˆæœ¬"""
        if self.backtest:
            return self._total_cost / self._position if self._position > 0 else 0.0
        try:
            return position_cost(self.stock, cost_price_model=CostPriceModel.AVG)
        except:
            return 0.0
class Strategy(StrategyBase):
    """ç¬¬ä¸€å±‚ï¼šå…è´¹åŸºç¡€å®šæŠ•ç­–ç•¥
    
    ä¸“ä¸ºè§£å†³Moomooç”¨æˆ·å®šæŠ•ç—›ç‚¹è®¾è®¡çš„å¼€æºç­–ç•¥
    - ç®€åŒ–é…ç½®ï¼Œä¸€é”®å¯ç”¨
    - 3å±‚å›æ’¤åŠ ä»“ä¿æŠ¤
    - å®Œå–„çš„é£é™©æ§åˆ¶
    - æ”¯æŒå›æµ‹å’Œå®ç›˜
    """

    def initialize(self):
        """åˆå§‹åŒ–ç­–ç•¥"""
        try:
            self._version = "v2.0.0-Free"
            self._tier = "å…è´¹åŸºç¡€ç‰ˆ"
            self._description = (
                "ğŸ†“ å…è´¹åŸºç¡€å®šæŠ•ç­–ç•¥ - è§£å†³Moomooå®šæŠ•ç—›ç‚¹\n"
                "âœ… å›ºå®šå‘¨æœŸæ™ºèƒ½å®šæŠ•\n" 
                "âœ… 3å±‚å›æ’¤åŠ ä»“ä¿æŠ¤ (5%/10%/20%)\n"
                "âœ… å®Œå–„é£é™©æ§åˆ¶ç³»ç»Ÿ\n"
                "âœ… é¢„è®¾å‚æ•°æ¨¡æ¿ï¼Œä¸€é”®å¯ç”¨\n"
                "ğŸ’¡ å‡çº§ä»˜è´¹ç‰ˆå¯è·å¾—8å±‚å›æ’¤+æˆæœ¬å®šæŠ•ç®—æ³•"
            )
            
            self.trigger_symbols()
            self.custom_indicator()
            self.global_variables()
            self.setup_presets()
            self.print_welcome()
            
            # æ ¸å¿ƒçŠ¶æ€å˜é‡
            self.current_drawdown_layer = 0
            self.last_investment_time = None
            self.highest_price = None
            
            # å›æµ‹æ”¯æŒ
            import collections
            self.high_queue = collections.deque(maxlen=20)
            self.virtual_balance = 1e6 if self.backtest else None
            self._position = 0
            self._total_cost = 0.0
            
        except Exception as e:
            print(f"âŒ åˆå§‹åŒ–å¤±è´¥: {str(e)}")

    def trigger_symbols(self):
        """è®¾ç½®äº¤æ˜“æ ‡çš„"""
        try:
            self.stock = declare_trig_symbol()
            print(f"ğŸ“ˆ äº¤æ˜“æ ‡çš„: {self.stock}")
        except Exception as e:
            print(f"âŒ æ ‡çš„è®¾ç½®å¤±è´¥: {str(e)}")

    def custom_indicator(self):
        """æ³¨å†Œè‡ªå®šä¹‰æŠ€æœ¯æŒ‡æ ‡"""
        try:
            # æ³¨å†Œä¸€ä¸ªç®€å•çš„ç§»åŠ¨å¹³å‡çº¿æŒ‡æ ‡ä¾›å‚è€ƒ
            self.register_indicator(
                indicator_name='MA',
                script='MA5:MA(CLOSE,5),COLORFF8D1E;',
                param_list=[]
            )
            print("ğŸ“Š æŠ€æœ¯æŒ‡æ ‡æ³¨å†Œå®Œæˆ")
        except Exception as e:
            print(f"âŒ æŠ€æœ¯æŒ‡æ ‡æ³¨å†Œå¤±è´¥: {str(e)}")

    def global_variables(self):
        """å…¨å±€å˜é‡è®¾ç½® - ç®€åŒ–ç‰ˆ"""
        try:
            # é¢„è®¾æ¨¡æ¿é€‰æ‹©
            self.preset_mode = show_variable(1, GlobalType.INT)  # 1=ä¿å®ˆ 2=å¹³è¡¡ 3=ç§¯æ
            
            # åŸºç¡€å‚æ•°ï¼ˆåœ¨é¢„è®¾åŸºç¡€ä¸Šå¯å¾®è°ƒï¼‰
            self.qty = show_variable(20, GlobalType.INT)  # æ¯æ¬¡å®šæŠ•è‚¡æ•°
            self.interval_min = show_variable(1440, GlobalType.INT)  # å®šæŠ•å‘¨æœŸï¼ˆåˆ†é’Ÿï¼‰
            
            # åŠŸèƒ½å¼€å…³
            self.backtest = show_variable(True, GlobalType.BOOL)  # å›æµ‹æ¨¡å¼
            self.basic_invest_only = show_variable(False, GlobalType.BOOL)  # ä»…å®šæŠ•æ¨¡å¼
            
            # å…è´¹ç‰ˆå›ºå®šå‚æ•°ï¼ˆä¸å¯é…ç½®ï¼‰
            self.drawdown_layers = [5.0, 10.0, 20.0]  # 3å±‚å›æ’¤é˜ˆå€¼
            self.drawdown_multipliers = [1.5, 2.0, 3.0]  # å¯¹åº”åŠ ä»“å€æ•°
            self.extreme_drawdown_pct = 50.0  # æç«¯å›æ’¤ä¿æŠ¤
            self.log_level = 0  # ç®€åŒ–æ—¥å¿—
            
            print(f"âš™ï¸ å‚æ•°é…ç½®å®Œæˆ")
            
        except Exception as e:
            print(f"âŒ å‚æ•°è®¾ç½®å¤±è´¥: {str(e)}")

    def setup_presets(self):
        """è®¾ç½®é¢„è®¾æ¨¡æ¿"""
        presets = {
            1: {  # ä¿å®ˆå‹
                "name": "ä¿å®ˆå‹",
                "description": "ä½é£é™©ï¼Œé€‚åˆç¨³å¥æŠ•èµ„è€…",
                "base_qty": 10,
                "interval": 10080,  # 1å‘¨
                "risk_level": "ä½"
            },
            2: {  # å¹³è¡¡å‹  
                "name": "å¹³è¡¡å‹",
                "description": "ä¸­ç­‰é£é™©æ”¶ç›Šï¼Œé€‚åˆå¤§å¤šæ•°ç”¨æˆ·", 
                "base_qty": 20,
                "interval": 1440,  # 1å¤©
                "risk_level": "ä¸­"
            },
            3: {  # ç§¯æå‹
                "name": "ç§¯æå‹", 
                "description": "é«˜é¢‘äº¤æ˜“ï¼Œé€‚åˆé£é™©æ‰¿å—èƒ½åŠ›å¼ºçš„ç”¨æˆ·",
                "base_qty": 50,
                "interval": 60,  # 1å°æ—¶
                "risk_level": "é«˜"
            }
        }
        
        if self.preset_mode in presets:
            preset = presets[self.preset_mode]
            self.preset_name = preset["name"]
            self.preset_desc = preset["description"] 
            self.risk_level = preset["risk_level"]
            
            # åº”ç”¨é¢„è®¾ï¼ˆå¦‚æœç”¨æˆ·æœªä¿®æ”¹é»˜è®¤å€¼ï¼‰
            if self.qty == 20:  # é»˜è®¤å€¼ï¼Œåº”ç”¨é¢„è®¾
                self.qty = preset["base_qty"]
            if self.interval_min == 1440:  # é»˜è®¤å€¼ï¼Œåº”ç”¨é¢„è®¾  
                self.interval_min = preset["interval"]
        else:
            self.preset_name = "è‡ªå®šä¹‰"
            self.preset_desc = "ç”¨æˆ·è‡ªå®šä¹‰å‚æ•°"
            self.risk_level = "æœªçŸ¥"

    def print_welcome(self):
        """æ‰“å°æ¬¢è¿ä¿¡æ¯"""
        print("\n" + "="*60)
        print(f"ğŸš€ {self._tier} {self._version}")
        print("="*60)
        print(self._description)
        print("\nğŸ“Š å½“å‰é…ç½®:")
        print(f"   æ¨¡æ¿: {self.preset_name} ({self.preset_desc})")
        print(f"   é£é™©ç­‰çº§: {self.risk_level}")
        print(f"   å®šæŠ•æ•°é‡: {self.qty}è‚¡")
        print(f"   å®šæŠ•å‘¨æœŸ: {self.interval_min}åˆ†é’Ÿ ({self._get_interval_desc()})")
        print(f"   å›æ’¤ä¿æŠ¤: {len(self.drawdown_layers)}å±‚ {self.drawdown_layers}")
        print(f"   è¿è¡Œæ¨¡å¼: {'å›æµ‹' if self.backtest else 'å®ç›˜'}")
        print("\nğŸ’¡ æç¤º: å¦‚éœ€8å±‚å›æ’¤+æˆæœ¬å®šæŠ•ç®—æ³•ï¼Œå¯è”ç³»ä½œè€…è·å–ä»˜è´¹ç‰ˆ")
        print("="*60 + "\n")

    def _get_interval_desc(self):
        """è·å–å‘¨æœŸæè¿°"""
        if self.interval_min == 60:
            return "1å°æ—¶"
        elif self.interval_min == 1440:
            return "1å¤©"
        elif self.interval_min == 10080:
            return "1å‘¨"
        else:
            return f"{self.interval_min}åˆ†é’Ÿ"

    def handle_data(self):
        """ä¸»è¦äº¤æ˜“é€»è¾‘"""
        try:
            current_time = device_time(TimeZone.DEVICE_TIME_ZONE)
            latest_price, highest_price, account_balance = self.get_market_data()
            
            # è®¡ç®—å›æ’¤å’ŒæŒä»“ä¿¡æ¯
            drawdown = self.calculate_drawdown(latest_price)
            position = self.get_position()
            total_cost = self.get_total_cost()
            average_cost = self.get_avg_cost()
            market_value = position * latest_price
            profit = market_value - total_cost
            
            if self.log_level >= 1:
                print(f"ğŸ“Š å¸‚åœºæ•°æ®: ä»·æ ¼={latest_price:.2f}, å›æ’¤={drawdown:.2f}%, æŒä»“={position}, æˆæœ¬={average_cost:.2f}, ç›ˆäº={profit:.2f}")

            # å…è´¹ç‰ˆç­–ç•¥é€»è¾‘
            if self.basic_invest_only:
                # çº¯å®šæŠ•æ¨¡å¼
                if self.should_invest(current_time):
                    self.execute_investment(latest_price, account_balance, self.qty, "å®šæŠ•")
                return

            # æç«¯å›æ’¤ä¿æŠ¤
            if drawdown >= self.extreme_drawdown_pct:
                print(f"âš ï¸ æç«¯å›æ’¤ä¿æŠ¤è§¦å‘ ({drawdown:.2f}% >= {self.extreme_drawdown_pct}%)")
                if self.should_invest(current_time):
                    self.execute_investment(latest_price, account_balance, self.qty, "æç«¯å›æ’¤-ä»…å®šæŠ•")
                return

            # åˆ†å±‚å›æ’¤åŠ ä»“é€»è¾‘
            add_qty = self.calculate_add_position_qty(drawdown)
            if add_qty > 0:
                self.execute_investment(latest_price, account_balance, add_qty, "å›æ’¤åŠ ä»“")
                return

            # å¸¸è§„å®šæŠ•
            if self.should_invest(current_time):
                self.execute_investment(latest_price, account_balance, self.qty, "å®šæœŸå®šæŠ•")

        except Exception as e:
            import traceback
            error_msg = str(e) if str(e) else "æœªçŸ¥é”™è¯¯"
            print(f"âŒ ç­–ç•¥æ‰§è¡Œé”™è¯¯: {error_msg}")
            print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")

    def get_market_data(self):
        """è·å–å¸‚åœºæ•°æ®"""
        if self.backtest:
            # å›æµ‹æ¨¡å¼
            try:
                if not hasattr(self, 'bar_index'):
                    self.bar_index = 0
                self.bar_index += 1
                
                latest_price = bar_close(self.stock, bar_type=BarType.D1, select=1)
                if latest_price is None or latest_price <= 0:
                    print(f"âš ï¸ è·å–ä»·æ ¼å¤±è´¥ï¼Œä½¿ç”¨ä¸Šä¸€ä»·æ ¼")
                    if hasattr(self, 'last_price') and self.last_price > 0:
                        latest_price = self.last_price
                    else:
                        latest_price = 100.0  # é»˜è®¤ä»·æ ¼
                else:
                    self.last_price = latest_price
                
                self.high_queue.append(latest_price)
                
                # ä½¿ç”¨æ¡ä»¶åˆ¤æ–­æ›¿ä»£min()å‡½æ•°
                available_days = self.bar_index if self.bar_index < 20 else 20
                high_list = list(self.high_queue)[-available_days:]
                if len(high_list) == 0:
                    highest_price = latest_price
                elif len(high_list) == 1:
                    highest_price = high_list[0]
                else:
                    # ä½¿ç”¨Moomooæ”¯æŒçš„max()å‡½æ•°æ ¼å¼ï¼Œä¼ å…¥å…·ä½“æ•°å€¼
                    highest_price = high_list[0]
                    for price in high_list[1:]:
                        if price > highest_price:
                            highest_price = price
                
                account_balance = self.virtual_balance
                return latest_price, highest_price, account_balance
            except Exception as e:
                print(f"å›æµ‹æ•°æ®è·å–é”™è¯¯: {str(e)}")
                # è¿”å›é»˜è®¤å€¼é¿å…ç­–ç•¥å´©æºƒ
                return 100.0, 100.0, self.virtual_balance
        else:
            # å®ç›˜æ¨¡å¼
            try:
                latest_price = current_price(self.stock, price_type=THType.FTH)
                if latest_price is None or latest_price <= 0:
                    print(f"âš ï¸ å®ç›˜ä»·æ ¼è·å–å¤±è´¥")
                    latest_price = 100.0  # ä½¿ç”¨é»˜è®¤ä»·æ ¼
                
                high_list = [bar_high(self.stock, bar_type=BarType.D1, select=i) for i in range(1, 21)]
                # å¤„ç†å¯èƒ½çš„Noneå€¼å¹¶æ‰¾å‡ºæœ€å¤§å€¼
                valid_highs = [h for h in high_list if h is not None]
                if len(valid_highs) == 0:
                    highest_price = latest_price
                elif len(valid_highs) == 1:
                    highest_price = valid_highs[0]
                else:
                    highest_price = valid_highs[0]
                    for price in valid_highs[1:]:
                        if price > highest_price:
                            highest_price = price
                
                account_balance = total_cash(currency=Currency.USD)
                return latest_price, highest_price, account_balance
            except Exception as e:
                print(f"å®ç›˜æ•°æ®è·å–é”™è¯¯: {str(e)}")
                # è¿”å›é»˜è®¤å€¼é¿å…ç­–ç•¥å´©æºƒ
                return 100.0, 100.0, 10000.0

    def calculate_drawdown(self, latest_price):
        """è®¡ç®—å›æ’¤å¹…åº¦"""
        if self.highest_price is None:
            self.highest_price = latest_price
        # ä½¿ç”¨æ¡ä»¶åˆ¤æ–­æ›¿ä»£max()å‡½æ•°
        if latest_price > self.highest_price:
            self.highest_price = latest_price
        return (self.highest_price - latest_price) / self.highest_price * 100

    def calculate_add_position_qty(self, drawdown):
        """è®¡ç®—åŠ ä»“æ•°é‡ - å…è´¹ç‰ˆ3å±‚"""
        for i, threshold in enumerate(self.drawdown_layers):
            if drawdown >= threshold:
                # æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨è¿™ä¸ªå±‚çº§æˆ–æ›´é«˜å±‚çº§åŠ è¿‡ä»“
                if i <= self.current_drawdown_layer:
                    continue
                    
                # è§¦å‘æ–°çš„åŠ ä»“å±‚çº§
                self.current_drawdown_layer = i
                add_qty = int(self.qty * self.drawdown_multipliers[i])
                
                print(f"ğŸ¯ å›æ’¤åŠ ä»“è§¦å‘: ç¬¬{i+1}å±‚ ({threshold}%), å€æ•°={self.drawdown_multipliers[i]}x, æ•°é‡={add_qty}è‚¡")
                return add_qty
        
        return 0

    def should_invest(self, current_time):
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥å®šæŠ•"""
        if self.last_investment_time is None:
            return True
        elapsed = (current_time - self.last_investment_time).total_seconds() / 60
        return elapsed >= self.interval_min

    def execute_investment(self, latest_price, account_balance, quantity, trade_type="å®šæŠ•"):
        """æ‰§è¡ŒæŠ•èµ„"""
        # å‚æ•°åˆæ³•æ€§æ£€æŸ¥
        if quantity < 10 or quantity > 1000 or quantity % 10 != 0:
            print(f"âš ï¸ å‚æ•°ä¿®æ­£: æŠ•èµ„æ•°é‡ {quantity} -> 20è‚¡")
            quantity = 20

        if self.backtest:
            # å›æµ‹æ¨¡å¼
            required_cash = quantity * latest_price
            if required_cash > self.virtual_balance:
                print(f"ğŸ’° è™šæ‹Ÿä½™é¢ä¸è¶³: éœ€è¦${required_cash:.2f}, å¯ç”¨${self.virtual_balance:.2f}")
                return

            # ä½¿ç”¨å¸‚ä»·ä¹°å…¥ï¼ˆè®¾ç½®ä»·æ ¼ä¸ºå½“å‰ä»·æ ¼çš„1.01å€ç¡®ä¿æˆäº¤ï¼‰
            market_price = latest_price * 1.01
            order_id = place_limit(self.stock, market_price, quantity, OrderSide.BUY, TimeInForce.DAY)
            self.virtual_balance -= required_cash
            self._total_cost += required_cash
            self._position += quantity
            
            print(f"âœ… {trade_type}æˆåŠŸ: {quantity}è‚¡ @ ${latest_price:.2f}, ä½™é¢=${self.virtual_balance:.2f}")
            
        else:
            # å®ç›˜æ¨¡å¼
            required_cash = quantity * latest_price
            if required_cash > account_balance:
                # èµ„é‡‘ä¸è¶³ï¼ŒæŒ‰å¯ç”¨èµ„é‡‘è°ƒæ•´æ•°é‡
                max_qty = int((account_balance // latest_price) // 10 * 10)
                if max_qty < 10:
                    print(f"ğŸ’° èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•æŠ•èµ„")
                    return
                quantity = max_qty
                print(f"âš ï¸ èµ„é‡‘è°ƒæ•´: æŠ•èµ„æ•°é‡è°ƒæ•´ä¸º {quantity}è‚¡")

            # ä½¿ç”¨å¸‚ä»·ä¹°å…¥ï¼ˆè®¾ç½®ä»·æ ¼ä¸ºå½“å‰ä»·æ ¼çš„1.01å€ç¡®ä¿æˆäº¤ï¼‰
            market_price = latest_price * 1.01
            order_id = place_limit(self.stock, market_price, quantity, OrderSide.BUY, TimeInForce.DAY)
            print(f"âœ… {trade_type}è®¢å•: {quantity}è‚¡ @ å¸‚ä»·, è®¢å•å·: {order_id}")

        self.last_investment_time = device_time(TimeZone.DEVICE_TIME_ZONE)

    def get_position(self):
        """è·å–æŒä»“æ•°é‡"""
        if self.backtest:
            return self._position
        try:
            return position_holding_qty(self.stock)
        except:
            return 0

    def get_total_cost(self):
        """è·å–æ€»æˆæœ¬"""
        if self.backtest:
            return self._total_cost
        try:
            pos = position_holding_qty(self.stock)
            avg_cost = position_cost(self.stock, cost_price_model=CostPriceModel.AVG)
            return pos * avg_cost
        except:
            return 0.0

    def get_avg_cost(self):
        """è·å–å¹³å‡æˆæœ¬"""
        if self.backtest:
            return self._total_cost / self._position if self._position > 0 else 0.0
        try:
            return position_cost(self.stock, cost_price_model=CostPriceModel.AVG)
        except:
            return 0.0
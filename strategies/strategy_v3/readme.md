# 网格交易策略分析 V5.3.11

## 风险声明

**本策略仅供学习交流，不构成任何投资建议。** 使用本策略进行交易，**风险自担**。

**请注意以下风险：**

* **历史数据不可靠：** 策略基于历史数据开发，未来市场行情可能发生变化，策略效果无法保证。
* **参数敏感性：** 策略对参数设置非常敏感，参数调整不当可能导致严重亏损。
* **系统风险：** 交易系统故障、网络延迟等因素可能导致交易失败或造成损失。
* **市场风险：** 市场波动、政策变化等不可预见因素可能对策略产生重大影响。
* **代码缺陷：** 代码中可能存在未知的错误或漏洞，导致交易异常。

**免责声明：** 本作者及代码贡献者对因使用本策略产生的任何损失概不负责。

**建议：**

* **纸上交易测试：** 在将策略应用于真实交易之前，建议先进行充分的纸上交易测试。
* **小额实盘测试：** 在真实交易中，建议从小额资金开始，逐步增加
* **风险控制：** 设置合理的止损、止盈，并控制仓位，降低风险。
* **持续监控：** 定期监控市场变化和策略表现，及时调整策略。

**请务必在充分了解风险的基础上，谨慎使用本策略。**

## 1. 核心功能概述

这是一个基于网格交易法则的自动化交易策略，主要特点包括：  
- 使用统一的网格间距（`grid_percentage`）动态创建交易网格，支持上下对称分布  
- 采用线程安全的持仓和订单管理机制，确保数据一致性  
- 支持基于时间周期的交易频率控制  
- 包含完整的持仓验证和修正机制，确保系统记录与实际持仓同步  
- 采用批量卖出机制，提高止盈效率  
- 网格重置时保持持仓数据一致性，使用加权平均成本合并持仓  
- 支持高位网格管理，处理超出常规网格范围的持仓  
- 详细的日志记录系统，支持交易追踪和问题诊断  
- 支持从历史成交记录恢复持仓状态  
- **(V5.3新增)** 支持"隔离模式"将已有仓位与策略分离，策略与实际持仓不再强制匹配，允许手动或其他途径保留已有仓位
- **(V5.3.5新增)** 引入价格偏移量以避免相邻网格的实际成交价过于接近，并实现金字塔加仓策略，根据网格层级调整每次的交易数量
- **(V5.3.6新增)** 合并部分功能重叠函数，20250209更新。
   - 统一了高位卖出和普通网格卖出的逻辑（\_execute\_sell\_order），减少重复代码
   - 将回测/实盘订单确认合并到 \_confirm\_order
   - 抽取网格生成逻辑到 \_generate\_grid\_prices，不再重复写循环
   - 将盈利检查卖出功能统一到 \_check\_profit\_and\_execute\_sell
   - 批量更新和单笔更新逻辑统一到 \_update\_position / \_batch\_update\_positions，显著减少重复
- **(V5.3.7新增)** 修订价格区间、持仓统计等错误，增加价格区间限制功能
- **(V5.3.8新增)** 修复持仓同步和隔离模式相关问题，默认启用隔离模式
- **(V5.3.9新增)** 优化批量卖出与批量持仓更新机制，提高高频行情下的执行效率，增强订单确认的健壮性，进一步减少极端行情下的持仓偏差。
- **(V5.3.10新增)**
   - 增强价格区间控制，买卖操作均严格受区间约束，支持动态调整区间参数。
   - 优化高位网格的盈利检查与批量卖出逻辑，提升止盈响应速度。
   - 精简和统一全部代码注释，所有风险、历史、参数说明迁移至本README，提升代码可维护性。
   - 完善异常处理与日志输出，便于排查极端行情下的持仓与订单问题。

### 1.1 已知问题描述（请一定要查看）
- 回测模式与实盘模式略有不同（主要考虑回测模式的成交确认和实盘的成交撮合不一样），特别实盘模式一定一定要小仓位先验证。
- 建议使用全新的账户进行操作后，再在主账户中进行实盘。
- 因为标的的价格、网格参数和市场价成交的关系，可能会存在接近价位成交确分布在不同网格的情况，请注意观察并调整参数。
- 建议始终开启隔离模式，这样能实现每次策略重启，忽视已有持仓，重新开始网格交易。
- 如果关闭隔离模式，可能会导致网格交易策略自动判断出持仓已有盈利而直接全部平仓的操作，一定要慎重。


## 2. 关键参数设置

### 2.1 策略参数

- `initial_capital`: 初始资金，默认 10000 美元  
- `max_total_position`: 最大总持仓限额，默认 500 股  
- `min_order_quantity`: 每次交易数量，默认 20 股  
- `position_limit`: 单网格持仓上限，默认 80 股  
- `time_interval`: 交易时间间隔(分钟)，默认 60 分钟  
- `grid_percentage`: 统一的网格间距和盈利标准，默认 3%  
- `grid_num`: 网格数量，默认 10 个  
- `max_capital_usage`: 最大资金使用率，默认 90%  
- `max_order_timeout`: 订单超时时间(秒)，默认 300 秒  

### 2.2 新增配置参数（V5及V5.3.11）

- `use_trade_records`: 是否使用成交记录恢复持仓，默认 True  
- `allow_intraday_trading`: 允许日内多次买卖/网格重置后立即买入，默认 True（V5.3.11合并参数）  

- `trade_record_days`: 成交记录查询天数(1-31)，默认 31 天  
- `position_sync_retry`: 持仓同步重试次数，默认 3 次
- `is_backtest`: 是否为回测模式，默认 False  
- `allow_intraday_trading`: 允许日内多次买卖/网格重置后立即买入，默认 True（V5.3.11合并参数）  
- `use_pyramid`: 是否使用金字塔加仓策略，默认 False  
- `use_isolation`: 是否启用隔离模式，默认 True（V5.3.8新增）  
- `use_price_range`: 是否启用价格区间限制，默认 True（V5.3.7新增）  
- `min_price_range`: 价格区间下限，默认 0.0  
- `max_price_range`: 价格区间上限，默认 999999.0  

### 2.3 参数约束关系

1. **单网格仓位控制**:
   ```plain
   单次开仓量(20股) * 最大加仓次数(4次) = 单网格持仓上限(80股)

   ```

2. 风险控制：
   ```
   - 总持仓限制：500股
   - 单网格最大资金占用：80股 * 当前价格
   - 网格间距 = 止盈比例(3%)，确保有合理盈利空间
   ```

## 3. 交易逻辑

### 3.1 网格管理
- 使用base_price为中心，生成对称分布的网格价位
- 网格间距由grid_percentage统一控制
- 当价格偏离网格超过grid_percentage时触发重置
- 网格重置时保护原有持仓，通过最近网格迁移机制保持持仓
- 支持高位网格管理，处理超出常规网格范围的持仓

### 3.2 建仓逻辑

- **日内交易模式/重置后立即买入**：
  - 由参数 `allow_intraday_trading` 统一控制。
  - 开启时：每个周期内可多次买卖，网格重置后可立即买入。
  - 关闭时：每个周期仅允许一次买卖，卖出后需等下一个周期才能再次买入，网格重置后不立即买入。
1. 建仓条件：
   - 总持仓未达到max_total_position
   - 目标网格持仓未达到position_limit
   - 符合当前周期交易频率限制
   - 价格位于有效网格范围内

2. 仓位管理：
   - 固定数量(min_order_quantity)建仓
   - 支持同一网格多次加仓
   - 实时维护持仓记录和成本数据
   - 支持高位网格持仓管理
   - 支持金字塔加仓策略

### 3.3 平仓逻辑
- 触发条件：网格收益率达到grid_percentage
- 支持多网格批量平仓，提高效率
- 采用市价单确保执行速度
- 平仓后自动在当前价格网格重新建仓
- 高位网格独立的平仓管理

## 4. 风险控制机制

### 4.1 持仓管理
- 使用线程锁(_position_lock)确保持仓操作原子性
- 定期验证持仓一致性(_verify_positions)
- 支持持仓自动修正(_verify_and_fix_positions)
- 支持从历史成交记录恢复持仓状态
- 详细记录每个网格的交易历史
- 高位网格独立记录和管理

### 4.2 订单控制
- 使用线程锁(_order_lock)保证订单操作安全
- 订单超时监控和自动撤单机制
- 完整的订单状态跟踪和错误处理
- 支持订单重试和失败恢复

### 4.3 周期控制
- 基于time_interval控制交易频率
- 每个周期内限制买入和卖出次数
- 通过current_period_trades追踪周期内操作
- 防止过度交易和重复操作

### 4.4 数据一致性
- 完整的持仓验证机制
- 支持与实际交易记录核对
- 网格重置时的持仓完整性保护
- 异常情况下的数据恢复机制
- 支持多次持仓同步重试

## 5. 高级功能

### 5.1 持仓恢复机制
- 支持从历史成交记录恢复持仓状态
- 多级恢复策略：
  1. 优先使用成交记录恢复
  2. 尝试使用平均成本价恢复
  3. 最后使用强制同步机制

### 5.2 高位网格管理
- 独立管理超出常规网格范围的持仓
- 保持原有成本价和盈亏计算
- 支持高位网格的独立平仓机制
- 网格重置时的高位持仓保护

### 5.3 批量操作优化
- 支持多网格批量平仓
- 批量持仓更新机制
- 支持更新失败时的回滚操作
- 改进的持仓迁移算法

### 5.4 隔离模式 (V5.3.8 更新)
- 默认开启隔离模式：为了更好地处理持仓同步问题，现在默认启用隔离模式
- "手动仓位隔离"：在策略重启时，自动将所有现有持仓隔离到 manual_positions，使策略与真实持仓分离，并从零开始重新运行
- ignore_isolation 标识：根据全局变量 use_isolation 自动设置
- 虚拟持仓校验：在隔离模式下，策略仅统计"真实持仓 - 手动仓位"，将其视为"虚拟实际持仓"与网格持仓进行比对
- 应用场景：
   * 用户已有大量手动仓位，重启策略时希望"保留"该仓位又不影响网格自动交易
   * 允许策略在隔离外再独立买卖，保持最小干扰
   * 后续可自行决定是否手动或合并处理隔离仓位

### 5.5 金字塔加仓策略 (V5.3.5 新增)
- 支持金字塔加仓策略，根据网格层级调整每次的交易数量
- 金字塔加仓策略的参数可自行调整，目前参数为：[1, 1, 2, 2, 3, 3, 4, 4, 5, 5]
- 可在回测参数时设置：use_pyramid = True，开启金字塔加仓策略后会忽略单网格持仓上限

### 5.6 价格区间限制 (V5.3.7 新增)
- 支持设置交易价格区间，超出区间时暂停交易
- 可通过全局变量控制是否启用此功能
- 买入和卖出操作都会受到价格区间限制
- 有助于控制交易风险，避免在极端价格区间进行交易

## 6. 实盘应用建议

### 6.1 参数配置建议
- 根据标的特性调整网格间距和数量
- 合理设置持仓限制和资金使用率
- 建议开启成交记录恢复功能
- 根据实际情况调整交易周期

### 6.2 监控重点
- 定期检查持仓同步状态
- 关注高位网格的处理情况
- 监控网格重置时的持仓变化
- 注意批量操作的执行效果
- (V5.3) 检查隔离模式是否正常；避免无意中覆盖手动仓位

### 6.3 风险提示
- 及时处理持仓不一致情况
- 注意高位网格的风险控制
- 保持充足的资金缓冲
- 定期检查策略日志
- 隔离模式下要明确手动仓位所带来的实际风险

## 7. 日志系统

### 7.1 关键日志记录
- 策略初始化和参数设置
- 持仓状态和变更记录
- 订单执行和成交明细
- 网格重置和调整过程
- 异常情况和错误处理

### 7.2 状态诊断
- 网格状态可视化展示
- 持仓分布和成本分析
- 交易周期状态追踪
- 高位网格监控信息
- 隔离模式下的虚拟持仓信息

### 7.3 性能统计
- 交易成功率统计
- 持仓周转效率分析
- 资金使用率监控
- 网格利用率统计

## 8. 回测表现

### 8.1 MARA Holdings回测数据 (2024年8月)

**基本信息**
- 回测周期：2024/08/01 - 2024/08/30（月度回测）
- 标的：MARA Holdings (US.MARA)
- 交易频率：日K线，每日开盘
- 初始价格：19.72美元
- 结束价格：17.23美元（-12.6%）

**交易统计**
- 总交易次数：30笔
  - 买入：18笔
  - 卖出：12笔
- 最大持仓：200股
- 最小持仓：20股
- 平均持仓：约120股
- 网格使用率：约70%（所有网格中有持仓的比例）

**策略效果验证**

1. 动态网格管理
   - 成功应对13.93到19.72的大幅价格波动
   - 网格重置机制有效维持策略活性
   - 高位网格保护机制有效防护大跌风险

2. 止盈表现
   - 最大单笔止盈：25%（8月6日）
   - 平均止盈：5%-8%
   - 批量止盈成功执行3次

3. 风险控制
   - 单网格持仓严格控制在80股以内
   - 总持仓未超过200股限制
   - 持仓分布均衡，避免过度集中

4. 策略适应性
   - 对上涨行情：通过网格止盈获利
   - 对下跌行情：通过高位网格保护避免强制平仓
   - 对震荡行情：维持网格交易频率，持续创造盈利机会

### 8.2 策略特点验证

1. 仓位管理
   - 分步建仓策略有效控制风险
   - 动态调整持仓分布适应市场变化
   - 保持充足的建仓空间应对新机会

2. 成本控制
   - 通过网格迁移保持合理成本结构
   - 避免单个网格过度加仓
   - 维持整体持仓成本在可控范围

3. 交易执行
   - 订单成功率100%
   - 滑点控制在合理范围
   - 批量交易执行效率高

### 8.3 改进建议

1. 策略优化方向
   - 改进高位网格的平仓时机选择
   - 优化网格重置的触发条件
   - 提高资金使用效率

2. 运行效率
   - 完善批量交易机制
   - 优化持仓验证流程
   - 改进日志记录系统

3. 风控加强
   - 增加市场趋势判断
   - 完善极端情况的应对机制
   - 优化资金分配比例

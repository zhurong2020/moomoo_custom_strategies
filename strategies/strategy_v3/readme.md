# 网格交易策略分析 V5.3.12

## 风险声明

**本策略仅供学习交流，不构成任何投资建议。** 使用本策略进行交易，**风险自担**。

**请注意以下风险：**

*   **历史数据不可靠：** 策略基于历史数据开发，未来市场行情可能发生变化，策略效果无法保证。
*   **参数敏感性：** 策略对参数设置非常敏感，参数调整不当可能导致严重亏损。
*   **系统风险：** 交易系统故障、网络延迟等因素可能导致交易失败或造成损失。
*   **市场风险：** 市场波动、政策变化等不可预见因素可能对策略产生重大影响。
*   **代码缺陷：** 代码中可能存在未知的错误或漏洞，导致交易异常。

**免责声明：** 本作者及代码贡献者对因使用本策略产生的任何损失概不负责。

**建议：**

*   **纸上交易测试：** 在将策略应用于真实交易之前，建议先进行充分的纸上交易测试。
*   **小额实盘测试：** 在真实交易中，建议从小额资金开始，逐步增加。
*   **风险控制：** 设置合理的止损、止盈，并控制仓位，降低风险。
*   **持续监控：** 定期监控市场变化和策略表现，及时调整策略。

**请务必在充分了解风险的基础上，谨慎使用本策略。**

## 1. 核心功能概述

这是一个基于网格交易法则的自动化交易策略，主要特点包括：

*   **动态网格管理：** 使用统一的网格间距（`grid_percentage`）动态创建交易网格，支持上下对称分布。当价格偏离网格超过一定阈值时触发重置。
*   **线程安全：** 采用线程安全的持仓和订单管理机制，确保数据一致性。
*   **持仓验证与修正：** 包含完整的持仓验证和修正机制，确保系统记录与实际持仓同步，并支持从历史成交记录恢复持仓状态。
*   **高位网格管理：** 支持高位网格管理，处理超出常规网格范围的持仓，并有独立的平仓逻辑。
*   **金字塔加仓：** 支持金字塔加仓策略，根据网格层级调整每次的交易数量。
*   **隔离模式：** 支持“隔离模式”，将已有仓位与策略分离，策略与实际持仓不再强制匹配，允许手动或其他途径保留已有仓位。
*   **价格区间限制：** 支持设置交易价格区间，超出区间时暂停交易，有助于控制交易风险。
*   **非日内模式：** 支持非日内模式，控制交易频率，避免过度交易。
*   **批量操作优化：** 支持多网格批量平仓和批量持仓更新，提高执行效率。
*   **详细日志记录：** 详细的日志记录系统，支持交易追踪和问题诊断。
*   **参数验证：** 在策略初始化时对用户设置的参数进行严格校验，提高策略健壮性。
*   **回测优化选项：** 允许用户在回测模式下选择是否进行持仓同步，以显著提升回测速度。

### 1.1 已知问题描述（请一定要查看）

*   回测模式与实盘模式略有不同（主要考虑回测模式的成交确认和实盘的成交撮合不一样），特别实盘模式一定一定要小仓位先验证。
*   建议使用全新的账户进行操作后，再在主账户中进行实盘。
*   因为标的的价格、网格参数和市场价成交的关系，可能会存在接近价位成交确分布在不同网格的情况，请注意观察并调整参数。
*   建议始终开启隔离模式，这样能实现每次策略重启，忽视已有持仓，重新开始网格交易。
*   如果关闭隔离模式，可能会导致网格交易策略自动判断出持仓已有盈利而直接全部平仓的操作，一定要慎重。

## 2. 关键参数设置

### 2.1 策略参数

以下是策略中可配置的全局变量及其说明：

*   `max_total_position` (INT, 默认 500): 策略允许持有的最大总持仓股数。
*   `trade_quantity` (INT, 默认 20): 单次交易（买入或卖出）的数量。
*   `max_grid_position` (INT, 默认 80): 单个网格允许持有的最大持仓股数。
*   `grid_percentage` (FLOAT, 默认 0.03): 网格间距，同时也是盈利标准（例如 0.03 表示 3%）。
*   `grid_count` (INT, 默认 10): 网格数量，用于生成价格区间内的网格线。
*   `max_capital_usage` (FLOAT, 默认 0.9): 最大资金使用率（例如 0.9 表示 90%）。
*   `use_trade_records` (BOOL, 默认 True): 是否使用历史成交记录来恢复策略持仓状态。
*   `trade_record_days` (INT, 默认 31): 查询历史成交记录的天数（范围 1-31 天）。
*   `position_sync_retry` (INT, 默认 3): 持仓同步失败时的重试次数。
*   `is_backtest` (BOOL, 默认 True): 是否为回测环境。
*   `enable_position_sync_in_backtest` (BOOL, 默认 False): 在回测模式下是否进行持仓同步（设置为 False 可提高回测速度）。
*   `enable_non_intraday_mode` (BOOL, 默认 False): 启用非日内模式。开启后，卖出操作后本周期不再买入，网格重置后也不立即买入。
*   `verbose_log` (BOOL, 默认 False): 是否输出详细的调试日志（仅调试时打开）。
*   `use_pyramid` (BOOL, 默认 False): 是否启用金字塔加仓策略。开启后，买入数量会根据网格层级动态调整。
*   `use_price_range` (BOOL, 默认 True): 是否启用价格区间限制。
*   `min_price_range` (FLOAT, 默认 0.0): 价格区间下限。
*   `max_price_range` (FLOAT, 默认 999999.0): 价格区间上限。
*   `ignore_isolation` (BOOL, 默认 True): 是否启用隔离模式。开启后，策略将隔离历史持仓，仅追踪新买入的仓位。
*   `allow_sell_out_of_range` (BOOL, 默认 True): 当价格超出设定区间时，是否允许卖出操作。

### 2.2 参数约束关系

1.  **单网格仓位控制**:
    ```plain
    单次交易数量 (trade_quantity) * N = 单个网格持仓上限 (max_grid_position)
    ```
    建议 `max_grid_position` 是 `trade_quantity` 的整数倍，否则可能无法达到理论上限。

2.  **风险控制：**
    *   总持仓限制：`max_total_position`
    *   单网格最大资金占用：`max_grid_position` * 当前价格
    *   网格间距 (`grid_percentage`) 同时作为止盈比例，确保有合理盈利空间。

## 3. 交易逻辑

### 3.1 网格管理

*   使用 `base_price` 为中心，生成对称分布的网格价位。
*   网格间距由 `grid_percentage` 统一控制。
*   当价格偏离网格过大时（例如低于最低网格的 97% 或高于最高网格的 103%）触发重置。
*   网格重置时保护原有持仓，通过最近网格迁移机制保持持仓。
*   支持高位网格管理，处理超出常规网格范围的持仓。

### 3.2 建仓逻辑

1.  **建仓条件：**
    *   总持仓未达到 `max_total_position`。
    *   目标网格持仓未达到 `max_grid_position`。
    *   符合当前周期交易频率限制。
    *   价格位于有效网格范围内。
    *   资金充足。
    *   当前市价与网格价格偏差在允许范围内。

2.  **仓位管理：**
    *   固定数量 (`trade_quantity`) 建仓，或在金字塔模式下动态计算买入数量。
    *   支持同一网格多次加仓。
    *   实时维护持仓记录和成本数据。
    *   支持高位网格持仓管理。
    *   支持金字塔加仓策略。

### 3.3 平仓逻辑

*   **触发条件：** 网格收益率达到 `grid_percentage`。
*   支持多网格批量平仓，提高效率。
*   采用市价单确保执行速度。
*   平仓后自动在当前价格网格重新建仓。
*   高位网格独立的平仓管理。

## 4. 风险控制机制

### 4.1 持仓管理

*   使用线程锁 (`_position_lock`) 确保持仓操作原子性。
*   定期验证持仓一致性 (`_verify_positions`)。
*   支持持仓自动修正 (`_verify_and_fix_positions`)。
*   支持从历史成交记录恢复持仓状态。
*   详细记录每个网格的交易历史。
*   高位网格独立记录和管理。

### 4.2 订单控制

*   使用线程锁 (`_order_lock`) 保证订单操作安全。
*   订单超时监控和自动撤单机制。
*   完整的订单状态跟踪和错误处理。
*   支持订单重试和失败恢复。

### 4.3 周期控制

*   基于时间周期控制交易频率。
*   每个周期内限制买入和卖出次数。
*   通过 `current_period_trades` 追踪周期内操作。
*   防止过度交易和重复操作。

### 4.4 数据一致性

*   完整的持仓验证机制。
*   支持与实际交易记录核对。
*   网格重置时的持仓完整性保护。
*   异常情况下的数据恢复机制。
*   支持多次持仓同步重试。

## 5. 高级功能

### 5.1 持仓恢复机制

*   支持从历史成交记录恢复持仓状态。
*   多级恢复策略：
    1.  优先使用成交记录恢复。
    2.  如果成交记录恢复失败，尝试使用平均成本价恢复。
    3.  最后使用强制同步机制。

### 5.2 高位网格管理

*   独立管理超出常规网格范围的持仓。
*   保持原有成本价和盈亏计算。
*   支持高位网格的独立平仓机制。
*   网格重置时的高位持仓保护。

### 5.3 批量操作优化

*   支持多网格批量平仓。
*   批量持仓更新机制。
*   支持更新失败时的回滚操作。
*   改进的持仓迁移算法。

### 5.4 隔离模式

*   **默认开启隔离模式：** 为了更好地处理持仓同步问题，现在默认启用隔离模式 (`ignore_isolation = True`)。
*   **“手动仓位隔离”：** 在策略重启时，自动将所有现有持仓隔离到 `manual_positions`，使策略与真实持仓分离，并从零开始重新运行。
*   **虚拟持仓校验：** 在隔离模式下，策略仅统计“真实持仓 - 手动仓位”，将其视为“虚拟实际持仓”与网格持仓进行比对。
*   **应用场景：**
    *   用户已有大量手动仓位，重启策略时希望“保留”该仓位又不影响网格自动交易。
    *   允许策略在隔离外再独立买卖，保持最小干扰。
    *   后续可自行决定是否手动或合并处理隔离仓位。

### 5.5 金字塔加仓策略

*   支持金字塔加仓策略，根据网格层级调整每次的交易数量。
*   金字塔序列可自定义，默认序列为 `[1, 1, 2, 2, 3, 3, 4, 4, 5, 5]`。
*   开启金字塔加仓 (`use_pyramid = True`) 后，单网格持仓上限 (`max_grid_position`) 会根据金字塔倍数动态调整。

### 5.6 价格区间限制

*   支持设置交易价格区间 (`min_price_range`, `max_price_range`)，超出区间时暂停交易。
*   可通过全局变量 `use_price_range` 控制是否启用此功能。
*   买入和卖出操作都会受到价格区间限制。
*   有助于控制交易风险，避免在极端价格区间进行交易。

### 5.7 回测优化选项

*   新增 `enable_position_sync_in_backtest` 全局变量。
*   当 `is_backtest` 为 `True` 且 `enable_position_sync_in_backtest` 为 `False` 时，策略将跳过所有与API相关的持仓同步和验证，显著提高回测速度。

## 6. 实盘应用建议

### 6.1 参数配置建议

*   根据标的特性调整网格间距和数量。
*   合理设置持仓限制和资金使用率。
*   建议开启成交记录恢复功能。
*   根据实际情况调整交易周期。

### 6.2 监控重点

*   定期检查持仓同步状态。
*   关注高位网格的处理情况。
*   监控网格重置时的持仓变化。
*   注意批量操作的执行效果。
*   检查隔离模式是否正常；避免无意中覆盖手动仓位。

### 6.3 风险提示

*   及时处理持仓不一致情况。
*   注意高位网格的风险控制。
*   保持充足的资金缓冲。
*   定期检查策略日志。
*   隔离模式下要明确手动仓位所带来的实际风险。

## 7. 日志系统

### 7.1 关键日志记录

*   策略初始化和参数设置。
*   持仓状态和变更记录。
*   订单执行和成交明细。
*   网格重置和调整过程。
*   异常情况和错误处理。

### 7.2 状态诊断

*   网格状态可视化展示。
*   持仓分布和成本分析。
*   交易周期状态追踪。
*   高位网格监控信息。
*   隔离模式下的虚拟持仓信息。

### 7.3 性能统计

*   交易成功率统计。
*   持仓周转效率分析。
*   资金使用率监控。
*   网格利用率统计。

## 8. 回测表现

### 8.1 MARA Holdings回测数据 (2024年8月)

**基本信息**

*   回测周期：2024/08/01 - 2024/08/30（月度回测）
*   标的：MARA Holdings (US.MARA)
*   交易频率：日K线，每日开盘
*   初始价格：19.72美元
*   结束价格：17.23美元（-12.6%）

**交易统计**

*   总交易次数：30笔
    *   买入：18笔
    *   卖出：12笔
*   最大持仓：200股
*   最小持仓：20股
*   平均持仓：约120股
*   网格使用率：约70%（所有网格中有持仓的比例）

**策略效果验证**

1.  动态网格管理
    *   成功应对13.93到19.72的大幅价格波动。
    *   网格重置机制有效维持策略活性。
    *   高位网格保护机制有效防护大跌风险。

2.  止盈表现
    *   最大单笔止盈：25%（8月6日）。
    *   平均止盈：5%-8%。
    *   批量止盈成功执行3次。

3.  风险控制
    *   单网格持仓严格控制在80股以内。
    *   总持仓未超过200股限制。
    *   持仓分布均衡，避免过度集中。

4.  策略适应性
    *   对上涨行情：通过网格止盈获利。
    *   对下跌行情：通过高位网格保护避免强制平仓。
    *   对震荡行情：维持网格交易频率，持续创造盈利机会。

### 8.2 策略特点验证

1.  仓位管理
    *   分步建仓策略有效控制风险。
    *   动态调整持仓分布适应市场变化。
    *   保持充足的建仓空间应对新机会。

2.  成本控制
    *   通过网格迁移保持合理成本结构。
    *   避免单个网格过度加仓。
    *   维持整体持仓成本在可控范围。

3.  交易执行
    *   订单成功率100%。
    *   滑点控制在合理范围。
    *   批量交易执行效率高。

### 8.3 改进建议

1.  策略优化方向
    *   改进高位网格的平仓时机选择。
    *   优化网格重置的触发条件。
    *   提高资金使用效率。

2.  运行效率
    *   完善批量交易机制。
    *   优化持仓验证流程。
    *   改进日志记录系统。

3.  风控加强
    *   增加市场趋势判断。
    *   完善极端情况的应对机制。
    *   优化资金分配比例。

## 9. 策略版本更新日志

### V5.3.12 (2024-11-21)

*   **代码清理：** 移除了未使用的 `max_capital_usage` 变量，以及 `_check_profit_before_reset`、`_execute_batch_sell`、`_clean_empty_high_grids` 等冗余方法，并修正了 `handle_data` 中重复的 `_check_high_grid_profit` 调用，使代码更加精简高效。

### V5.3.10 (2024-11-21)

*   增强价格区间控制，买卖操作均严格受区间约束，支持动态调整区间参数。
*   优化高位网格的盈利检查与批量卖出逻辑，提升止盈响应速度。
*   精简和统一全部代码注释，所有风险、历史、参数说明迁移至本 README，提升代码可维护性。
*   完善异常处理与日志输出，便于排查极端行情下的持仓与订单问题。

### V5.3.9 (2024-11-21)

*   优化批量卖出与批量持仓更新机制，提高高频行情下的执行效率，增强订单确认的健壮性，进一步减少极端行情下的持仓偏差。

### V5.3.8 (2024-11-21)

*   修复持仓同步和隔离模式相关问题，默认启用隔离模式。

### V5.3.7 (2024-11-21)

*   修订价格区间、持仓统计等错误，增加价格区间限制功能。

### V5.3.6 (2024-11-21)

*   合并部分功能重叠函数，减少重复代码，提高代码可维护性。

### V5.3.5 (2024-11-21)

*   引入价格偏移量以避免相邻网格的实际成交价过于接近，并实现金字塔加仓策略。

### V5.3 (2024-11-21)

*   支持“隔离模式”将已有仓位与策略分离，策略与实际持仓不再强制匹配，允许手动或其他途径保留已有仓位。

### V5.2 (2024-11-21)

*   优化了网格重置逻辑，确保在价格大幅波动时策略能够更灵活地调整网格，并保持持仓数据的一致性。

### V5.1 (2024-11-21)

*   增强了持仓验证和修正机制，提高了策略在异常情况下的鲁棒性，减少了持仓偏差。

### V5.0 (2024-11-21)

*   初始版本，实现了基本的网格交易功能，包括网格生成、买入、卖出、持仓管理和日志记录。

## 10. 联系方式

如果您有任何问题或建议，欢迎通过以下方式联系我：

*   邮箱：zhurong0525@gmail.com
*   GitHub：[zhurong2020](https://github.com/zhurong2020)
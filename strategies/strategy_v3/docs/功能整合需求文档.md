# `20241121-v5.3.quant` 策略与 `grid-trading` App 技术对接文档

## 1. 文档概述

本文档旨在为 Windows 平台下的 `grid-trading` App 提供 Moomoo 客户端内 `20241121-v5.3.quant` 网格交易策略（以下简称“客户端策略”）的核心功能、逻辑和参数细节。其主要目的是作为 `grid-trading` App 进行功能移植、强化管理和高级功能开发的参考规范。

`grid-trading` App 将作为客户端策略的**功能扩展和高级管理平台**，负责实现 Moomoo 客户端内受限或无法实现的功能，包括但不限于：

*   强化持仓管理与交易管理。
*   实现本地文件读写（如日志、交易记录持久化）。
*   实现原需求文档中未能集成到客户端策略的更高级功能（如全面的风险控制、交易统计报告等）。
*   通过 Moomoo OpenD 接口实现 24/7 策略监控、实时通知等。

## 2. `20241121-v5.3.quant` 客户端策略核心功能与逻辑

`20241121-v5.3.quant` 策略（当前版本 `v5.3.13`）是基于 Moomoo 客户端框架实现的一个功能完善的网格交易策略。其核心设计理念是**稳定、健壮和功能聚焦**。以下是其已实现的主要功能及其内部逻辑概述，供 App 移植参考：

### 2.1 策略基本信息与参数管理

*   **策略版本：** `v5.3.13`。
*   **交易标的：** 通过 `declare_trig_symbol()` 动态获取，存储在 `self.stock`。
*   **技术指标：** 注册了 `MA` 指标 (`MA5:MA(CLOSE,5)`)，通过 `custom_indicator()` 方法实现。
*   **全局变量：** 所有用户可配置参数通过 `global_variables()` 方法定义，并使用 `show_variable()` 暴露给 Moomoo 客户端界面。App 应读取并映射这些参数。
    *   `max_total_position` (INT): 最大总持仓股数。
    *   `trade_quantity` (INT): 单次交易数量。
    *   `max_grid_position` (INT): 单个网格持仓上限。
    *   `grid_percentage` (FLOAT): 网格间距/盈利标准。
    *   `grid_count` (INT): 网格数量。
    *   `use_trade_records` (BOOL): 是否使用成交记录恢复持仓。
    *   `trade_record_days` (INT): 成交记录查询天数 (1-31)。
    *   `position_sync_retry` (INT): 持仓同步重试次数。
    *   `is_backtest` (BOOL): 是否回测环境。
    *   `enable_position_sync_in_backtest` (BOOL): 回测时是否进行持仓同步（优化回测速度）。
    *   `enable_non_intraday_mode` (BOOL): 启用非日内模式（卖出后本周期不买入）。
    *   `verbose_log` (BOOL): 是否输出详细调试日志。
    *   `use_pyramid` (BOOL): 是否启用金字塔加仓。
    *   `use_price_range` (BOOL): 启用价格区间限制。
    *   `min_price_range` (FLOAT): 价格区间下限。
    *   `max_price_range` (FLOAT): 价格区间上限。
    *   `ignore_isolation` (BOOL): 启用隔离模式。
    *   `allow_sell_out_of_range` (BOOL): 价格区间外允许卖出。
    *   `price_deviation_tolerance_multiplier` (FLOAT): 市价与网格价格偏离容忍度乘数 (0-1)。
*   **参数验证：** `_check_parameters()` 方法在初始化时对上述参数进行合理性校验，确保策略配置的有效性。

### 2.2 网格管理与持仓逻辑

*   **网格初始化与重置：** `_initialize_grids(base_price)` 方法根据基准价格、网格间距和数量动态生成网格价格列表 (`self.grid_prices`)。当价格偏离网格过大 (`_should_reset_grid`) 时会触发重置，并主动清理下方盈利持仓 (`_clear_all_profitable`)。
*   **持仓数据结构：**
    *   `self.positions`: 记录每个网格的持仓数量。
    *   `self.position_records`: 记录每个网格的交易详情（买入价、数量、更新时间）。
    *   `self.high_positions` / `self.high_records`: 记录高位网格持仓（价格高于当前所有网格的持仓）。
    *   `self.manual_positions` / `self.manual_records`: 记录历史隔离持仓。
    *   `self.total_position`: 策略总持仓。
*   **持仓恢复：** `_recover_positions()` 方法在隔离模式下启动时，尝试将账户现有持仓隔离。`_get_positions_from_trades()` 方法可从历史成交记录中恢复持仓分布。
*   **持仓验证与修正：** `check_strategy_status()` 和 `_verify_positions()` 定期校验策略内部持仓与 Moomoo API 返回的实际持仓一致性，并尝试通过 `_verify_and_fix_positions()` 和 `_force_sync_position()` 进行修正。
*   **持仓更新：** `_update_position()` 方法用于买卖后更新本地持仓记录，支持加权平均成本计算。`_batch_update_positions()` 支持批量更新。
*   **持仓迁移：** `_migrate_positions_to_new_grids()` 用于网格重置时，将原有持仓迁移到新的网格结构中。

### 2.3 交易执行逻辑

*   **交易周期控制：** `_is_new_period()` 和 `_can_trade_in_period()` 控制交易频率，防止过度交易。`enable_non_intraday_mode` 参数影响日内买卖行为。
*   **买入逻辑：** `_place_buy_order()` 方法负责买入操作。
    *   检查价格是否在允许区间内 (`_is_price_in_range`)。
    *   检查资金是否充足 (`total_cash`)。
    *   计算买入数量（考虑 `trade_quantity`、`max_grid_position`、`max_total_position` 和金字塔加仓 `_calculate_trade_quantity`）。
    *   获取实时买一价 (`ask`) 进行二次验证。
    *   **价格偏差控制：** 根据 `price_deviation_tolerance_multiplier` 检查市价与网格价格的偏离，超出容忍度则不买入。
    *   通过 `_place_order()` 调用 `place_market()` 下市价单。
    *   等待订单成交 (`_confirm_order`) 并更新持仓。
*   **卖出逻辑：** `_check_and_execute_sell()` 检查是否有盈利网格可平仓。`_execute_sell_order()` 执行卖出操作。高位网格的盈利检查通过 `_check_high_grid_profit()` 实现。
*   **订单管理：** `_place_order()` 统一处理下单。`self.order_records` 和 `self.pending_orders` 跟踪订单状态。

## 3. `grid-trading` App 职责与高级功能实现

`grid-trading` App 将在客户端策略提供的核心交易逻辑基础上，通过 Moomoo OpenD 接口实现更强大、更灵活的功能，弥补客户端策略的限制。

### 3.1 数据源与 API 交互

*   App 将通过 **Moomoo OpenD 接口**获取实时行情、账户信息、持仓数据、历史成交记录等，并进行订单的提交、查询和撤销。
*   App 应负责处理 OpenD 的连接管理、认证、数据解析和错误处理。

### 3.2 强化持仓管理

*   **持久化持仓数据：** App 将负责将客户端策略的 `self.positions`, `self.position_records`, `self.high_positions`, `self.high_records`, `self.manual_positions`, `self.manual_records` 等数据结构**持久化到本地文件**（如 JSON, SQLite 数据库），确保策略重启或 App 重启后能快速恢复状态，并支持历史回溯。
*   **跨策略持仓汇总与分析：** App 可以汇总多个策略的持仓，提供更全面的账户持仓视图和盈亏分析。
*   **更灵活的持仓调整：** App 可以提供用户界面，允许用户手动调整网格持仓、隔离仓位，并同步更新到 App 的持久化数据和 Moomoo 平台。

### 3.3 强化交易管理

*   **交易统计与报告：** App 将记录每笔交易的详细信息（买入/卖出价格、数量、时间、盈亏、滑点等），并生成**丰富的交易报告**（如日/周/月盈亏、胜率、最大回撤、交易频率等）。这对应原需求文档中的 **#9 交易统计与报告**。
*   **更精细的订单类型控制：** App 可以实现更智能的限价单处理逻辑，例如：
    *   **限价优先，市价兜底：** 尝试提交限价单，若在规定时间内未成交或未完全成交，则自动撤销并以市价单（或新的限价单）重新提交，同时进行严格的价格偏差检查。这能有效解决客户端策略中市价单滑点问题。
    *   **冰山订单、条件订单**等高级订单类型。
*   **盈利机会排序：** App 可以在检测到多个盈利网格时，根据用户配置（例如按盈利金额、盈利比例、持仓时间等）对它们进行排序，并优先执行平仓操作。这对应原需求文档中的 **#5 盈利机会排序**。

### 3.4 高级风险控制

*   **最大亏损限制：** App 将监控账户或单个策略的实时亏损，当达到预设的最大亏损比例时，自动暂停交易或强制平仓。这对应原需求文档中的 **#10 风险控制机制**。
*   **每日交易量限制：** App 可以限制每日的总交易量或交易笔数，防止过度交易。
*   **回撤检测与调整：** App 将实现市场回撤的实时检测，并根据回撤幅度动态调整策略参数（如增加买入量、调整网格间距、暂停交易等）。这对应原需求文档中的 **#6 回撤检测与调整**。
*   **动态盈利阈值：** App 可以根据市场波动率、趋势等因素，动态调整策略的盈利阈值，以适应不同的市场环境。这对应原需求文档中的 **#8 动态盈利阈值**。
*   **波动率过滤：** App 可以根据标的波动率来决定是否进行交易或调整交易参数。

### 3.5 文件读写功能

*   App 将负责所有本地文件读写操作，包括：
    *   **配置持久化：** 保存和加载策略配置、用户偏好设置。
    *   **日志记录：** 写入详细的交易日志、错误日志到本地文件。
    *   **数据存储：** 存储历史行情数据、交易记录、持仓快照等，用于分析和回溯。

### 3.6 用户界面与交互

*   App 将提供一个直观的用户界面，用于：
    *   实时监控策略运行状态、持仓、盈亏。
    *   动态调整策略参数。
    *   查看交易报告和历史数据。
    *   接收实时通知（如订单成交、风险预警）。

## 4. 功能移植与开发建议

### 4.1 移植核心逻辑

*   **网格生成算法：** App 应移植客户端策略中 `_initialize_grids` 和 `_generate_grid_prices` 的核心网格生成算法。
*   **持仓更新逻辑：** `_update_position` 和 `_batch_update_positions` 中的持仓合并、成本计算逻辑是通用的，可移植到 App 中。
*   **订单处理流程：** `_place_order` 和 `_confirm_order` 的基本流程可作为 App 订单模块的参考，但 App 应在此基础上进行强化。
*   **参数映射：** App 应建立客户端策略参数与 App 内部配置的清晰映射关系。

### 4.2 API 差异与适配

*   **Moomoo 客户端 API vs. OpenD API：** 客户端策略使用的是 Moomoo 客户端内置的量化 API，而 App 将使用 Moomoo OpenD API。两者在函数名称、参数、返回结构上可能存在差异，App 需进行适配层开发。
*   **异步处理：** OpenD API 通常是异步的，App 在设计时需充分考虑异步编程模型，确保数据流和订单处理的顺畅。

### 4.3 模块化设计

*   建议 `grid-trading` App 在设计时采用高度模块化的架构，将数据层、业务逻辑层、UI 层和 Moomoo API 适配层分离，便于维护和功能扩展。

## 5. 结论

`20241121-v5.3.quant` 客户端策略为 `grid-trading` App 提供了坚实的核心交易逻辑基础。通过将客户端策略的稳定功能进行移植，并由 App 负责实现更高级的持仓管理、交易管理、风险控制和数据持久化，我们将能够构建一个功能强大、灵活且用户友好的网格交易解决方案。这份文档将作为 App 开发团队进行功能移植和未来高级功能开发的蓝图。
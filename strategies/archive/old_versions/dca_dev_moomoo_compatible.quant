class Strategy(StrategyBase):
    """æ··åˆå¼€å‘ç‰ˆDCAå®šæŠ•ç­–ç•¥ - v2.2.5-EnhancedParams
    
    åŒ…å«å…è´¹ç‰ˆå’Œä»˜è´¹ç‰ˆå®Œæ•´åŠŸèƒ½çš„å¼€å‘è°ƒè¯•ç‰ˆæœ¬
    - é€šè¿‡version_tierå‚æ•°æ§åˆ¶åŠŸèƒ½å±‚çº§
    - å…è´¹ç‰ˆåŠŸèƒ½ï¼šæ¯å‘¨å®šæŠ• + åŸºç¡€é£é™©æé†’
    - ä»˜è´¹ç‰ˆåŠŸèƒ½ï¼šæ¯æ—¥å®šæŠ• + 3å±‚æ™ºèƒ½åŠ ä»“
    - ç”¨äºå¼€å‘è°ƒè¯•ã€åŠŸèƒ½æµ‹è¯•å’Œæ€§èƒ½éªŒè¯
    - åˆ†å‘æ—¶éœ€ç”Ÿæˆå¯¹åº”çš„ç¨³å®šç‰ˆæœ¬
    
    [v2.2.5 å‚æ•°ä¼˜åŒ–]
    - ä¿®å¤basic_invest_onlyå¸ƒå°”å€¼ç±»å‹å¤„ç†é—®é¢˜
    - å¢å¼ºå‚æ•°ç±»å‹éªŒè¯å’Œè‡ªåŠ¨è½¬æ¢åŠŸèƒ½
    - å®Œå–„GUIå‚æ•°éªŒè¯ï¼šç§¯æå‹é¢„è®¾ã€ä»˜è´¹ç‰ˆæ¯æ—¥å®šæŠ•æ­£å¸¸
    - ä¼˜åŒ–è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºï¼Œå¢åŠ å‚æ•°ç±»å‹æ£€æŸ¥
    
    [v2.2.4 é‡å¤§ä¿®å¤]  
    - ä¿®å¤åˆå§‹åŒ–é¡ºåºé—®é¢˜ï¼šå…ˆè®¾ç½®å‚æ•°ï¼Œå†åº”ç”¨åˆ†å±‚åŠŸèƒ½ï¼Œæœ€ååº”ç”¨é¢„è®¾
    - æ·»åŠ è¯¦ç»†çš„åˆå§‹åŒ–é˜¶æ®µæ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•è¿½è¸ª
    - å¢å¼ºå‚æ•°éªŒè¯å’ŒdebuggingåŠŸèƒ½ï¼Œè¯†åˆ«qty=1ç­‰å¼‚å¸¸å‚æ•°å€¼
    - é‡æ„setup_presetsè°ƒç”¨æ—¶æœºï¼Œé¿å…interval_minæœªå®šä¹‰é”™è¯¯
    - æ·»åŠ show_variableå¼‚å¸¸å¤„ç†å’Œfallbackæœºåˆ¶
    """

    def initialize(self):
        """åˆå§‹åŒ–ç­–ç•¥"""
        try:
            self._version = "v2.2.5-EnhancedParams"
            self._tier = "æ··åˆå¼€å‘ç‰ˆ"
            self._description = (
                "ğŸ”§ æ··åˆå¼€å‘ç‰ˆDCAç­–ç•¥ - å¼€å‘è°ƒè¯•ä¸“ç”¨\n"
                "âœ… åŒ…å«å…è´¹ç‰ˆ+ä»˜è´¹ç‰ˆå®Œæ•´åŠŸèƒ½\n" 
                "âœ… é€šè¿‡version_tierå‚æ•°æ§åˆ¶åŠŸèƒ½å±‚çº§\n"
                "âœ… ç”¨äºåŠŸèƒ½å¼€å‘ã€æµ‹è¯•å’Œbugä¿®å¤\n"
                "âœ… æ”¯æŒåˆ†å±‚åŠŸèƒ½éªŒè¯å’Œæ€§èƒ½å¯¹æ¯”\n"
                "âš ï¸ ä»…ä¾›å¼€å‘ä½¿ç”¨ï¼Œåˆ†å‘è¯·ç”¨å¯¹åº”ç¨³å®šç‰ˆ"
            )
            
            print("ğŸš€ å¼€å§‹åˆå§‹åŒ– {0}".format(self._version))
            
            # é¦–å…ˆè®¾ç½®æ ¸å¿ƒçŠ¶æ€å˜é‡
            self.current_drawdown_layer = -1  # -1è¡¨ç¤ºè¿˜æ²¡æœ‰è§¦å‘ä»»ä½•å±‚çº§
            self.last_investment_time = None
            self.highest_price = None
            self.last_valid_price = 100.0  # é»˜è®¤ä»·æ ¼
            self.strategy_start_price = None  # ç­–ç•¥å¯åŠ¨ä»·æ ¼
            self.drawdown_reset_threshold = 0.05  # ä»·æ ¼ä¸Šæ¶¨5%é‡ç½®å›æ’¤å±‚çº§
            
            # å›æµ‹æ”¯æŒå˜é‡åˆå§‹åŒ–
            import collections
            self.high_queue = collections.deque(maxlen=20)
            self._position = 0
            self._total_cost = 0.0
            self.virtual_balance = None  # å…ˆåˆå§‹åŒ–ä¸ºNone
            
            # ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ç»„ä»¶åˆå§‹åŒ–
            print("ğŸ“ ç¬¬ä¸€é˜¶æ®µ: åŸºç¡€ç»„ä»¶åˆå§‹åŒ–")
            self.trigger_symbols()
            self.custom_indicator()
            
            # ç¬¬äºŒé˜¶æ®µï¼šç”¨æˆ·å‚æ•°è®¾ç½®
            print("ğŸ“ ç¬¬äºŒé˜¶æ®µ: ç”¨æˆ·å‚æ•°è®¾ç½®")
            self.global_variables()
            
            # ç¬¬ä¸‰é˜¶æ®µï¼šåˆ†å±‚åŠŸèƒ½è®¾ç½®ï¼ˆå¿…é¡»åœ¨å…¨å±€å˜é‡è®¾ç½®ä¹‹åï¼‰
            print("ğŸ“ ç¬¬ä¸‰é˜¶æ®µ: åˆ†å±‚åŠŸèƒ½è®¾ç½®")
            try:
                self.setup_tier_features()
                print("âœ… åˆ†å±‚åŠŸèƒ½è®¾ç½®æˆåŠŸ")
            except Exception as e:
                print("âŒ setup_tier_features å¤±è´¥: {0}".format(str(e)))
                import traceback
                print("è¯¦ç»†é”™è¯¯: {0}".format(traceback.format_exc()))
                # æ‰‹åŠ¨è®¾ç½®å…³é”®å±æ€§
                self.interval_min = 10080 if getattr(self, 'version_tier', 1) == 1 else 1440
                self.interval_desc = "æ‰‹åŠ¨è®¾ç½®å‘¨æœŸ ({0}åˆ†é’Ÿ)".format(self.interval_min)
                if not hasattr(self, 'virtual_balance') or self.virtual_balance is None:
                    self.virtual_balance = 10000.0
                    self.initial_balance = 10000.0
                print("ğŸ”§ æ‰‹åŠ¨è®¾ç½®: interval_min={0}, virtual_balance=${1}".format(self.interval_min, self.virtual_balance))
            
            # ç¬¬å››é˜¶æ®µï¼šé¢„è®¾é…ç½®åº”ç”¨ï¼ˆåœ¨åˆ†å±‚åŠŸèƒ½è®¾ç½®ä¹‹åï¼‰
            print("ğŸ“ ç¬¬å››é˜¶æ®µ: é¢„è®¾é…ç½®åº”ç”¨")
            self.setup_presets()
            
            # ç¬¬äº”é˜¶æ®µï¼šæœ€ç»ˆéªŒè¯å’Œå…œåº•è®¾ç½®
            print("ğŸ“ ç¬¬äº”é˜¶æ®µ: æœ€ç»ˆéªŒè¯å’Œå…œåº•è®¾ç½®")
            # ç¡®ä¿å…³é”®å±æ€§å·²è®¾ç½®
            if not hasattr(self, 'interval_min') or self.interval_min is None:
                self.interval_min = 10080 if getattr(self, 'version_tier', 1) == 1 else 1440
                print("âš ï¸ æœ€ç»ˆæ£€æŸ¥: interval_minç¼ºå¤±ï¼Œè®¾ç½®é»˜è®¤å€¼{0}åˆ†é’Ÿ".format(self.interval_min))
            
            # æœ€åç¡®ä¿è™šæ‹Ÿä½™é¢å·²æ­£ç¡®è®¾ç½®
            if self.backtest:
                if not hasattr(self, 'initial_balance') or self.initial_balance is None:
                    try:
                        self.initial_balance = total_cash(currency=Currency.USD)
                        if self.initial_balance is None or self.initial_balance <= 0:
                            self.initial_balance = 10000.0
                    except:
                        self.initial_balance = 10000.0
                        print("âš ï¸ åˆå§‹åŒ–ï¼šæ— æ³•è·å–è´¦æˆ·ä½™é¢ï¼Œä½¿ç”¨é»˜è®¤$10,000")
                        
                if not hasattr(self, 'virtual_balance') or self.virtual_balance is None:
                    self.virtual_balance = self.initial_balance
                    
            print("âœ… åˆå§‹åŒ–å®Œæˆï¼šè™šæ‹Ÿä½™é¢=${0:,.0f}".format(getattr(self, 'virtual_balance', 0)))
            
            # è¯¦ç»†çš„åˆå§‹åŒ–çŠ¶æ€æ—¥å¿—
            self.print_initialization_status()
            self.print_welcome()
            
        except Exception as e:
            print("âŒ åˆå§‹åŒ–å¤±è´¥: {0}".format(str(e)))
            import traceback
            print("è¯¦ç»†é”™è¯¯: {0}".format(traceback.format_exc()))

    def trigger_symbols(self):
        """è®¾ç½®äº¤æ˜“æ ‡çš„"""
        try:
            self.stock = declare_trig_symbol()
            print("ğŸ“ˆ äº¤æ˜“æ ‡çš„: {0}".format(self.stock))
        except Exception as e:
            print("âŒ æ ‡çš„è®¾ç½®å¤±è´¥: {0}".format(str(e)))

    def custom_indicator(self):
        """æ³¨å†Œè‡ªå®šä¹‰æŠ€æœ¯æŒ‡æ ‡"""
        try:
            # æ³¨å†Œä¸€ä¸ªç®€å•çš„ç§»åŠ¨å¹³å‡çº¿æŒ‡æ ‡ä¾›å‚è€ƒ
            self.register_indicator(
                indicator_name='MA',
                script='MA5:MA(CLOSE,5),COLORFF8D1E;',
                param_list=[]
            )
            print("ğŸ“Š æŠ€æœ¯æŒ‡æ ‡æ³¨å†Œå®Œæˆ")
        except Exception as e:
            print("âŒ æŠ€æœ¯æŒ‡æ ‡æ³¨å†Œå¤±è´¥: {0}".format(str(e)))

    def global_variables(self):
        """å…¨å±€å˜é‡è®¾ç½® - åˆ†å±‚ç‰ˆ"""
        try:
            # === å…è´¹ç‰ˆåŸºç¡€å‚æ•° (ç”¨æˆ·ä¸»è¦é…ç½®) ===
            self.qty = show_variable(20, GlobalType.INT)  # æ¯æ¬¡å®šæŠ•è‚¡æ•°
            self.preset_mode = show_variable(2, GlobalType.INT)  # 1=ä¿å®ˆ 2=å¹³è¡¡ 3=ç§¯æ
            self.backtest = show_variable(True, GlobalType.BOOL)  # å›æµ‹æ¨¡å¼
            self.basic_invest_only = show_variable(False, GlobalType.BOOL)  # ä»…å®šæŠ•æ¨¡å¼
            
            # === ä»˜è´¹ç‰ˆä¸“å±åŠŸèƒ½ (Â¥35/æœˆ) ===
            print("\nğŸ’¡ ä»¥ä¸‹ä¸ºä»˜è´¹ç‰ˆ(Â¥35/æœˆ)ä¸“å±åŠŸèƒ½ï¼Œå…è´¹ç‰ˆç”¨æˆ·ä¿®æ”¹æ— æ•ˆ:")
            self.version_tier = show_variable(1, GlobalType.INT)  # 1=å…è´¹ç‰ˆ 2=ä»˜è´¹ç‰ˆ(Â¥35/æœˆ)
            self.balance_mode = show_variable(1, GlobalType.INT)  # 1=ç³»ç»Ÿé»˜è®¤ 2=è‡ªå®šä¹‰(ä»˜è´¹ç‰ˆ)
            self.custom_balance = show_variable(50000, GlobalType.INT)  # ä»˜è´¹ç‰ˆå¯è‡ªå®šä¹‰èµ„é‡‘
            self.interval_mode = show_variable(1, GlobalType.INT)  # 1=è‡ªåŠ¨(ç‰ˆæœ¬å†³å®š) 2=æ¯æ—¥(ä»˜è´¹ç‰ˆ) 3=æ¯å‘¨ 4=è‡ªå®šä¹‰(ä»˜è´¹ç‰ˆ)
            self.custom_interval_min = show_variable(1440, GlobalType.INT)  # è‡ªå®šä¹‰å‘¨æœŸ(ä»˜è´¹ç‰ˆ)
            
            # å…è´¹ç‰ˆå›ºå®šå‚æ•°ï¼ˆä¸å¯é…ç½®ï¼‰
            self.drawdown_layers = [5.0, 10.0, 20.0]  # 3å±‚å›æ’¤é˜ˆå€¼
            self.drawdown_multipliers = [1.5, 2.0, 3.0]  # å¯¹åº”åŠ ä»“å€æ•°
            self.extreme_drawdown_pct = 50.0  # æç«¯å›æ’¤ä¿æŠ¤
            self.log_level = 0  # ç®€åŒ–æ—¥å¿—
            
            # æ³¨æ„ï¼šä¸èƒ½é‡æ–°èµ‹å€¼show_variable()å£°æ˜çš„å˜é‡
            # å¦‚æœéœ€è¦ç±»å‹è½¬æ¢ï¼Œåº”è¯¥åœ¨åç»­å¤„ç†ä¸­ä½¿ç”¨bool(self.basic_invest_only)
            if isinstance(getattr(self, 'basic_invest_only', False), int):
                print("ğŸ”§ æ£€æµ‹åˆ°basic_invest_onlyç±»å‹: intï¼Œåç»­å°†è‡ªåŠ¨è½¬æ¢ä¸ºbool")
            
            # éªŒè¯å…³é”®å‚æ•°æ˜¯å¦æ­£ç¡®è®¾ç½®
            print("ğŸ” éªŒè¯å…³é”®å‚æ•°:")
            print("   qty: {0} (æœŸæœ›: 20)".format(getattr(self, 'qty', 'MISSING')))
            print("   version_tier: {0} (æœŸæœ›: 1æˆ–2)".format(getattr(self, 'version_tier', 'MISSING')))
            print("   preset_mode: {0} (æœŸæœ›: 2)".format(getattr(self, 'preset_mode', 'MISSING')))
            print("   basic_invest_only: {0} (ç±»å‹: {1})".format(getattr(self, 'basic_invest_only', 'MISSING'), type(getattr(self, 'basic_invest_only', None))))
            
            print("âš™ï¸ å‚æ•°é…ç½®å®Œæˆ")
            print("ğŸ” æ‰“å°å…¨å±€å˜é‡å‚æ•°å€¼ (è°ƒè¯•ç”¨):")
            self.print_global_variables()
            
        except Exception as e:
            print("âŒ å‚æ•°è®¾ç½®å¤±è´¥: {0}".format(str(e)))
            import traceback
            print("è¯¦ç»†é”™è¯¯: {0}".format(traceback.format_exc()))

    def print_global_variables(self):
        """æ‰“å°æ‰€æœ‰å…¨å±€å˜é‡å‚æ•° - ç”¨äºè°ƒè¯•"""
        print("=" * 50)
        try:
            print("ğŸ“¦ qty (å®šæŠ•è‚¡æ•°): {0} [æœŸæœ›: 20]".format(getattr(self, 'qty', 'MISSING!')))
            print("ğŸ›ï¸ version_tier (ç‰ˆæœ¬å±‚çº§): {0} [æœŸæœ›: 1æˆ–2]".format(getattr(self, 'version_tier', 'MISSING!')))
            print("ğŸ’µ balance_mode (èµ„é‡‘æ¨¡å¼): {0} [æœŸæœ›: 1]".format(getattr(self, 'balance_mode', 'MISSING!')))  
            print("ğŸ’° custom_balance (è‡ªå®šä¹‰èµ„é‡‘): {0} [æœŸæœ›: 50000]".format(getattr(self, 'custom_balance', 'MISSING!')))
            print("â° interval_mode (é—´éš”æ¨¡å¼): {0} [æœŸæœ›: 1]".format(getattr(self, 'interval_mode', 'MISSING!')))
            print("â±ï¸ custom_interval_min (è‡ªå®šä¹‰é—´éš”): {0} [æœŸæœ›: 1440]".format(getattr(self, 'custom_interval_min', 'MISSING!')))
            print("ğŸ¨ preset_mode (é¢„è®¾æ¨¡å¼): {0} [æœŸæœ›: 2]".format(getattr(self, 'preset_mode', 'MISSING!')))
            print("ğŸ”§ backtest (å›æµ‹æ¨¡å¼): {0} [æœŸæœ›: True]".format(getattr(self, 'backtest', 'MISSING!')))
            print("ğŸ’¡ basic_invest_only (ä»…å®šæŠ•): {0} [æœŸæœ›: False, ç±»å‹: {1}]".format(getattr(self, 'basic_invest_only', 'MISSING!'), type(getattr(self, 'basic_invest_only', None))))
            
            print("\nğŸ”§ å›ºå®šå‚æ•°:")
            print("ğŸ“Š drawdown_layers: {0}".format(getattr(self, 'drawdown_layers', 'MISSING!')))
            print("ğŸ“ˆ drawdown_multipliers: {0}".format(getattr(self, 'drawdown_multipliers', 'MISSING!')))
            print("âš ï¸ extreme_drawdown_pct: {0}".format(getattr(self, 'extreme_drawdown_pct', 'MISSING!')))
            print("ğŸ“ log_level: {0}".format(getattr(self, 'log_level', 'MISSING!')))
            
            # é¢å¤–æ£€æŸ¥show_variableæ˜¯å¦æ­£å¸¸å·¥ä½œ
            print("\nğŸ”¬ Show_variableæµ‹è¯•:")
            print("   qtyç±»å‹: {0}".format(type(getattr(self, 'qty', None))))
            print("   version_tierç±»å‹: {0}".format(type(getattr(self, 'version_tier', None))))
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯show_variableè¿”å›å€¼é—®é¢˜
            if hasattr(self, 'qty'):
                print("   qty == 20? {0}".format(getattr(self, 'qty', None) == 20))
                print("   qty == 1? {0}".format(getattr(self, 'qty', None) == 1))
            
        except Exception as e:
            print("âŒ å‚æ•°æ‰“å°å¤±è´¥: {0}".format(str(e)))
            import traceback
            print("è¯¦ç»†é”™è¯¯: {0}".format(traceback.format_exc()))
        print("=" * 50)

    def setup_presets(self):
        """è®¾ç½®é¢„è®¾æ¨¡æ¿ - åœ¨åˆ†å±‚åŠŸèƒ½è®¾ç½®ä¹‹åè°ƒç”¨"""
        try:
            print("ğŸ¨ å¼€å§‹åº”ç”¨é¢„è®¾é…ç½®: preset_mode={0}".format(getattr(self, 'preset_mode', 'None')))
            
            presets = {
                1: {  # ä¿å®ˆå‹
                    "name": "ä¿å®ˆå‹",
                    "description": "ä½é£é™©ï¼Œé€‚åˆç¨³å¥æŠ•èµ„è€…",
                    "base_qty": 10,
                    "risk_level": "ä½"
                },
                2: {  # å¹³è¡¡å‹  
                    "name": "å¹³è¡¡å‹",
                    "description": "ä¸­ç­‰é£é™©æ”¶ç›Šï¼Œé€‚åˆå¤§å¤šæ•°ç”¨æˆ·", 
                    "base_qty": None,  # ä½¿ç”¨ç”¨æˆ·è¾“å…¥å€¼
                    "risk_level": "ä¸­"
                },
                3: {  # ç§¯æå‹
                    "name": "ç§¯æå‹", 
                    "description": "é«˜é¢‘äº¤æ˜“ï¼Œé€‚åˆé£é™©æ‰¿å—èƒ½åŠ›å¼ºçš„ç”¨æˆ·",
                    "base_qty": 50,
                    "risk_level": "é«˜"
                }
            }
            
            if self.preset_mode in presets:
                preset = presets[self.preset_mode]
                self.preset_name = preset["name"]
                self.preset_desc = preset["description"] 
                self.risk_level = preset["risk_level"]
                
                # åº”ç”¨é¢„è®¾æ•°é‡ï¼ˆä»…åœ¨é¢„è®¾æœ‰ç‰¹å®šå€¼ä¸”ç”¨æˆ·ä½¿ç”¨é»˜è®¤å€¼æ—¶ï¼‰
                if preset["base_qty"] is not None and self.qty == 20:  # é»˜è®¤å€¼20
                    print("ğŸ“¦ åº”ç”¨é¢„è®¾æ•°é‡: {0} -> {1}".format(self.qty, preset['base_qty']))
                    self.qty = preset["base_qty"]
                else:
                    print("ğŸ“¦ ä¿æŒç”¨æˆ·æ•°é‡è®¾ç½®: {0}".format(self.qty))
                    
            else:
                self.preset_name = "è‡ªå®šä¹‰"
                self.preset_desc = "ç”¨æˆ·è‡ªå®šä¹‰å‚æ•°"
                self.risk_level = "æœªçŸ¥"
                
            print("ğŸ¨ é¢„è®¾é…ç½®å®Œæˆ: {0} - æ•°é‡: {1}è‚¡".format(self.preset_name, self.qty))
            
        except Exception as e:
            print("âŒ é¢„è®¾é…ç½®å¤±è´¥: {0}".format(str(e)))
            # è®¾ç½®é»˜è®¤å€¼
            self.preset_name = "é»˜è®¤"
            self.preset_desc = "ç³»ç»Ÿé»˜è®¤é…ç½®"
            self.risk_level = "ä¸­"

    def setup_tier_features(self):
        """è®¾ç½®åˆ†å±‚åŠŸèƒ½ç‰¹æ€§"""
        try:
            print("ğŸ”§ å¼€å§‹åˆ†å±‚åŠŸèƒ½è®¾ç½®: version_tier={0}".format(getattr(self, 'version_tier', 'None')))
            
            # èµ„é‡‘ç®¡ç†è®¾ç½®
            if self.version_tier >= 2 and self.balance_mode == 2:
                # ä»˜è´¹ç‰ˆï¼šä½¿ç”¨è‡ªå®šä¹‰èµ„é‡‘
                if self.backtest:
                    self.initial_balance = self.custom_balance
                    self.virtual_balance = self.custom_balance
                print("ğŸ’° ä½¿ç”¨è‡ªå®šä¹‰èµ„é‡‘: ${0:,}".format(self.custom_balance))
            else:
                # å…è´¹ç‰ˆï¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤èµ„é‡‘
                if self.backtest:
                    try:
                        self.initial_balance = total_cash(currency=Currency.USD)
                        if self.initial_balance is None or self.initial_balance <= 0:
                            self.initial_balance = 10000.0  # é»˜è®¤1ä¸‡ç¾å…ƒ
                        self.virtual_balance = self.initial_balance
                    except:
                        # å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
                        self.initial_balance = 10000.0
                        self.virtual_balance = 10000.0
                        print("âš ï¸ æ— æ³•è·å–è´¦æˆ·ä½™é¢ï¼Œä½¿ç”¨é»˜è®¤èµ„é‡‘$10,000")
                if self.version_tier == 1 and self.balance_mode == 2:
                    print("ğŸ’¡ è‡ªå®šä¹‰èµ„é‡‘ä¸ºä»˜è´¹ç‰ˆåŠŸèƒ½ï¼Œå½“å‰ä½¿ç”¨ç³»ç»Ÿé»˜è®¤")
                
            # æŠ•èµ„å‘¨æœŸè®¾ç½®
            if self.interval_mode == 1:  # è‡ªåŠ¨æ¨¡å¼
                if self.version_tier == 1:
                    # å…è´¹ç‰ˆï¼šå›ºå®šæ¯å‘¨
                    self.interval_min = 10080  # 7å¤© * 24å°æ—¶ * 60åˆ†é’Ÿ
                    self.interval_desc = "æ¯å‘¨å®šæŠ• (å…è´¹ç‰ˆ)"
                else:
                    # ä»˜è´¹ç‰ˆï¼šé»˜è®¤æ¯æ—¥
                    self.interval_min = 1440  # 1å¤©
                    self.interval_desc = "æ¯æ—¥å®šæŠ• (ä»˜è´¹ç‰ˆé»˜è®¤)"
            elif self.interval_mode == 2:  # æ¯æ—¥
                if self.version_tier >= 2:
                    self.interval_min = 1440
                    self.interval_desc = "æ¯æ—¥å®šæŠ•"
                else:
                    print("ğŸ’¡ æ¯æ—¥å®šæŠ•ä¸ºä»˜è´¹ç‰ˆåŠŸèƒ½ï¼Œå…è´¹ç‰ˆä½¿ç”¨æ¯å‘¨å®šæŠ•")
                    self.interval_min = 10080
                    self.interval_desc = "æ¯å‘¨å®šæŠ• (å…è´¹ç‰ˆé™åˆ¶)"
            elif self.interval_mode == 3:  # æ¯å‘¨
                self.interval_min = 10080
                self.interval_desc = "æ¯å‘¨å®šæŠ•"
            elif self.interval_mode == 4:  # è‡ªå®šä¹‰
                if self.version_tier >= 2:
                    self.interval_min = self.custom_interval_min
                    self.interval_desc = "è‡ªå®šä¹‰å‘¨æœŸ ({0}åˆ†é’Ÿ)".format(self.interval_min)
                else:
                    print("ğŸ’¡ è‡ªå®šä¹‰å‘¨æœŸä¸ºä»˜è´¹ç‰ˆåŠŸèƒ½ï¼Œå…è´¹ç‰ˆä½¿ç”¨æ¯å‘¨å®šæŠ•")
                    self.interval_min = 10080
                    self.interval_desc = "æ¯å‘¨å®šæŠ• (å…è´¹ç‰ˆé™åˆ¶)"
            
            print("ğŸ“… æŠ•èµ„å‘¨æœŸ: {0}".format(self.interval_desc))
            
        except Exception as e:
            import traceback
            print("âŒ åˆ†å±‚åŠŸèƒ½è®¾ç½®å¤±è´¥: {0}".format(str(e)))
            print("é”™è¯¯è¯¦æƒ…: {0}".format(traceback.format_exc()))
            # å›é€€åˆ°é»˜è®¤è®¾ç½®
            self.interval_min = 10080 if getattr(self, 'version_tier', 1) == 1 else 1440
            self.interval_desc = "é»˜è®¤å‘¨æœŸ ({0}åˆ†é’Ÿ) - å¼‚å¸¸å›é€€".format(self.interval_min)
            if not hasattr(self, 'virtual_balance') or self.virtual_balance is None:
                self.virtual_balance = 10000.0
                self.initial_balance = 10000.0
            print("ğŸ”§ å¼‚å¸¸å›é€€è®¾ç½®å®Œæˆ: interval_min={0}, virtual_balance=${1}".format(self.interval_min, self.virtual_balance))

    def print_initialization_status(self):
        """æ‰“å°è¯¦ç»†çš„åˆå§‹åŒ–çŠ¶æ€ - ç”¨äºè°ƒè¯•"""
        print("\nğŸ” åˆå§‹åŒ–çŠ¶æ€è¯¦æƒ… - {0}".format(self._version))
        print("=" * 50)
        print("ğŸ“Š ç‰ˆæœ¬ä¿¡æ¯: {0}".format(self._tier))
        print("ğŸ“ˆ äº¤æ˜“æ ‡çš„: {0}".format(getattr(self, 'stock', 'Unknown')))
        print("ğŸ›ï¸ ç‰ˆæœ¬å±‚çº§: {0}".format(getattr(self, 'version_tier', 'Unknown')))
        print("ğŸ’° è™šæ‹Ÿä½™é¢: ${0:,.2f}".format(getattr(self, 'virtual_balance', 0)))
        print("ğŸ“… æŠ•èµ„å‘¨æœŸ: {0}åˆ†é’Ÿ".format(getattr(self, 'interval_min', 0)))
        print("ğŸ“¦ å®šæŠ•æ•°é‡: {0}è‚¡".format(getattr(self, 'qty', 0)))
        print("ğŸ”§ å›æµ‹æ¨¡å¼: {0}".format(getattr(self, 'backtest', False)))
        print("âš™ï¸ é—´éš”æ¨¡å¼: {0}".format(getattr(self, 'interval_mode', 0)))
        print("ğŸ’µ èµ„é‡‘æ¨¡å¼: {0}".format(getattr(self, 'balance_mode', 0)))
        
        # æ£€æŸ¥å…³é”®å±æ€§
        critical_attrs = ['interval_min', 'virtual_balance', 'qty', 'version_tier']
        missing_attrs = []
        for attr in critical_attrs:
            if not hasattr(self, attr) or getattr(self, attr) is None:
                missing_attrs.append(attr)
        
        if missing_attrs:
            print("âš ï¸ ç¼ºå¤±å±æ€§: {0}".format(missing_attrs))
        else:
            print("âœ… æ‰€æœ‰å…³é”®å±æ€§å·²åˆå§‹åŒ–")
        print("=" * 50)

    def print_welcome(self):
        """æ‰“å°æ¬¢è¿ä¿¡æ¯ - åˆ†å±‚ç‰ˆ"""
        version_info = {
            1: {"name": "å…è´¹åŸºç¡€ç‰ˆ", "features": "å›ºå®šå®šæŠ•+é£é™©æé†’", "color": "ğŸ†“"},
            2: {"name": "ä»˜è´¹è¿›é˜¶ç‰ˆ(Â¥35/æœˆ)", "features": "3å±‚æ™ºèƒ½åŠ ä»“ç³»ç»Ÿ", "color": "ğŸ’"}
        }
        
        current_version = version_info.get(self.version_tier, version_info[1])
        
        print("\n" + "="*60)
        print("ğŸš€ DCAæ™ºèƒ½å®šæŠ•ç­–ç•¥ {0}".format(self._version))
        print("="*60)
        print("{0} å½“å‰ç‰ˆæœ¬: {1}".format(current_version['color'], current_version['name']))
        print("âœ¨ æ ¸å¿ƒåŠŸèƒ½: {0}".format(current_version['features']))
        
        if self.version_tier == 1:
            print("\nğŸ†“ å…è´¹ç‰ˆåŠŸèƒ½:")
            print("   âœ… å›ºå®šå‘¨æœŸæ™ºèƒ½å®šæŠ•")
            print("   âœ… åŸºç¡€å›æ’¤ç›‘æ§æé†’")
            print("   âœ… é£é™©ä¿æŠ¤ç³»ç»Ÿ")
            print("   âœ… æŠ•èµ„è®°å½•ç»Ÿè®¡")
        elif self.version_tier == 2:
            print("\nğŸ’ ä»˜è´¹ç‰ˆåŠŸèƒ½ (Â¥35/æœˆ):")
            print("   âœ… åŒ…å«å…è´¹ç‰ˆæ‰€æœ‰åŠŸèƒ½")
            print("   âœ… 3å±‚æ™ºèƒ½åŠ ä»“ (5%/10%/20%)")
            print("   âœ… åŠ¨æ€å€æ•°è°ƒæ•´ (1.5x/2x/3x)")
            print("   âœ… ä¸ªæ€§åŒ–å‚æ•°é…ç½®")
            print("   âœ… æç«¯å›æ’¤ä¿æŠ¤")
            
        print("\nğŸ“Š å½“å‰é…ç½®:")
        print("   ç‰ˆæœ¬ç­‰çº§: {0} ({1})".format(self.version_tier, 'å…è´¹ç‰ˆ' if self.version_tier == 1 else 'ä»˜è´¹ç‰ˆ'))
        print("   æŠ•èµ„æ¨¡æ¿: {0} ({1})".format(self.preset_name, self.preset_desc))
        print("   é£é™©ç­‰çº§: {0}".format(self.risk_level))
        print("   å®šæŠ•æ•°é‡: {0}è‚¡".format(self.qty))
        print("   æŠ•èµ„å‘¨æœŸ: {0}".format(getattr(self, 'interval_desc', self._get_interval_desc())))
        if hasattr(self, 'virtual_balance'):
            print("   åˆå§‹èµ„é‡‘: ${0:,.0f}".format(self.virtual_balance))
        print("   å›æ’¤é˜ˆå€¼: {0}".format(self.drawdown_layers))
        print("   è¿è¡Œæ¨¡å¼: {0}".format('å›æµ‹' if self.backtest else 'å®ç›˜'))
        
        if self.version_tier == 1:
            print("\nğŸ¯ å‡çº§æç¤º:")
            print("   ğŸ’¡ ä»˜è´¹ç‰ˆæ”¯æŒæ¯æ—¥å®šæŠ•ï¼Œè·å¾—æ›´å¹³æ»‘çš„å¹³å‡æˆæœ¬")
            print("   ğŸ’¡ ä»˜è´¹ç‰ˆæ”¯æŒæ™ºèƒ½3å±‚åŠ ä»“ï¼Œå›æ’¤æ—¶è‡ªåŠ¨å¢åŠ æŠ•èµ„")
            print("   ğŸ’¡ ä»˜è´¹ç‰ˆæ”¯æŒè‡ªå®šä¹‰èµ„é‡‘(10K-500K)å’ŒæŠ•èµ„å‘¨æœŸ")
            print("   ğŸ’° å†å²æ•°æ®æ˜¾ç¤ºæ¯æ—¥å®šæŠ•æ¯”æ¯å‘¨å®šæŠ•æ”¶ç›Šæå‡3-8%")
            print("   ğŸ’° è”ç³»ä½œè€…å‡çº§è‡³ä»˜è´¹ç‰ˆ(Â¥35/æœˆ)è§£é”å®Œæ•´åŠŸèƒ½")
        
        print("="*60 + "\n")

    def _get_interval_desc(self):
        """è·å–å‘¨æœŸæè¿°"""
        if self.interval_min == 60:
            return "1å°æ—¶"
        elif self.interval_min == 1440:
            return "1å¤©"
        elif self.interval_min == 10080:
            return "1å‘¨"
        else:
            return "{0}åˆ†é’Ÿ".format(self.interval_min)

    def handle_data(self):
        """ä¸»è¦äº¤æ˜“é€»è¾‘ - åˆ†å±‚æ¶æ„"""
        try:
            current_time = device_time(TimeZone.DEVICE_TIME_ZONE)
            latest_price, highest_price, account_balance = self.get_market_data()
            
            # è®¡ç®—å›æ’¤å’ŒæŒä»“ä¿¡æ¯
            drawdown = self.calculate_drawdown(latest_price)
            position = self.get_position()
            
            if self.log_level >= 1:
                print("ğŸ“Š ä»·æ ¼={0:.2f}, å›æ’¤={1:.2f}%, æŒä»“={2}, æœ€é«˜ä»·={3:.2f}".format(latest_price, drawdown, position, self.highest_price))

            # åˆ†å±‚åŠŸèƒ½è·¯ç”±
            if self.version_tier == 1:
                # å…è´¹ç‰ˆé€»è¾‘
                self.free_version_logic(current_time, latest_price, account_balance, drawdown)
            elif self.version_tier == 2:
                # ä»˜è´¹ç‰ˆé€»è¾‘ 
                self.advanced_version_logic(current_time, latest_price, account_balance, drawdown)
            else:
                # é»˜è®¤å…è´¹ç‰ˆ
                print("âš ï¸ ç‰ˆæœ¬å‚æ•°é”™è¯¯ï¼Œä½¿ç”¨å…è´¹ç‰ˆåŠŸèƒ½")
                self.free_version_logic(current_time, latest_price, account_balance, drawdown)

        except Exception as e:
            import traceback
            error_msg = str(e) if str(e) else "æœªçŸ¥é”™è¯¯"
            print("âŒ ç­–ç•¥æ‰§è¡Œé”™è¯¯: {0}".format(error_msg))
            print("é”™è¯¯è¯¦æƒ…: {0}".format(traceback.format_exc()))

    def get_market_data(self):
        """è·å–å¸‚åœºæ•°æ®"""
        if self.backtest:
            # å›æµ‹æ¨¡å¼
            try:
                if not hasattr(self, 'bar_index'):
                    self.bar_index = 0
                self.bar_index += 1
                
                latest_price = bar_close(self.stock, bar_type=BarType.D1, select=1)
                if latest_price is None or latest_price <= 0:
                    print("âš ï¸ è·å–ä»·æ ¼å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä»·æ ¼")
                    latest_price = 100.0  # é»˜è®¤ä»·æ ¼
                
                # è®°å½•æœ‰æ•ˆä»·æ ¼ä¾›åç»­ä½¿ç”¨
                if latest_price > 0:
                    self.last_valid_price = latest_price
                
                self.high_queue.append(latest_price)
                
                # ä½¿ç”¨æ¡ä»¶åˆ¤æ–­æ›¿ä»£min()å‡½æ•°
                available_days = self.bar_index if self.bar_index < 20 else 20
                high_list = list(self.high_queue)[-available_days:]
                if len(high_list) == 0:
                    highest_price = latest_price
                elif len(high_list) == 1:
                    highest_price = high_list[0]
                else:
                    # ä½¿ç”¨Moomooæ”¯æŒçš„max()å‡½æ•°æ ¼å¼ï¼Œä¼ å…¥å…·ä½“æ•°å€¼
                    highest_price = high_list[0]
                    for price in high_list[1:]:
                        if price > highest_price:
                            highest_price = price
                
                account_balance = self.virtual_balance
                return latest_price, highest_price, account_balance
            except Exception as e:
                print("å›æµ‹æ•°æ®è·å–é”™è¯¯: {0}".format(str(e)))
                # è¿”å›é»˜è®¤å€¼é¿å…ç­–ç•¥å´©æºƒ
                default_balance = getattr(self, 'virtual_balance', 10000.0) or 10000.0
                return self.last_valid_price, self.last_valid_price, default_balance
        else:
            # å®ç›˜æ¨¡å¼
            latest_price = current_price(self.stock, price_type=THType.FTH)
            if latest_price is None or latest_price <= 0:
                latest_price = self.last_valid_price
            else:
                self.last_valid_price = latest_price
            
            high_list = [bar_high(self.stock, bar_type=BarType.D1, select=i) for i in range(1, 21)]
            # å¤„ç†å¯èƒ½çš„Noneå€¼å¹¶æ‰¾å‡ºæœ€å¤§å€¼
            valid_highs = [h for h in high_list if h is not None and h > 0]
            if len(valid_highs) == 0:
                highest_price = latest_price
            elif len(valid_highs) == 1:
                highest_price = valid_highs[0]
            else:
                highest_price = valid_highs[0]
                for price in valid_highs[1:]:
                    if price > highest_price:
                        highest_price = price
            
            account_balance = total_cash(currency=Currency.USD)
            return latest_price, highest_price, account_balance

    def calculate_drawdown(self, latest_price):
        """è®¡ç®—å›æ’¤å¹…åº¦ - ä¿®å¤ç‰ˆ"""
        # åˆå§‹åŒ–ç­–ç•¥å¯åŠ¨ä»·æ ¼å’Œæœ€é«˜ä»·
        if self.strategy_start_price is None:
            self.strategy_start_price = latest_price
            self.highest_price = latest_price
            return 0.0
            
        # æ›´æ–°æœ€é«˜ä»·ï¼ˆåªèƒ½ä¸Šå‡ï¼Œä¸èƒ½ä¸‹é™ï¼‰
        if latest_price > self.highest_price:
            self.highest_price = latest_price
            # ä»·æ ¼åˆ›æ–°é«˜æ—¶ï¼Œé‡ç½®å›æ’¤å±‚çº§ï¼ˆå¯é€‰ï¼‰
            if (latest_price - self.highest_price) / self.highest_price > self.drawdown_reset_threshold:
                self.current_drawdown_layer = -1  # é‡ç½®ä¸ºæœªè§¦å‘çŠ¶æ€
        
        # è®¡ç®—å½“å‰å›æ’¤
        if self.highest_price > 0:
            drawdown = (self.highest_price - latest_price) / self.highest_price * 100
        else:
            drawdown = 0.0
            
        return drawdown

    def calculate_add_position_qty(self, drawdown):
        """è®¡ç®—åŠ ä»“æ•°é‡ - å…è´¹ç‰ˆ3å±‚"""
        for i, threshold in enumerate(self.drawdown_layers):
            if drawdown >= threshold:
                # æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨è¿™ä¸ªå±‚çº§æˆ–æ›´é«˜å±‚çº§åŠ è¿‡ä»“
                if i <= self.current_drawdown_layer:
                    continue
                    
                # è§¦å‘æ–°çš„åŠ ä»“å±‚çº§
                self.current_drawdown_layer = i
                add_qty = int(self.qty * self.drawdown_multipliers[i])
                
                print("ğŸ¯ å›æ’¤åŠ ä»“è§¦å‘: ç¬¬{0}å±‚ ({1}%), å€æ•°={2}x, æ•°é‡={3}è‚¡".format(i+1, threshold, self.drawdown_multipliers[i], add_qty))
                return add_qty
        
        return 0

    def should_invest(self, current_time):
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥å®šæŠ•"""
        if self.last_investment_time is None:
            return True
        elapsed = (current_time - self.last_investment_time).total_seconds() / 60
        
        # å¥å£®æ€§æ£€æŸ¥ï¼šå¦‚æœinterval_minä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å€¼
        if not hasattr(self, 'interval_min') or self.interval_min is None:
            # æ ¹æ®ç‰ˆæœ¬å±‚çº§è®¾ç½®é»˜è®¤å€¼
            default_interval = 10080 if getattr(self, 'version_tier', 1) == 1 else 1440
            self.interval_min = default_interval
            print("âš ï¸ interval_minç¼ºå¤±ï¼Œè®¾ç½®é»˜è®¤å€¼: {0}åˆ†é’Ÿ".format(self.interval_min))
        
        return elapsed >= self.interval_min

    def free_version_logic(self, current_time, latest_price, account_balance, drawdown):
        """å…è´¹ç‰ˆç­–ç•¥é€»è¾‘ - åŸºç¡€å®šæŠ• + é£é™©æé†’"""
        
        # é£é™©æé†’åŠŸèƒ½
        if drawdown >= 20.0:
            print("âš ï¸ å…è´¹ç‰ˆé£é™©æé†’: å½“å‰å›æ’¤{0:.1f}%ï¼Œå»ºè®®å…³æ³¨å¸‚åœºå˜åŒ–".format(drawdown))
        elif drawdown >= 10.0:
            print("ğŸ“¢ å›æ’¤ç›‘æ§: å½“å‰å›æ’¤{0:.1f}%".format(drawdown))
            
        # çº¯å®šæŠ•æ¨¡å¼æˆ–åŸºç¡€å›æ’¤ä¿æŠ¤
        # ç¡®ä¿basic_invest_onlyæ˜¯å¸ƒå°”å€¼
        basic_only = bool(getattr(self, 'basic_invest_only', False))
        if basic_only:
            if self.should_invest(current_time):
                self.execute_investment(latest_price, account_balance, self.qty, "åŸºç¡€å®šæŠ•")
        else:
            # ä»…å¸¸è§„å®šæŠ•ï¼Œä¸åŠ ä»“
            if self.should_invest(current_time):
                self.execute_investment(latest_price, account_balance, self.qty, "å®šæœŸå®šæŠ•")

    def advanced_version_logic(self, current_time, latest_price, account_balance, drawdown):
        """ä»˜è´¹ç‰ˆç­–ç•¥é€»è¾‘ (Â¥35/æœˆ) - æ™ºèƒ½3å±‚åŠ ä»“ç³»ç»Ÿ"""
        
        # æ£€æŸ¥ç‰ˆæœ¬æˆæƒï¼ˆå®é™…ä½¿ç”¨æ—¶å¯è¿æ¥æœåŠ¡å™¨éªŒè¯ï¼‰
        if self.version_tier != 2:
            print("ğŸ’¡ 3å±‚æ™ºèƒ½åŠ ä»“åŠŸèƒ½éœ€è¦å‡çº§åˆ°ä»˜è´¹ç‰ˆ(Â¥35/æœˆ)ï¼Œè¯·è”ç³»ä½œè€…")
            print("ğŸ“± å½“å‰ä½¿ç”¨å…è´¹ç‰ˆåŠŸèƒ½...")
            return self.free_version_logic(current_time, latest_price, account_balance, drawdown)
        
        # æç«¯å›æ’¤ä¿æŠ¤
        if drawdown >= self.extreme_drawdown_pct:
            print("ğŸš¨ æç«¯å›æ’¤ä¿æŠ¤: {0:.1f}% >= {1}%ï¼Œä»…å®šæŠ•æ¨¡å¼".format(drawdown, self.extreme_drawdown_pct))
            if self.should_invest(current_time):
                self.execute_investment(latest_price, account_balance, self.qty, "æç«¯å›æ’¤ä¿æŠ¤")
            return

        # æ™ºèƒ½3å±‚åŠ ä»“ç³»ç»Ÿ
        add_qty = self.calculate_add_position_qty(drawdown)
        if add_qty > 0:
            self.execute_investment(latest_price, account_balance, add_qty, "ä»˜è´¹ç‰ˆ-ç¬¬{0}å±‚åŠ ä»“".format(self.current_drawdown_layer+1))
            return

        # å¸¸è§„å®šæŠ•
        if self.should_invest(current_time):
            self.execute_investment(latest_price, account_balance, self.qty, "ä»˜è´¹ç‰ˆ-å®šæœŸå®šæŠ•")

    def execute_investment(self, latest_price, account_balance, quantity, trade_type="å®šæŠ•"):
        """æ‰§è¡ŒæŠ•èµ„"""
        
        # è°ƒè¯•æ—¥å¿—
        print("ğŸ”§ æŠ•èµ„æ‰§è¡Œè°ƒè¯•: price={0}, balance={1}, qty={2}, type={3}".format(latest_price, account_balance, quantity, trade_type))
        print("ğŸ”§ å½“å‰çŠ¶æ€: version_tier={0}, virtual_balance={1}".format(getattr(self, 'version_tier', 'None'), getattr(self, 'virtual_balance', 'None')))
        
        # å‚æ•°åˆæ³•æ€§æ£€æŸ¥ - ä»˜è´¹ç‰ˆæ”¯æŒæ›´çµæ´»çš„æ•°é‡
        if self.version_tier == 2:
            # ä»˜è´¹ç‰ˆï¼šæ”¯æŒä»»æ„æ•°é‡ï¼Œä»…æ£€æŸ¥åŸºæœ¬èŒƒå›´
            if quantity < 1 or quantity > 1000:
                print("âš ï¸ ä»˜è´¹ç‰ˆå‚æ•°ä¿®æ­£: æŠ•èµ„æ•°é‡ {0} -> {1}è‚¡".format(quantity, self.qty))
                quantity = self.qty
        else:
            # å…è´¹ç‰ˆï¼šå¿…é¡»æ˜¯10çš„å€æ•°
            if quantity < 10 or quantity > 100 or quantity % 10 != 0:
                print("âš ï¸ å…è´¹ç‰ˆå‚æ•°ä¿®æ­£: æŠ•èµ„æ•°é‡ {0} -> 20è‚¡ (å…è´¹ç‰ˆè¦æ±‚10-100è‚¡ï¼Œ10çš„å€æ•°)".format(quantity))
                quantity = 20  # å…è´¹ç‰ˆé»˜è®¤å€¼

        if self.backtest:
            # å›æµ‹æ¨¡å¼ - ä½¿ç”¨place_marketäº§ç”ŸGUIäº¤æ˜“æ‰“ç‚¹
            required_cash = quantity * latest_price
            
            # ç¡®ä¿virtual_balanceä¸ä¸ºNone
            if self.virtual_balance is None:
                self.virtual_balance = 10000.0
                print("âš ï¸ è™šæ‹Ÿä½™é¢ä¸ºNoneï¼Œè®¾ç½®é»˜è®¤å€¼${0:,.0f}".format(self.virtual_balance))
            
            if required_cash > self.virtual_balance:
                # èµ„é‡‘ä¸è¶³ï¼Œè‡ªåŠ¨è°ƒæ•´æŠ•èµ„æ•°é‡
                original_qty = quantity
                max_qty = int(self.virtual_balance // latest_price)
                if max_qty < 1:
                    print("ğŸ’° è™šæ‹Ÿä½™é¢ä¸è¶³ï¼Œæ— æ³•è´­ä¹°ä»»ä½•è‚¡ç¥¨: éœ€è¦${0:.2f}, å¯ç”¨${1:.2f}".format(required_cash, self.virtual_balance))
                    return
                quantity = max_qty
                required_cash = quantity * latest_price
                print("âš ï¸ èµ„é‡‘è°ƒæ•´: åŸè®¡åˆ’ä¹°{0}è‚¡ï¼Œè°ƒæ•´ä¸º{1}è‚¡ (å¯ç”¨èµ„é‡‘${2:.2f})".format(original_qty, quantity, self.virtual_balance))
            
            if quantity < 1:
                print("ğŸ’° è°ƒæ•´åæ•°é‡ä¸è¶³1è‚¡ï¼Œè·³è¿‡æœ¬æ¬¡æŠ•èµ„")
                return

            # è°ƒç”¨place_marketæ¨¡æ‹Ÿä¸‹å•ï¼Œäº§ç”ŸGUIäº¤æ˜“æ‰“ç‚¹
            order_id = place_market(self.stock, quantity, OrderSide.BUY, TimeInForce.DAY)
            
            # ç²¾ç®€æ—¥å¿—è¾“å‡ºï¼Œä»…ä¿ç•™å…³é”®ä¿¡æ¯
            print("ğŸ“Š {0}: {1}è‚¡ @ ${2:.2f} | è®¢å•:{3}".format(trade_type, quantity, latest_price, order_id))
            
            # æ›´æ–°è™šæ‹Ÿè´¦æˆ·
            self.virtual_balance -= required_cash
            self._total_cost += required_cash
            self._position += quantity
            
            print("ğŸ’° ä½™é¢: ${0:.2f} | æŒä»“: {1}è‚¡".format(self.virtual_balance, self._position))
            
        else:
            # å®ç›˜æ¨¡å¼
            required_cash = quantity * latest_price
            if required_cash > account_balance:
                # èµ„é‡‘ä¸è¶³ï¼ŒæŒ‰å¯ç”¨èµ„é‡‘è°ƒæ•´æ•°é‡
                max_qty = int((account_balance // latest_price) // 10 * 10)
                if max_qty < 10:
                    print("ğŸ’° èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•æŠ•èµ„")
                    return
                quantity = max_qty
                print("âš ï¸ èµ„é‡‘è°ƒæ•´: æŠ•èµ„æ•°é‡è°ƒæ•´ä¸º {0}è‚¡".format(quantity))

            try:
                # ä½¿ç”¨å¸‚ä»·ä¹°å…¥ç¡®ä¿æˆäº¤
                order_id = place_market(self.stock, quantity, OrderSide.BUY, TimeInForce.DAY)
                print("âœ… {0}è®¢å•: {1}è‚¡ @ å¸‚ä»·, è®¢å•å·: {2}".format(trade_type, quantity, order_id))
            except Exception as e:
                print("âŒ ä¸‹å•å¤±è´¥: {0}".format(str(e)))
                return

        self.last_investment_time = device_time(TimeZone.DEVICE_TIME_ZONE)

    def get_position(self):
        """è·å–æŒä»“æ•°é‡"""
        if self.backtest:
            return self._position
        try:
            return position_holding_qty(self.stock)
        except:
            return 0

    def get_total_cost(self):
        """è·å–æ€»æˆæœ¬"""
        if self.backtest:
            return self._total_cost
        try:
            pos = position_holding_qty(self.stock)
            avg_cost = position_cost(self.stock, cost_price_model=CostPriceModel.AVG)
            return pos * avg_cost
        except:
            return 0.0

    def get_avg_cost(self):
        """è·å–å¹³å‡æˆæœ¬"""
        if self.backtest:
            return self._total_cost / self._position if self._position > 0 else 0.0
        try:
            return position_cost(self.stock, cost_price_model=CostPriceModel.AVG)
        except:
            return 0.0
class Strategy(StrategyBase):
    """DCAå®šæŠ•ç­–ç•¥ - Moomooä¼˜åŒ–ç‰ˆ v2.2.5"""

    def initialize(self):
        """åˆå§‹åŒ–ç­–ç•¥"""
        try:
            self._version = "v2.2.5-MoomooOptimized"
            
            print("ğŸš€ å¼€å§‹åˆå§‹åŒ– {0}".format(self._version))
            
            # æ ¸å¿ƒçŠ¶æ€å˜é‡
            self.current_drawdown_layer = -1
            self.last_investment_time = None
            self.highest_price = None
            self.last_valid_price = 100.0
            self.strategy_start_price = None
            self.drawdown_reset_threshold = 0.05
            
            # å›æµ‹æ”¯æŒå˜é‡
            import collections
            self.high_queue = collections.deque(maxlen=20)
            self._position = 0
            self._total_cost = 0.0
            self.virtual_balance = None
            
            # åˆå§‹åŒ–ç»„ä»¶
            self.trigger_symbols()
            self.custom_indicator()
            self.global_variables()
            self.setup_presets()  # é¢„è®¾è®¾ç½®å…ˆæ‰§è¡Œï¼Œè®¾å®šeffective_qty
            self.setup_tier_features()  # åˆ†å±‚åŠŸèƒ½åæ‰§è¡Œï¼Œä¾èµ–effective_qty
            
            print("âœ… åˆå§‹åŒ–å®Œæˆ")
            self.print_welcome()
            
        except Exception as e:
            print("âŒ åˆå§‹åŒ–å¤±è´¥: {0}".format(str(e)))

    def trigger_symbols(self):
        """è®¾ç½®äº¤æ˜“æ ‡çš„"""
        try:
            self.stock = declare_trig_symbol()
            print("ğŸ“ˆ äº¤æ˜“æ ‡çš„: {0}".format(self.stock))
        except Exception as e:
            print("âŒ æ ‡çš„è®¾ç½®å¤±è´¥: {0}".format(str(e)))

    def custom_indicator(self):
        """æ³¨å†Œè‡ªå®šä¹‰æŠ€æœ¯æŒ‡æ ‡"""
        try:
            self.register_indicator(
                indicator_name='MA',
                script='MA5:MA(CLOSE,5),COLORFF8D1E;',
                param_list=[]
            )
        except Exception as e:
            print("âŒ æŠ€æœ¯æŒ‡æ ‡æ³¨å†Œå¤±è´¥: {0}".format(str(e)))

    def global_variables(self):
        """å…¨å±€å˜é‡è®¾ç½®"""
        try:
            # === åŸºç¡€å‚æ•° ===
            self.qty = show_variable(20, GlobalType.INT)
            self.preset_mode = show_variable(2, GlobalType.INT)  # é»˜è®¤å¹³è¡¡å‹
            self.backtest = show_variable(True, GlobalType.BOOL)
            self.basic_invest_only = show_variable(False, GlobalType.BOOL)
            
            # === åˆ†å±‚åŠŸèƒ½å‚æ•° ===
            self.version_tier = show_variable(2, GlobalType.INT)  # é»˜è®¤ä»˜è´¹ç‰ˆæµ‹è¯•
            self.balance_mode = show_variable(2, GlobalType.INT)  # ä½¿ç”¨è‡ªå®šä¹‰èµ„é‡‘
            self.custom_balance = show_variable(100000, GlobalType.INT)  # å¢åŠ åˆ°10ä¸‡
            self.interval_mode = show_variable(1, GlobalType.INT)  # è‡ªåŠ¨æ¨¡å¼
            self.custom_interval_min = show_variable(1440, GlobalType.INT)
            
            # å›ºå®šå‚æ•°
            self.drawdown_layers = [5.0, 10.0, 20.0]
            self.drawdown_multipliers = [1.5, 2.0, 3.0]
            self.extreme_drawdown_pct = 50.0
            self.log_level = 0
            
            print("âš™ï¸ å‚æ•°é…ç½®å®Œæˆ")
            
        except Exception as e:
            print("âŒ å‚æ•°è®¾ç½®å¤±è´¥: {0}".format(str(e)))

    def setup_presets(self):
        """è®¾ç½®é¢„è®¾æ¨¡æ¿ - å®é™…åº”ç”¨æ•°é‡è®¾ç½®"""
        try:
            presets = {
                1: {"name": "ä¿å®ˆå‹", "description": "ä½é£é™©", "base_qty": 10, "risk_level": "ä½"},
                2: {"name": "å¹³è¡¡å‹", "description": "ä¸­ç­‰é£é™©", "base_qty": 15, "risk_level": "ä¸­"},
                3: {"name": "ç§¯æå‹", "description": "é«˜é£é™©", "base_qty": 25, "risk_level": "é«˜"}
            }
            
            if self.preset_mode in presets:
                preset = presets[self.preset_mode]
                self.preset_name = preset["name"]
                self.preset_desc = preset["description"]
                self.risk_level = preset["risk_level"]
                
                # æ ¹æ®é¢„è®¾è®¡ç®—åˆé€‚çš„æŠ•èµ„é‡
                self.effective_qty = preset["base_qty"]
                print("ğŸ“¦ é¢„è®¾é…ç½®åº”ç”¨: {0} - å®é™…æŠ•èµ„æ•°é‡: {1}è‚¡ (ç”¨æˆ·è¾“å…¥: {2}è‚¡)".format(
                    self.preset_name, self.effective_qty, self.qty))
                    
            else:
                self.preset_name = "è‡ªå®šä¹‰"
                self.preset_desc = "ç”¨æˆ·è‡ªå®šä¹‰å‚æ•°"
                self.risk_level = "ä¸­"
                self.effective_qty = self.qty
                
            print("ğŸ¨ é¢„è®¾é…ç½®: {0} - æ•°é‡: {1}è‚¡".format(self.preset_name, self.effective_qty))
            
        except Exception as e:
            print("âŒ é¢„è®¾é…ç½®å¤±è´¥: {0}".format(str(e)))
            self.preset_name = "é»˜è®¤"
            self.preset_desc = "ç³»ç»Ÿé»˜è®¤é…ç½®"
            self.risk_level = "ä¸­"
            self.effective_qty = self.qty

    def setup_tier_features(self):
        """è®¾ç½®åˆ†å±‚åŠŸèƒ½ç‰¹æ€§"""
        try:
            # èµ„é‡‘ç®¡ç†è®¾ç½®
            if self.version_tier >= 2 and self.balance_mode == 2:
                if self.backtest:
                    self.initial_balance = self.custom_balance
                    self.virtual_balance = self.custom_balance
                print("ğŸ’° ä½¿ç”¨è‡ªå®šä¹‰èµ„é‡‘: ${0:,}".format(self.custom_balance))
            else:
                if self.backtest:
                    try:
                        self.initial_balance = total_cash(currency=Currency.USD)
                        if self.initial_balance is None or self.initial_balance <= 0:
                            self.initial_balance = 10000.0
                        self.virtual_balance = self.initial_balance
                    except:
                        self.initial_balance = 10000.0
                        self.virtual_balance = 10000.0
                        print("âš ï¸ ä½¿ç”¨é»˜è®¤èµ„é‡‘$10,000")
                
            # æŠ•èµ„å‘¨æœŸè®¾ç½®
            if self.interval_mode == 1:  # è‡ªåŠ¨æ¨¡å¼
                if self.version_tier == 1:
                    self.interval_min = 10080  # æ¯å‘¨
                    self.interval_desc = "æ¯å‘¨å®šæŠ• (å…è´¹ç‰ˆ)"
                else:
                    # ä»˜è´¹ç‰ˆæ™ºèƒ½é¢‘ç‡ï¼šæ ¹æ®èµ„é‡‘å’Œæ•°é‡è‡ªåŠ¨è°ƒæ•´
                    daily_cost = self.effective_qty * 600  # ä¼°ç®—æ¯æ—¥æˆæœ¬(SPYçº¦$600)
                    max_days = int(self.virtual_balance / daily_cost)
                    
                    if max_days >= 30:  # èµ„é‡‘å¤Ÿ30å¤©ä»¥ä¸Šï¼Œä½¿ç”¨æ¯æ—¥
                        self.interval_min = 1440
                        self.interval_desc = "æ¯æ—¥å®šæŠ• (ä»˜è´¹ç‰ˆæ™ºèƒ½)"
                    elif max_days >= 4:  # èµ„é‡‘å¤Ÿ4å‘¨ä»¥ä¸Šï¼Œä½¿ç”¨æ¯å‘¨
                        self.interval_min = 10080
                        self.interval_desc = "æ¯å‘¨å®šæŠ• (ä»˜è´¹ç‰ˆæ™ºèƒ½)"
                    else:  # èµ„é‡‘ä¸è¶³ï¼Œä½¿ç”¨åŒå‘¨
                        self.interval_min = 20160
                        self.interval_desc = "åŒå‘¨å®šæŠ• (èµ„é‡‘ä¼˜åŒ–)"
                        
                    print("ğŸ“Š æ™ºèƒ½é¢‘ç‡è®¡ç®—: é¢„ä¼°{0}å¤©èµ„é‡‘ï¼Œé€‰æ‹©{1}".format(max_days, self.interval_desc))
                    
            elif self.interval_mode == 2:  # å¼ºåˆ¶æ¯æ—¥
                if self.version_tier >= 2:
                    self.interval_min = 1440
                    self.interval_desc = "æ¯æ—¥å®šæŠ•"
                else:
                    print("ğŸ’¡ æ¯æ—¥å®šæŠ•ä¸ºä»˜è´¹ç‰ˆåŠŸèƒ½")
                    self.interval_min = 10080
                    self.interval_desc = "æ¯å‘¨å®šæŠ• (å…è´¹ç‰ˆé™åˆ¶)"
            elif self.interval_mode == 3:  # æ¯å‘¨
                self.interval_min = 10080
                self.interval_desc = "æ¯å‘¨å®šæŠ•"
            elif self.interval_mode == 4:  # è‡ªå®šä¹‰
                if self.version_tier >= 2:
                    self.interval_min = self.custom_interval_min
                    self.interval_desc = "è‡ªå®šä¹‰å‘¨æœŸ ({0}åˆ†é’Ÿ)".format(self.interval_min)
                else:
                    print("ğŸ’¡ è‡ªå®šä¹‰å‘¨æœŸä¸ºä»˜è´¹ç‰ˆåŠŸèƒ½")
                    self.interval_min = 10080
                    self.interval_desc = "æ¯å‘¨å®šæŠ• (å…è´¹ç‰ˆé™åˆ¶)"
            
            print("ğŸ“… æŠ•èµ„å‘¨æœŸ: {0}".format(self.interval_desc))
            
        except Exception as e:
            print("âŒ åˆ†å±‚åŠŸèƒ½è®¾ç½®å¤±è´¥: {0}".format(str(e)))
            self.interval_min = 10080 if getattr(self, 'version_tier', 1) == 1 else 1440
            self.interval_desc = "é»˜è®¤å‘¨æœŸ ({0}åˆ†é’Ÿ)".format(self.interval_min)
            if not hasattr(self, 'virtual_balance') or self.virtual_balance is None:
                self.virtual_balance = 10000.0
                self.initial_balance = 10000.0

    def print_welcome(self):
        """æ‰“å°æ¬¢è¿ä¿¡æ¯"""
        version_info = {
            1: {"name": "å…è´¹åŸºç¡€ç‰ˆ", "features": "å›ºå®šå®šæŠ•+é£é™©æé†’", "color": "ğŸ†“"},
            2: {"name": "ä»˜è´¹è¿›é˜¶ç‰ˆ(Â¥35/æœˆ)", "features": "æ™ºèƒ½åŠ ä»“ç³»ç»Ÿ", "color": "ğŸ’"}
        }
        
        current_version = version_info.get(self.version_tier, version_info[1])
        
        print("="*60)
        print("ğŸš€ DCAæ™ºèƒ½å®šæŠ•ç­–ç•¥ {0}".format(self._version))
        print("="*60)
        print("{0} å½“å‰ç‰ˆæœ¬: {1}".format(current_version['color'], current_version['name']))
        print("âœ¨ æ ¸å¿ƒåŠŸèƒ½: {0}".format(current_version['features']))
        
        print("\nğŸ“Š å½“å‰é…ç½®:")
        print("   ç‰ˆæœ¬ç­‰çº§: {0} ({1})".format(self.version_tier, 'å…è´¹ç‰ˆ' if self.version_tier == 1 else 'ä»˜è´¹ç‰ˆ'))
        print("   æŠ•èµ„æ¨¡æ¿: {0} ({1})".format(self.preset_name, self.preset_desc))
        print("   ç”¨æˆ·è®¾ç½®: {0}è‚¡".format(self.qty))
        print("   å®é™…æŠ•èµ„: {0}è‚¡ (é¢„è®¾ä¼˜åŒ–)".format(self.effective_qty))
        print("   æŠ•èµ„å‘¨æœŸ: {0}".format(getattr(self, 'interval_desc', 'æœªçŸ¥')))
        if hasattr(self, 'virtual_balance'):
            print("   åˆå§‹èµ„é‡‘: ${0:,.0f}".format(self.virtual_balance))
            # è®¡ç®—å¤§çº¦å¯æŠ•èµ„å¤©æ•°
            daily_cost = self.effective_qty * 600  # ä¼°ç®—
            estimated_days = int(self.virtual_balance / daily_cost)
            print("   é¢„ä¼°æŠ•èµ„: çº¦{0}å¤© (åŸºäºSPY $600)".format(estimated_days))
        print("   è¿è¡Œæ¨¡å¼: {0}".format('å›æµ‹' if self.backtest else 'å®ç›˜'))
        
        if self.version_tier == 1:
            print("\nğŸ¯ å‡çº§æç¤º:")
            print("   ğŸ’¡ ä»˜è´¹ç‰ˆæ”¯æŒæ™ºèƒ½é¢‘ç‡è°ƒæ•´")
            print("   ğŸ’¡ ä»˜è´¹ç‰ˆæ”¯æŒæ™ºèƒ½åŠ ä»“ç³»ç»Ÿ")
            print("   ğŸ’° è”ç³»ä½œè€…å‡çº§è‡³ä»˜è´¹ç‰ˆ(Â¥35/æœˆ)")
        
        print("="*60 + "\n")

    def handle_data(self):
        """ä¸»è¦äº¤æ˜“é€»è¾‘"""
        try:
            current_time = device_time(TimeZone.DEVICE_TIME_ZONE)
            latest_price, highest_price, account_balance = self.get_market_data()
            
            drawdown = self.calculate_drawdown(latest_price)
            
            # åˆ†å±‚åŠŸèƒ½è·¯ç”±
            if self.version_tier == 1:
                self.free_version_logic(current_time, latest_price, account_balance, drawdown)
            elif self.version_tier == 2:
                self.advanced_version_logic(current_time, latest_price, account_balance, drawdown)
            else:
                print("âš ï¸ ç‰ˆæœ¬å‚æ•°é”™è¯¯ï¼Œä½¿ç”¨å…è´¹ç‰ˆåŠŸèƒ½")
                self.free_version_logic(current_time, latest_price, account_balance, drawdown)

        except Exception as e:
            print("âŒ ç­–ç•¥æ‰§è¡Œé”™è¯¯: {0}".format(str(e)))

    def get_market_data(self):
        """è·å–å¸‚åœºæ•°æ®"""
        if self.backtest:
            try:
                if not hasattr(self, 'bar_index'):
                    self.bar_index = 0
                self.bar_index += 1
                
                latest_price = bar_close(self.stock, bar_type=BarType.D1, select=1)
                if latest_price is None or latest_price <= 0:
                    latest_price = 100.0
                
                if latest_price > 0:
                    self.last_valid_price = latest_price
                
                self.high_queue.append(latest_price)
                
                # è®¡ç®—æœ€é«˜ä»·
                available_days = self.bar_index if self.bar_index < 20 else 20
                high_list = list(self.high_queue)[-available_days:]
                if len(high_list) == 0:
                    highest_price = latest_price
                else:
                    highest_price = high_list[0]
                    for price in high_list[1:]:
                        if price > highest_price:
                            highest_price = price
                
                account_balance = self.virtual_balance
                return latest_price, highest_price, account_balance
            except Exception as e:
                print("å›æµ‹æ•°æ®è·å–é”™è¯¯: {0}".format(str(e)))
                default_balance = getattr(self, 'virtual_balance', 10000.0) or 10000.0
                return self.last_valid_price, self.last_valid_price, default_balance
        else:
            # å®ç›˜æ¨¡å¼
            latest_price = current_price(self.stock, price_type=THType.FTH)
            if latest_price is None or latest_price <= 0:
                latest_price = self.last_valid_price
            else:
                self.last_valid_price = latest_price
            
            high_list = [bar_high(self.stock, bar_type=BarType.D1, select=i) for i in range(1, 21)]
            valid_highs = [h for h in high_list if h is not None and h > 0]
            if len(valid_highs) == 0:
                highest_price = latest_price
            else:
                highest_price = valid_highs[0]
                for price in valid_highs[1:]:
                    if price > highest_price:
                        highest_price = price
            
            account_balance = total_cash(currency=Currency.USD)
            return latest_price, highest_price, account_balance

    def calculate_drawdown(self, latest_price):
        """è®¡ç®—å›æ’¤å¹…åº¦"""
        if self.strategy_start_price is None:
            self.strategy_start_price = latest_price
            self.highest_price = latest_price
            return 0.0
            
        if latest_price > self.highest_price:
            self.highest_price = latest_price
            if (latest_price - self.highest_price) / self.highest_price > self.drawdown_reset_threshold:
                self.current_drawdown_layer = -1
        
        if self.highest_price > 0:
            drawdown = (self.highest_price - latest_price) / self.highest_price * 100
        else:
            drawdown = 0.0
            
        return drawdown

    def calculate_add_position_qty(self, drawdown):
        """è®¡ç®—åŠ ä»“æ•°é‡"""
        for i, threshold in enumerate(self.drawdown_layers):
            if drawdown >= threshold:
                if i <= self.current_drawdown_layer:
                    continue
                    
                self.current_drawdown_layer = i
                add_qty = int(self.effective_qty * self.drawdown_multipliers[i])
                
                print("ğŸ¯ å›æ’¤åŠ ä»“è§¦å‘: ç¬¬{0}å±‚ ({1}%), æ•°é‡={2}è‚¡".format(i+1, threshold, add_qty))
                return add_qty
        
        return 0

    def should_invest(self, current_time):
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥å®šæŠ•"""
        if self.last_investment_time is None:
            return True
        elapsed = (current_time - self.last_investment_time).total_seconds() / 60
        
        if not hasattr(self, 'interval_min') or self.interval_min is None:
            default_interval = 10080 if getattr(self, 'version_tier', 1) == 1 else 1440
            self.interval_min = default_interval
        
        return elapsed >= self.interval_min

    def free_version_logic(self, current_time, latest_price, account_balance, drawdown):
        """å…è´¹ç‰ˆç­–ç•¥é€»è¾‘"""
        
        # é£é™©æé†’åŠŸèƒ½
        if drawdown >= 20.0:
            print("âš ï¸ å…è´¹ç‰ˆé£é™©æé†’: å½“å‰å›æ’¤{0:.1f}%".format(drawdown))
        elif drawdown >= 10.0:
            print("ğŸ“¢ å›æ’¤ç›‘æ§: å½“å‰å›æ’¤{0:.1f}%".format(drawdown))
            
        # å®šæŠ•é€»è¾‘
        basic_only = bool(getattr(self, 'basic_invest_only', False))
        if basic_only or True:  # å…è´¹ç‰ˆåªåšå®šæŠ•
            if self.should_invest(current_time):
                self.execute_investment(latest_price, account_balance, self.effective_qty, "åŸºç¡€å®šæŠ•")

    def advanced_version_logic(self, current_time, latest_price, account_balance, drawdown):
        """ä»˜è´¹ç‰ˆç­–ç•¥é€»è¾‘"""
        
        if self.version_tier != 2:
            print("ğŸ’¡ æ™ºèƒ½åŠ ä»“åŠŸèƒ½éœ€è¦å‡çº§åˆ°ä»˜è´¹ç‰ˆ(Â¥35/æœˆ)")
            return self.free_version_logic(current_time, latest_price, account_balance, drawdown)
        
        # æç«¯å›æ’¤ä¿æŠ¤
        if drawdown >= self.extreme_drawdown_pct:
            print("ğŸš¨ æç«¯å›æ’¤ä¿æŠ¤: {0:.1f}%ï¼Œä»…å®šæŠ•æ¨¡å¼".format(drawdown))
            if self.should_invest(current_time):
                self.execute_investment(latest_price, account_balance, self.effective_qty, "æç«¯å›æ’¤ä¿æŠ¤")
            return

        # æ™ºèƒ½åŠ ä»“ç³»ç»Ÿ
        add_qty = self.calculate_add_position_qty(drawdown)
        if add_qty > 0:
            self.execute_investment(latest_price, account_balance, add_qty, "ä»˜è´¹ç‰ˆ-æ™ºèƒ½åŠ ä»“")
            return

        # å¸¸è§„å®šæŠ•
        if self.should_invest(current_time):
            self.execute_investment(latest_price, account_balance, self.effective_qty, "ä»˜è´¹ç‰ˆ-å®šæœŸå®šæŠ•")

    def execute_investment(self, latest_price, account_balance, quantity, trade_type="å®šæŠ•"):
        """æ‰§è¡ŒæŠ•èµ„"""
        
        # å‚æ•°æ£€æŸ¥
        if self.version_tier == 2:
            if quantity < 1 or quantity > 1000:
                print("âš ï¸ ä»˜è´¹ç‰ˆå‚æ•°ä¿®æ­£: æŠ•èµ„æ•°é‡ {0} -> {1}è‚¡".format(quantity, self.effective_qty))
                quantity = self.effective_qty
        else:
            if quantity < 10 or quantity > 100 or quantity % 10 != 0:
                print("âš ï¸ å…è´¹ç‰ˆå‚æ•°ä¿®æ­£: æŠ•èµ„æ•°é‡ {0} -> 10è‚¡".format(quantity))
                quantity = 10

        if self.backtest:
            # å›æµ‹æ¨¡å¼
            required_cash = quantity * latest_price
            
            if self.virtual_balance is None:
                self.virtual_balance = 10000.0
            
            if required_cash > self.virtual_balance:
                # æ™ºèƒ½èµ„é‡‘è°ƒæ•´
                max_qty = int(self.virtual_balance // latest_price)
                if max_qty < 1:
                    print("ğŸ’° è™šæ‹Ÿä½™é¢ä¸è¶³: ${0:.0f} < ${1:.0f}".format(self.virtual_balance, required_cash))
                    print("ğŸ“Š å»ºè®®: å¢åŠ initial_balanceæˆ–å‡å°‘æŠ•èµ„é¢‘ç‡")
                    return
                quantity = max_qty
                required_cash = quantity * latest_price
                print("âš ï¸ æ™ºèƒ½èµ„é‡‘è°ƒæ•´: åŸè®¡åˆ’{0}è‚¡ â†’ å®é™…{1}è‚¡ (å‰©ä½™${2:.0f})".format(
                    int(self.effective_qty), quantity, self.virtual_balance))
            
            if quantity < 1:
                print("ğŸ’° è°ƒæ•´åæ•°é‡ä¸è¶³1è‚¡")
                return

            # ä¸‹å•
            order_id = place_market(self.stock, quantity, OrderSide.BUY, TimeInForce.DAY)
            
            print("ğŸ“Š {0}: {1}è‚¡ @ ${2:.2f}".format(trade_type, quantity, latest_price))
            
            # æ›´æ–°è´¦æˆ·
            self.virtual_balance -= required_cash
            self._total_cost += required_cash
            self._position += quantity
            
            print("ğŸ’° ä½™é¢: ${0:.2f} | æŒä»“: {1}è‚¡".format(self.virtual_balance, self._position))
            
        else:
            # å®ç›˜æ¨¡å¼
            required_cash = quantity * latest_price
            if required_cash > account_balance:
                max_qty = int((account_balance // latest_price) // 10 * 10)
                if max_qty < 10:
                    print("ğŸ’° èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•æŠ•èµ„")
                    return
                quantity = max_qty
                print("âš ï¸ èµ„é‡‘è°ƒæ•´: æŠ•èµ„æ•°é‡è°ƒæ•´ä¸º {0}è‚¡".format(quantity))

            try:
                order_id = place_market(self.stock, quantity, OrderSide.BUY, TimeInForce.DAY)
                print("âœ… {0}è®¢å•: {1}è‚¡ @ å¸‚ä»·, è®¢å•å·: {2}".format(trade_type, quantity, order_id))
            except Exception as e:
                print("âŒ ä¸‹å•å¤±è´¥: {0}".format(str(e)))
                return

        self.last_investment_time = device_time(TimeZone.DEVICE_TIME_ZONE)

    def get_position(self):
        """è·å–æŒä»“æ•°é‡"""
        if self.backtest:
            return self._position
        try:
            return position_holding_qty(self.stock)
        except:
            return 0

    def get_total_cost(self):
        """è·å–æ€»æˆæœ¬"""
        if self.backtest:
            return self._total_cost
        try:
            pos = position_holding_qty(self.stock)
            avg_cost = position_cost(self.stock, cost_price_model=CostPriceModel.AVG)
            return pos * avg_cost
        except:
            return 0.0

    def get_avg_cost(self):
        """è·å–å¹³å‡æˆæœ¬"""
        if self.backtest:
            return self._total_cost / self._position if self._position > 0 else 0.0
        try:
            return position_cost(self.stock, cost_price_model=CostPriceModel.AVG)
        except:
            return 0.0
class Strategy(StrategyBase):
    """ä»˜è´¹DCAå®šæŠ•ç­–ç•¥ - v2.2.5-Premium-Stable (Â¥35/æœˆ)
    
    ä¸“ä¸šçº§DCAç­–ç•¥ï¼ŒåŒ…å«å®Œæ•´çš„æ™ºèƒ½åŠ ä»“ç³»ç»Ÿ
    - æ¯æ—¥å®šæŠ• (éªŒè¯çš„+4.1%æ”¶ç›Šä¼˜åŠ¿)
    - 3å±‚æ™ºèƒ½åŠ ä»“ä¿æŠ¤ç³»ç»Ÿ (5%/10%/20%å›æ’¤)
    - è‡ªå®šä¹‰èµ„é‡‘å’ŒæŠ•èµ„å‘¨æœŸ (10K-500KèŒƒå›´)
    - ä¸“å±å®¢æœå’ŒæŠ€æœ¯æ”¯æŒ
    
    [v2.2.5 ä»˜è´¹ç‰ˆä¸“äº«åŠŸèƒ½]
    ğŸ’ æ¯æ—¥å®šæŠ•ï¼šæ›´å¹³æ»‘çš„æˆæœ¬å¹³å‡ï¼Œå‡å°‘å¸‚åœºæ³¢åŠ¨å½±å“
    ğŸ’ æ™ºèƒ½åŠ ä»“ï¼š3å±‚å›æ’¤ä¿æŠ¤ï¼Œç†Šå¸‚æœŸé—´è‡ªåŠ¨å¢åŠ æŠ•èµ„
    ğŸ’ èµ„é‡‘å®šåˆ¶ï¼šæ”¯æŒ10K-500Kè‡ªå®šä¹‰èµ„é‡‘ï¼Œçµæ´»é…ç½®
    ğŸ’ å‘¨æœŸå®šåˆ¶ï¼šæ”¯æŒæ¯æ—¥/æ¯å‘¨/è‡ªå®šä¹‰å‘¨æœŸï¼Œæ»¡è¶³ä¸åŒéœ€æ±‚
    ğŸ’ é¢„è®¾æ¨¡æ¿ï¼šä¿å®ˆ/å¹³è¡¡/ç§¯æä¸‰ç§æ¨¡æ¿ï¼Œé€‚åˆä¸åŒé£é™©åå¥½
    
    ğŸš€ ç›¸æ¯”å…è´¹ç‰ˆä¼˜åŠ¿ï¼š
    - æŠ•èµ„é¢‘ç‡ï¼š7å€æå‡ï¼ˆæ¯æ—¥ vs æ¯å‘¨ï¼‰
    - æˆæœ¬ä¼˜åŒ–ï¼š3-8%æ”¶ç›Šæå‡ï¼ˆå†å²æ•°æ®éªŒè¯ï¼‰
    - é£é™©æ§åˆ¶ï¼šæ™ºèƒ½åŠ ä»“ç³»ç»Ÿï¼Œç†Šå¸‚ä¿æŠ¤
    - é…ç½®çµæ´»ï¼šå®Œå…¨è‡ªå®šä¹‰åŒ–å‚æ•°è®¾ç½®
    """

    def initialize(self):
        """åˆå§‹åŒ–ç­–ç•¥"""
        try:
            self._version = "v2.2.5-Premium-Stable"
            self._tier = "ä»˜è´¹ä¸“ä¸šç‰ˆ"
            self._description = (
                "ğŸ’ ä»˜è´¹DCAå®šæŠ•ç­–ç•¥ - ä¸“ä¸šåŠŸèƒ½ç‰ˆ\n"
                "âœ… æ¯æ—¥æ™ºèƒ½å®šæŠ• (éªŒè¯çš„+4.1%æ”¶ç›Šä¼˜åŠ¿)\n" 
                "âœ… 3å±‚æ™ºèƒ½åŠ ä»“ç³»ç»Ÿ (5%/10%/20%å›æ’¤ä¿æŠ¤)\n"
                "âœ… è‡ªå®šä¹‰èµ„é‡‘ç®¡ç† (10K-500KèŒƒå›´)\n"
                "âœ… çµæ´»æŠ•èµ„å‘¨æœŸ (æ¯æ—¥/æ¯å‘¨/è‡ªå®šä¹‰)\n"
                "âœ… ä¸“å±å®¢æœå’ŒæŠ€æœ¯æ”¯æŒ"
            )
            
            print(f"ğŸš€ å¼€å§‹åˆå§‹åŒ– {self._version}")
            
            # é¦–å…ˆè®¾ç½®æ ¸å¿ƒçŠ¶æ€å˜é‡
            self.current_drawdown_layer = -1  # -1è¡¨ç¤ºè¿˜æ²¡æœ‰è§¦å‘ä»»ä½•å±‚çº§
            self.last_investment_time = None
            self.highest_price = None
            self.last_valid_price = 100.0  # é»˜è®¤ä»·æ ¼
            self.strategy_start_price = None  # ç­–ç•¥å¯åŠ¨ä»·æ ¼
            self.drawdown_reset_threshold = 0.05  # ä»·æ ¼ä¸Šæ¶¨5%é‡ç½®å›æ’¤å±‚çº§
            
            # å›æµ‹æ”¯æŒå˜é‡åˆå§‹åŒ–
            import collections
            self.high_queue = collections.deque(maxlen=20)
            self._position = 0
            self._total_cost = 0.0
            self.virtual_balance = None  # å…ˆåˆå§‹åŒ–ä¸ºNone
            
            # ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ç»„ä»¶åˆå§‹åŒ–
            print("ğŸ“ ç¬¬ä¸€é˜¶æ®µ: åŸºç¡€ç»„ä»¶åˆå§‹åŒ–")
            self.trigger_symbols()
            self.custom_indicator()
            
            # ç¬¬äºŒé˜¶æ®µï¼šç”¨æˆ·å‚æ•°è®¾ç½®
            print("ğŸ“ ç¬¬äºŒé˜¶æ®µ: ç”¨æˆ·å‚æ•°è®¾ç½®")
            self.global_variables()
            
            # ç¬¬ä¸‰é˜¶æ®µï¼šä»˜è´¹ç‰ˆåŠŸèƒ½è®¾ç½®
            print("ğŸ“ ç¬¬ä¸‰é˜¶æ®µ: ä»˜è´¹ç‰ˆåŠŸèƒ½è®¾ç½®")
            self.setup_premium_features()
            
            # ç¬¬å››é˜¶æ®µï¼šé¢„è®¾é…ç½®åº”ç”¨
            print("ğŸ“ ç¬¬å››é˜¶æ®µ: é¢„è®¾é…ç½®åº”ç”¨")
            self.setup_presets()
            
            # ç¬¬äº”é˜¶æ®µï¼šæœ€ç»ˆéªŒè¯å’Œå…œåº•è®¾ç½®
            print("ğŸ“ ç¬¬äº”é˜¶æ®µ: æœ€ç»ˆéªŒè¯å’Œå…œåº•è®¾ç½®")
            if not hasattr(self, 'interval_min') or self.interval_min is None:
                self.interval_min = 1440  # ä»˜è´¹ç‰ˆé»˜è®¤æ¯æ—¥
                print(f"âš ï¸ æœ€ç»ˆæ£€æŸ¥: è®¾ç½®ä»˜è´¹ç‰ˆæ¯æ—¥å®šæŠ•({self.interval_min}åˆ†é’Ÿ)")
            
            # ç¡®ä¿è™šæ‹Ÿä½™é¢å·²æ­£ç¡®è®¾ç½®
            if self.backtest:
                if not hasattr(self, 'initial_balance') or self.initial_balance is None:
                    # ä»˜è´¹ç‰ˆé»˜è®¤ä½¿ç”¨è‡ªå®šä¹‰èµ„é‡‘æˆ–ç³»ç»Ÿèµ„é‡‘
                    if self.balance_mode == 2:
                        self.initial_balance = self.custom_balance
                    else:
                        try:
                            self.initial_balance = total_cash(currency=Currency.USD)
                            if self.initial_balance is None or self.initial_balance <= 0:
                                self.initial_balance = 50000.0  # ä»˜è´¹ç‰ˆé»˜è®¤5ä¸‡ç¾å…ƒ
                        except:
                            self.initial_balance = 50000.0
                            print("âš ï¸ åˆå§‹åŒ–ï¼šæ— æ³•è·å–è´¦æˆ·ä½™é¢ï¼Œä½¿ç”¨ä»˜è´¹ç‰ˆé»˜è®¤$50,000")
                        
                if not hasattr(self, 'virtual_balance') or self.virtual_balance is None:
                    self.virtual_balance = self.initial_balance
                    
            print(f"âœ… åˆå§‹åŒ–å®Œæˆï¼šè™šæ‹Ÿä½™é¢=${getattr(self, 'virtual_balance', 0):,.0f}")
            
            # è¯¦ç»†çš„åˆå§‹åŒ–çŠ¶æ€æ—¥å¿—
            self.print_initialization_status()
            self.print_welcome()
            
        except Exception as e:
            print(f"âŒ åˆå§‹åŒ–å¤±è´¥: {str(e)}")
            import traceback
            print(f"è¯¦ç»†é”™è¯¯: {traceback.format_exc()}")

    def trigger_symbols(self):
        """è®¾ç½®äº¤æ˜“æ ‡çš„"""
        try:
            self.stock = declare_trig_symbol()
            print(f"ğŸ“ˆ äº¤æ˜“æ ‡çš„: {self.stock}")
        except Exception as e:
            print(f"âŒ æ ‡çš„è®¾ç½®å¤±è´¥: {str(e)}")

    def custom_indicator(self):
        """æ³¨å†Œè‡ªå®šä¹‰æŠ€æœ¯æŒ‡æ ‡"""
        try:
            # æ³¨å†Œä¸€ä¸ªç®€å•çš„ç§»åŠ¨å¹³å‡çº¿æŒ‡æ ‡ä¾›å‚è€ƒ
            self.register_indicator(
                indicator_name='MA',
                script='MA5:MA(CLOSE,5),COLORFF8D1E;',
                param_list=[]
            )
            print("ğŸ“Š æŠ€æœ¯æŒ‡æ ‡æ³¨å†Œå®Œæˆ")
        except Exception as e:
            print(f"âŒ æŠ€æœ¯æŒ‡æ ‡æ³¨å†Œå¤±è´¥: {str(e)}")

    def global_variables(self):
        """å…¨å±€å˜é‡è®¾ç½® - ä»˜è´¹ç‰ˆå®Œæ•´åŠŸèƒ½"""
        try:
            print("ğŸ”§ å¼€å§‹è®¾ç½®ä»˜è´¹ç‰ˆå‚æ•°...")
            
            # === ä»˜è´¹ç‰ˆç”¨æˆ·å¯é…ç½®å‚æ•° ===
            self.qty = show_variable(20, GlobalType.INT)  # æ¯æ¬¡å®šæŠ•è‚¡æ•°
            self.preset_mode = show_variable(2, GlobalType.INT)  # 1=ä¿å®ˆ 2=å¹³è¡¡ 3=ç§¯æ
            self.backtest = show_variable(True, GlobalType.BOOL)  # å›æµ‹æ¨¡å¼
            self.basic_invest_only = show_variable(False, GlobalType.BOOL)  # ä»…å®šæŠ•æ¨¡å¼
            
            # === ä»˜è´¹ç‰ˆä¸“å±åŠŸèƒ½é…ç½® ===
            print("\nğŸ’ ä»˜è´¹ç‰ˆä¸“å±åŠŸèƒ½é…ç½®:")
            self.balance_mode = show_variable(1, GlobalType.INT)  # 1=ç³»ç»Ÿé»˜è®¤ 2=è‡ªå®šä¹‰èµ„é‡‘
            self.custom_balance = show_variable(50000, GlobalType.INT)  # è‡ªå®šä¹‰èµ„é‡‘(10K-500K)
            self.interval_mode = show_variable(1, GlobalType.INT)  # 1=è‡ªåŠ¨(æ¯æ—¥) 2=æ¯æ—¥ 3=æ¯å‘¨ 4=è‡ªå®šä¹‰
            self.custom_interval_min = show_variable(1440, GlobalType.INT)  # è‡ªå®šä¹‰å‘¨æœŸ(åˆ†é’Ÿ)
            
            # === ä»˜è´¹ç‰ˆå›ºå®šå‚æ•° ===
            self.version_tier = 2  # å›ºå®šä»˜è´¹ç‰ˆ
            
            # ä¿®å¤å‚æ•°ç±»å‹é—®é¢˜
            if isinstance(getattr(self, 'basic_invest_only', False), int):
                self.basic_invest_only = bool(self.basic_invest_only)
                print(f"ğŸ”§ ä¿®æ­£basic_invest_onlyç±»å‹: int -> bool({self.basic_invest_only})")
            
            # ä»˜è´¹ç‰ˆå›ºå®šå‚æ•°ï¼ˆä¼˜åŒ–é…ç½®ï¼‰
            self.drawdown_layers = [5.0, 10.0, 20.0]  # 3å±‚å›æ’¤é˜ˆå€¼
            self.drawdown_multipliers = [1.5, 2.0, 3.0]  # å¯¹åº”åŠ ä»“å€æ•°
            self.extreme_drawdown_pct = 50.0  # æç«¯å›æ’¤ä¿æŠ¤
            self.log_level = 0  # ç®€åŒ–æ—¥å¿—
            
            # éªŒè¯å…³é”®å‚æ•°æ˜¯å¦æ­£ç¡®è®¾ç½®
            print(f"ğŸ” éªŒè¯ä»˜è´¹ç‰ˆå‚æ•°:")
            print(f"   qty: {getattr(self, 'qty', 'MISSING')} (æœŸæœ›: 20)")
            print(f"   version_tier: {getattr(self, 'version_tier', 'MISSING')} (å›ºå®š: 2)")
            print(f"   balance_mode: {getattr(self, 'balance_mode', 'MISSING')} (æœŸæœ›: 1æˆ–2)")
            print(f"   interval_mode: {getattr(self, 'interval_mode', 'MISSING')} (æœŸæœ›: 1-4)")
            print(f"   basic_invest_only: {getattr(self, 'basic_invest_only', 'MISSING')} (ç±»å‹: {type(getattr(self, 'basic_invest_only', None))})")
            
            print(f"âš™ï¸ ä»˜è´¹ç‰ˆå‚æ•°é…ç½®å®Œæˆ")
            
        except Exception as e:
            print(f"âŒ å‚æ•°è®¾ç½®å¤±è´¥: {str(e)}")
            import traceback
            print(f"è¯¦ç»†é”™è¯¯: {traceback.format_exc()}")
            # å…œåº•ï¼šè®¾ç½®ä»˜è´¹ç‰ˆé»˜è®¤å€¼
            self.qty = 20
            self.preset_mode = 2
            self.backtest = True
            self.basic_invest_only = False
            self.version_tier = 2
            self.balance_mode = 1
            self.custom_balance = 50000
            self.interval_mode = 1
            self.custom_interval_min = 1440
            self.drawdown_layers = [5.0, 10.0, 20.0]
            self.drawdown_multipliers = [1.5, 2.0, 3.0] 
            self.extreme_drawdown_pct = 50.0
            self.log_level = 0
            print("ğŸ†˜ ä½¿ç”¨ä»˜è´¹ç‰ˆå…œåº•é»˜è®¤å€¼è®¾ç½®")

    def setup_presets(self):
        """è®¾ç½®é¢„è®¾æ¨¡æ¿ - ä»˜è´¹ç‰ˆ"""
        try:
            print(f"ğŸ¨ å¼€å§‹åº”ç”¨é¢„è®¾é…ç½®: preset_mode={getattr(self, 'preset_mode', 'None')}")
            
            presets = {
                1: {  # ä¿å®ˆå‹
                    "name": "ä¿å®ˆå‹",
                    "description": "ä½é£é™©ï¼Œé€‚åˆç¨³å¥æŠ•èµ„è€…",
                    "base_qty": 10,
                    "risk_level": "ä½"
                },
                2: {  # å¹³è¡¡å‹  
                    "name": "å¹³è¡¡å‹",
                    "description": "ä¸­ç­‰é£é™©æ”¶ç›Šï¼Œé€‚åˆå¤§å¤šæ•°ç”¨æˆ·", 
                    "base_qty": None,  # ä½¿ç”¨ç”¨æˆ·è¾“å…¥å€¼
                    "risk_level": "ä¸­"
                },
                3: {  # ç§¯æå‹
                    "name": "ç§¯æå‹", 
                    "description": "é«˜é¢‘äº¤æ˜“ï¼Œé€‚åˆé£é™©æ‰¿å—èƒ½åŠ›å¼ºçš„ç”¨æˆ·",
                    "base_qty": 50,
                    "risk_level": "é«˜"
                }
            }
            
            if self.preset_mode in presets:
                preset = presets[self.preset_mode]
                self.preset_name = preset["name"]
                self.preset_desc = preset["description"] 
                self.risk_level = preset["risk_level"]
                
                # åº”ç”¨é¢„è®¾æ•°é‡ï¼ˆä»…åœ¨é¢„è®¾æœ‰ç‰¹å®šå€¼ä¸”ç”¨æˆ·ä½¿ç”¨é»˜è®¤å€¼æ—¶ï¼‰
                if preset["base_qty"] is not None and self.qty == 20:  # é»˜è®¤å€¼20
                    print(f"ğŸ“¦ åº”ç”¨é¢„è®¾æ•°é‡: {self.qty} -> {preset['base_qty']}")
                    self.qty = preset["base_qty"]
                else:
                    print(f"ğŸ“¦ ä¿æŒç”¨æˆ·æ•°é‡è®¾ç½®: {self.qty}")
                    
            else:
                self.preset_name = "è‡ªå®šä¹‰"
                self.preset_desc = "ç”¨æˆ·è‡ªå®šä¹‰å‚æ•°"
                self.risk_level = "æœªçŸ¥"
                
            print(f"ğŸ¨ é¢„è®¾é…ç½®å®Œæˆ: {self.preset_name} - æ•°é‡: {self.qty}è‚¡")
            
        except Exception as e:
            print(f"âŒ é¢„è®¾é…ç½®å¤±è´¥: {str(e)}")
            # è®¾ç½®é»˜è®¤å€¼
            self.preset_name = "é»˜è®¤"
            self.preset_desc = "ç³»ç»Ÿé»˜è®¤é…ç½®"
            self.risk_level = "ä¸­"

    def setup_premium_features(self):
        """è®¾ç½®ä»˜è´¹ç‰ˆåŠŸèƒ½ç‰¹æ€§"""
        try:
            print(f"ğŸ”§ å¼€å§‹ä»˜è´¹ç‰ˆåŠŸèƒ½è®¾ç½®")
            
            # èµ„é‡‘ç®¡ç†è®¾ç½®
            if self.balance_mode == 2:
                # ä½¿ç”¨è‡ªå®šä¹‰èµ„é‡‘
                if self.backtest:
                    self.initial_balance = self.custom_balance
                    self.virtual_balance = self.custom_balance
                print(f"ğŸ’° ä½¿ç”¨è‡ªå®šä¹‰èµ„é‡‘: ${self.custom_balance:,}")
            else:
                # ä½¿ç”¨ç³»ç»Ÿé»˜è®¤èµ„é‡‘
                if self.backtest:
                    try:
                        self.initial_balance = total_cash(currency=Currency.USD)
                        if self.initial_balance is None or self.initial_balance <= 0:
                            self.initial_balance = 50000.0  # ä»˜è´¹ç‰ˆé»˜è®¤5ä¸‡ç¾å…ƒ
                        self.virtual_balance = self.initial_balance
                    except:
                        self.initial_balance = 50000.0
                        self.virtual_balance = 50000.0
                        print("âš ï¸ æ— æ³•è·å–è´¦æˆ·ä½™é¢ï¼Œä½¿ç”¨ä»˜è´¹ç‰ˆé»˜è®¤èµ„é‡‘$50,000")
                
            # æŠ•èµ„å‘¨æœŸè®¾ç½®
            if self.interval_mode == 1:  # è‡ªåŠ¨æ¨¡å¼
                # ä»˜è´¹ç‰ˆï¼šé»˜è®¤æ¯æ—¥
                self.interval_min = 1440  # 1å¤©
                self.interval_desc = "æ¯æ—¥å®šæŠ• (ä»˜è´¹ç‰ˆé»˜è®¤)"
            elif self.interval_mode == 2:  # æ¯æ—¥
                self.interval_min = 1440
                self.interval_desc = "æ¯æ—¥å®šæŠ•"
            elif self.interval_mode == 3:  # æ¯å‘¨
                self.interval_min = 10080
                self.interval_desc = "æ¯å‘¨å®šæŠ•"
            elif self.interval_mode == 4:  # è‡ªå®šä¹‰
                self.interval_min = self.custom_interval_min
                self.interval_desc = f"è‡ªå®šä¹‰å‘¨æœŸ ({self.interval_min}åˆ†é’Ÿ)"
            
            print(f"ğŸ’° èµ„é‡‘è®¾ç½®: ${getattr(self, 'virtual_balance', 0):,.0f}")
            print(f"ğŸ“… æŠ•èµ„å‘¨æœŸ: {self.interval_desc}")
            
        except Exception as e:
            import traceback
            print(f"âŒ ä»˜è´¹ç‰ˆåŠŸèƒ½è®¾ç½®å¤±è´¥: {str(e)}")
            print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
            # å›é€€åˆ°é»˜è®¤è®¾ç½®
            self.interval_min = 1440
            self.interval_desc = f"æ¯æ—¥å®šæŠ• (é»˜è®¤) - å¼‚å¸¸å›é€€"
            if not hasattr(self, 'virtual_balance') or self.virtual_balance is None:
                self.virtual_balance = 50000.0
                self.initial_balance = 50000.0
            print(f"ğŸ”§ å¼‚å¸¸å›é€€è®¾ç½®å®Œæˆ: interval_min={self.interval_min}, virtual_balance=${self.virtual_balance}")

    def print_initialization_status(self):
        """æ‰“å°è¯¦ç»†çš„åˆå§‹åŒ–çŠ¶æ€ - ä»˜è´¹ç‰ˆ"""
        print(f"\\nğŸ” åˆå§‹åŒ–çŠ¶æ€è¯¦æƒ… - {self._version}")
        print("=" * 50)
        print(f"ğŸ“Š ç‰ˆæœ¬ä¿¡æ¯: {self._tier}")
        print(f"ğŸ“ˆ äº¤æ˜“æ ‡çš„: {getattr(self, 'stock', 'Unknown')}")
        print(f"ğŸ›ï¸ ç‰ˆæœ¬å±‚çº§: {getattr(self, 'version_tier', 'Unknown')}")
        print(f"ğŸ’° è™šæ‹Ÿä½™é¢: ${getattr(self, 'virtual_balance', 0):,.2f}")
        print(f"ğŸ“… æŠ•èµ„å‘¨æœŸ: {getattr(self, 'interval_min', 0)}åˆ†é’Ÿ")
        print(f"ğŸ“¦ å®šæŠ•æ•°é‡: {getattr(self, 'qty', 0)}è‚¡")
        print(f"ğŸ”§ å›æµ‹æ¨¡å¼: {getattr(self, 'backtest', False)}")
        print(f"âš™ï¸ é—´éš”æ¨¡å¼: {getattr(self, 'interval_mode', 0)}")
        print(f"ğŸ’µ èµ„é‡‘æ¨¡å¼: {getattr(self, 'balance_mode', 0)}")
        
        # æ£€æŸ¥å…³é”®å±æ€§
        critical_attrs = ['interval_min', 'virtual_balance', 'qty', 'version_tier']
        missing_attrs = []
        for attr in critical_attrs:
            if not hasattr(self, attr) or getattr(self, attr) is None:
                missing_attrs.append(attr)
        
        if missing_attrs:
            print(f"âš ï¸ ç¼ºå¤±å±æ€§: {missing_attrs}")
        else:
            print(f"âœ… æ‰€æœ‰å…³é”®å±æ€§å·²åˆå§‹åŒ–")
        print("=" * 50)

    def print_welcome(self):
        """æ‰“å°æ¬¢è¿ä¿¡æ¯ - ä»˜è´¹ç‰ˆ"""
        print("\\n" + "=" * 60)
        print(f"ğŸ’ DCAæ™ºèƒ½å®šæŠ•ç­–ç•¥ {self._version}")
        print("=" * 60)
        print(f"ğŸ“Š å½“å‰ç‰ˆæœ¬: ä»˜è´¹ä¸“ä¸šç‰ˆ (Â¥35/æœˆ)")
        print(f"âœ¨ æ ¸å¿ƒåŠŸèƒ½: 3å±‚æ™ºèƒ½åŠ ä»“ç³»ç»Ÿ")
        
        print("\\nğŸ’ ä»˜è´¹ç‰ˆåŠŸèƒ½ (Â¥35/æœˆ):")
        print("   âœ… åŒ…å«å…è´¹ç‰ˆæ‰€æœ‰åŠŸèƒ½")
        print("   âœ… 3å±‚æ™ºèƒ½åŠ ä»“ (5%/10%/20%)")
        print("   âœ… åŠ¨æ€å€æ•°è°ƒæ•´ (1.5x/2x/3x)")
        print("   âœ… ä¸ªæ€§åŒ–å‚æ•°é…ç½®")
        print("   âœ… æç«¯å›æ’¤ä¿æŠ¤")
        print("   âœ… è‡ªå®šä¹‰èµ„é‡‘å’ŒæŠ•èµ„å‘¨æœŸ")
        print("   âœ… ä¸“å±æŠ€æœ¯æ”¯æŒ")
        
        print("\\nğŸ¯ å½“å‰é…ç½®:")
        print(f"   ç‰ˆæœ¬ç­‰çº§: {getattr(self, 'version_tier', 2)} (ä»˜è´¹ç‰ˆ)")
        print(f"   æŠ•èµ„æ¨¡æ¿: {getattr(self, 'preset_name', 'å¹³è¡¡å‹')} ({getattr(self, 'preset_desc', 'ä¸­ç­‰é£é™©æ”¶ç›Šï¼Œé€‚åˆå¤§å¤šæ•°ç”¨æˆ·')})")
        print(f"   é£é™©ç­‰çº§: {getattr(self, 'risk_level', 'ä¸­')}")
        print(f"   å®šæŠ•æ•°é‡: {getattr(self, 'qty', 20)}è‚¡")
        print(f"   æŠ•èµ„å‘¨æœŸ: {getattr(self, 'interval_desc', 'æ¯æ—¥å®šæŠ•')}")
        print(f"   åˆå§‹èµ„é‡‘: ${getattr(self, 'virtual_balance', 50000):,.0f}")
        print(f"   èµ„é‡‘æ¨¡å¼: {'è‡ªå®šä¹‰èµ„é‡‘' if getattr(self, 'balance_mode', 1) == 2 else 'ç³»ç»Ÿé»˜è®¤èµ„é‡‘'}")
        print(f"   å›æ’¤é˜ˆå€¼: {getattr(self, 'drawdown_layers', [5.0, 10.0, 20.0])}")
        print(f"   è¿è¡Œæ¨¡å¼: {'å›æµ‹' if getattr(self, 'backtest', True) else 'å®ç›˜'}")
        
        print("\\nğŸš€ ä»˜è´¹ç‰ˆä¼˜åŠ¿:")
        print("   ğŸ’° éªŒè¯æ”¶ç›Šä¼˜åŠ¿ï¼šæ¯æ—¥å®šæŠ•æ¯”æ¯å‘¨å®šæŠ•æ”¶ç›Šæå‡3-8%")
        print("   ğŸ›¡ï¸ æ™ºèƒ½é£é™©æ§åˆ¶ï¼š3å±‚åŠ ä»“ç³»ç»Ÿï¼Œç†Šå¸‚æœŸé—´è‡ªåŠ¨ä¿æŠ¤")
        print("   ğŸ¨ å®Œå…¨è‡ªå®šä¹‰åŒ–ï¼šèµ„é‡‘ã€å‘¨æœŸã€é¢„è®¾æ¨¡æ¿ä»»æ„é…ç½®")
        print("   ğŸ”§ ä¸“ä¸šæŠ€æœ¯æ”¯æŒï¼šä¼˜å…ˆå®¢æœå“åº”å’Œç­–ç•¥ä¼˜åŒ–å»ºè®®")
        print("=" * 60)

    def handle_data(self):
        """ç­–ç•¥ä¸»é€»è¾‘ - ä»˜è´¹ç‰ˆå®Œæ•´åŠŸèƒ½"""
        try:
            current_time = device_time(TimeZone.DEVICE_TIME_ZONE)
            latest_price, highest_price_today, account_balance = self.get_market_data()
            
            # æ›´æ–°ä»·æ ¼è¿½è¸ª
            self.update_price_tracking(latest_price, highest_price_today)
            
            # è®¡ç®—å½“å‰å›æ’¤
            drawdown = self.calculate_drawdown(latest_price)
            
            # æ‰§è¡Œä»˜è´¹ç‰ˆç­–ç•¥é€»è¾‘
            self.premium_version_logic(current_time, latest_price, account_balance, drawdown)
            
        except Exception as e:
            print(f"âŒ ç­–ç•¥æ‰§è¡Œå¤±è´¥: {str(e)}")

    def get_market_data(self):
        """è·å–å¸‚åœºæ•°æ®"""
        if self.backtest:
            # å›æµ‹æ¨¡å¼
            try:
                latest_price = current_price(self.stock, price_type=THType.FTH)
                if latest_price is None or latest_price <= 0:
                    latest_price = self.last_valid_price
                else:
                    self.last_valid_price = latest_price
                
                # å›æµ‹æ¨¡å¼ä½¿ç”¨è™šæ‹Ÿä½™é¢
                return latest_price, latest_price, self.virtual_balance
            except Exception as e:
                print(f"å›æµ‹æ•°æ®è·å–é”™è¯¯: {str(e)}")
                # è¿”å›é»˜è®¤å€¼é¿å…ç­–ç•¥å´©æºƒ
                default_balance = getattr(self, 'virtual_balance', 50000.0) or 50000.0
                return self.last_valid_price, self.last_valid_price, default_balance
        else:
            # å®ç›˜æ¨¡å¼
            latest_price = current_price(self.stock, price_type=THType.FTH)
            account_balance = total_cash(currency=Currency.USD)
            
            if latest_price is None or latest_price <= 0:
                latest_price = self.last_valid_price
            else:
                self.last_valid_price = latest_price
                
            return latest_price, latest_price, account_balance

    def update_price_tracking(self, latest_price, highest_price_today):
        """æ›´æ–°ä»·æ ¼è¿½è¸ª"""
        if self.strategy_start_price is None:
            self.strategy_start_price = latest_price
            
        if self.highest_price is None or latest_price > self.highest_price:
            self.highest_price = latest_price
            self.high_queue.append(latest_price)
            
        # ä»·æ ¼ä¸Šæ¶¨è¶…è¿‡é˜ˆå€¼æ—¶é‡ç½®å›æ’¤å±‚çº§
        if self.highest_price and latest_price / self.highest_price > (1 + self.drawdown_reset_threshold):
            if self.current_drawdown_layer >= 0:
                print(f"ğŸ“ˆ ä»·æ ¼å›å‡{(latest_price/self.highest_price-1)*100:.1f}%ï¼Œé‡ç½®å›æ’¤å±‚çº§")
                self.current_drawdown_layer = -1

    def calculate_drawdown(self, current_price):
        """è®¡ç®—å½“å‰å›æ’¤ç™¾åˆ†æ¯”"""
        if self.highest_price and self.highest_price > 0:
            return ((self.highest_price - current_price) / self.highest_price) * 100
        return 0.0

    def calculate_add_position_qty(self, drawdown):
        """è®¡ç®—åŠ ä»“æ•°é‡ - ä»˜è´¹ç‰ˆ3å±‚æ™ºèƒ½åŠ ä»“"""
        for i, threshold in enumerate(self.drawdown_layers):
            if drawdown >= threshold:
                # æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨è¿™ä¸ªå±‚çº§æˆ–æ›´é«˜å±‚çº§åŠ è¿‡ä»“
                if i <= self.current_drawdown_layer:
                    continue
                    
                # è§¦å‘æ–°çš„åŠ ä»“å±‚çº§
                self.current_drawdown_layer = i
                add_qty = int(self.qty * self.drawdown_multipliers[i])
                
                print(f"ğŸ’ æ™ºèƒ½åŠ ä»“è§¦å‘: ç¬¬{i+1}å±‚ ({threshold}%), å€æ•°={self.drawdown_multipliers[i]}x, æ•°é‡={add_qty}è‚¡")
                return add_qty
        
        return 0

    def should_invest(self, current_time):
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥å®šæŠ•"""
        if self.last_investment_time is None:
            return True
        elapsed = (current_time - self.last_investment_time).total_seconds() / 60
        
        # å¥å£®æ€§æ£€æŸ¥ï¼šå¦‚æœinterval_minä¸å­˜åœ¨ï¼Œä½¿ç”¨ä»˜è´¹ç‰ˆé»˜è®¤å€¼
        if not hasattr(self, 'interval_min') or self.interval_min is None:
            self.interval_min = 1440  # ä»˜è´¹ç‰ˆé»˜è®¤æ¯æ—¥
            print(f"âš ï¸ interval_minç¼ºå¤±ï¼Œè®¾ç½®ä»˜è´¹ç‰ˆé»˜è®¤å€¼: {self.interval_min}åˆ†é’Ÿ")
        
        return elapsed >= self.interval_min

    def premium_version_logic(self, current_time, latest_price, account_balance, drawdown):
        """ä»˜è´¹ç‰ˆç­–ç•¥é€»è¾‘ - æ™ºèƒ½3å±‚åŠ ä»“ç³»ç»Ÿ"""
        
        # æç«¯å›æ’¤ä¿æŠ¤
        if drawdown >= self.extreme_drawdown_pct:
            print(f"ğŸš¨ æç«¯å›æ’¤ä¿æŠ¤: {drawdown:.1f}% >= {self.extreme_drawdown_pct}%ï¼Œä»…å®šæŠ•æ¨¡å¼")
            if self.should_invest(current_time):
                self.execute_investment(latest_price, account_balance, self.qty, "æç«¯å›æ’¤ä¿æŠ¤")
            return

        # çº¯å®šæŠ•æ¨¡å¼æ£€æŸ¥
        basic_only = bool(getattr(self, 'basic_invest_only', False))
        if basic_only:
            if self.should_invest(current_time):
                self.execute_investment(latest_price, account_balance, self.qty, "çº¯å®šæŠ•æ¨¡å¼")
            return

        # æ™ºèƒ½3å±‚åŠ ä»“ç³»ç»Ÿ
        add_qty = self.calculate_add_position_qty(drawdown)
        if add_qty > 0:
            self.execute_investment(latest_price, account_balance, add_qty, f"ä»˜è´¹ç‰ˆ-ç¬¬{self.current_drawdown_layer+1}å±‚åŠ ä»“")
            return

        # å¸¸è§„å®šæŠ•
        if self.should_invest(current_time):
            self.execute_investment(latest_price, account_balance, self.qty, "ä»˜è´¹ç‰ˆ-å®šæœŸå®šæŠ•")

    def execute_investment(self, latest_price, account_balance, quantity, trade_type="å®šæŠ•"):
        """æ‰§è¡ŒæŠ•èµ„ - ä»˜è´¹ç‰ˆå¢å¼ºåŠŸèƒ½"""
        
        # è°ƒè¯•æ—¥å¿—
        print(f"ğŸ”§ æŠ•èµ„æ‰§è¡Œè°ƒè¯•: price={latest_price}, balance={account_balance}, qty={quantity}, type={trade_type}")
        print(f"ğŸ”§ å½“å‰çŠ¶æ€: version_tier={getattr(self, 'version_tier', 'None')}, virtual_balance={getattr(self, 'virtual_balance', 'None')}")
        
        # ä»˜è´¹ç‰ˆï¼šæ”¯æŒæ›´çµæ´»çš„æ•°é‡ï¼Œä»…æ£€æŸ¥åŸºæœ¬èŒƒå›´
        if quantity < 1 or quantity > 1000:
            print(f"âš ï¸ ä»˜è´¹ç‰ˆå‚æ•°ä¿®æ­£: æŠ•èµ„æ•°é‡ {quantity} -> {self.qty}è‚¡")
            quantity = self.qty

        if self.backtest:
            # å›æµ‹æ¨¡å¼ - ä½¿ç”¨place_marketäº§ç”ŸGUIäº¤æ˜“æ‰“ç‚¹
            required_cash = quantity * latest_price
            
            # ç¡®ä¿virtual_balanceä¸ä¸ºNone
            if self.virtual_balance is None:
                self.virtual_balance = 50000.0
                print(f"âš ï¸ è™šæ‹Ÿä½™é¢ä¸ºNoneï¼Œè®¾ç½®ä»˜è´¹ç‰ˆé»˜è®¤å€¼${self.virtual_balance:,.0f}")
            
            if required_cash > self.virtual_balance:
                # èµ„é‡‘ä¸è¶³ï¼Œè‡ªåŠ¨è°ƒæ•´æŠ•èµ„æ•°é‡
                original_qty = quantity
                quantity = int(self.virtual_balance / latest_price)
                if quantity < 1:
                    print(f"âš ï¸ èµ„é‡‘ä¸è¶³æ— æ³•æŠ•èµ„ï¼šéœ€è¦${required_cash:.2f}ï¼Œä½™é¢${self.virtual_balance:.2f}")
                    return
                print(f"ğŸ“‰ èµ„é‡‘ä¸è¶³ï¼Œè°ƒæ•´æŠ•èµ„æ•°é‡: {original_qty} -> {quantity}è‚¡")
                required_cash = quantity * latest_price
            
            # æ¨¡æ‹Ÿä¸‹å•
            order_id = place_market(self.stock, OrderSide.BUY, quantity, TimeInForce.DAY)
            
            # æ›´æ–°è™šæ‹Ÿä½™é¢
            self.virtual_balance -= required_cash
            self._position += quantity
            self._total_cost += required_cash
            
            print(f"ğŸ’ {trade_type}: {quantity}è‚¡ @ ${latest_price:.2f} | è®¢å•:{order_id}")
            print(f"ğŸ’° ä½™é¢: ${self.virtual_balance:.2f} | æŒä»“: {self._position}è‚¡")
            
        else:
            # å®ç›˜æ¨¡å¼
            if account_balance < quantity * latest_price:
                print(f"âš ï¸ è´¦æˆ·èµ„é‡‘ä¸è¶³: éœ€è¦${quantity * latest_price:.2f}ï¼Œä½™é¢${account_balance:.2f}")
                return
                
            order_id = place_market(self.stock, OrderSide.BUY, quantity, TimeInForce.DAY)
            print(f"ğŸ’ å®ç›˜{trade_type}: {quantity}è‚¡ @ ${latest_price:.2f} | è®¢å•:{order_id}")
        
        # æ›´æ–°æœ€åæŠ•èµ„æ—¶é—´
        self.last_investment_time = device_time(TimeZone.DEVICE_TIME_ZONE)